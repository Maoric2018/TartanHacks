<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>NEON PHASES</title><style>*{margin:0;padding:0}body{background:#000;overflow:hidden}canvas{display:block;cursor:crosshair}</style></head><body><canvas id="c"></canvas><script>"use strict";var e,l;e="center",l="middle",(()=>{function t(e,l){return e+Math.random()*(l-e)}function r(e,l){return e+Math.random()*(l-e+1)|0}function a(){return Math.random()*Math.PI*2}function i(e){return e[Math.random()*e.length|0]}var o=Math.PI,s=2*o,{cos:n,sin:f,sqrt:d,abs:y,min:c,max:h,atan2:p,floor:x}=Math;function g(e,l,t){return e<l?l:e>t?t:e}function m(e,l,t){return e+(l-e)*t}function v(e,l,t,r){return d((e-t)**2+(l-r)**2)}function u(e,l,t,r,a,i){let o=a-t,s=i-r,n=o*o+s*s;if(n<=1e-6)return v(e,l,t,r);let f=g(((e-t)*o+(l-r)*s)/n,0,1);return v(e,l,t+o*f,r+s*f)}function b(e){for(;e>o;)e-=s;for(;e<-o;)e+=s;return e}function w(e){return"string"==typeof e&&"#0ff"===e.toLowerCase()?"#0cf":e||"#f44"}var T,S,_,A,k,P=document.getElementById("c"),C=P.getContext("2d"),I={x:0,y:0};function R(){k=devicePixelRatio||1,T=innerWidth,S=innerHeight,P.width=T*k,P.height=S*k,P.style.width=T+"px",P.style.height=S+"px",C.setTransform(k,0,0,k,0,0),_=T/2,A=S/2}addEventListener("resize",R),R();var F=new Set,D=_,M=A,E=null,B=0,L=0;function H(e){return F.has(e)}function W(){return{x:D-_+I.x,y:M-A+I.y}}addEventListener("keyup",e=>F.delete(e.code)),addEventListener("mousemove",e=>{D=e.clientX,M=e.clientY}),addEventListener("mousedown",e=>{0===e.button&&(B=1),2===e.button&&(L=1),E={x:e.clientX,y:e.clientY,btn:e.button}}),addEventListener("mouseup",e=>{0===e.button&&(B=0),2===e.button&&(L=0)}),addEventListener("contextmenu",e=>e.preventDefault());var N="title",O={time:0,difficulty:.8,wave:0,waveKills:0,waveQuota:0,waveState:"spawning",wavePhaseIdx:-1,bossEntity:null,xp:0,level:1,xpToNext:160,levelUpQueue:0,totalKills:0,frozen:0,freezeTimer:0,bannerTimer:0,bannerText:"",bannerColor:"#fff",gravity:0,windX:0,windY:0,pulseTimer:0,pulseSpeed:0,reversed:0,reverseTimer:0,reverseCD:0,pierce:0,echo:0,weapons:[],passives:{},killFlash:0,waveBannerTimer:0,waveBannerText:"",waveBannerSub:"",waveModTimer:0,waveModText:"",_bossLaserHitCD:0,_bossModQueue:[],_bossSpawnPending:0,gameOverFade:0},U={speed:[["moveSpeed","mul",[1,1.15,1.3,1.4]],["dodgeChance","set",[0,0,0,.08]]],regen:[["regenInterval","set",[999,14,8,8]]],cooldown:[["cdReduction","set",[0,.12,.2,.25]]],damage:[["dmgMult","mul",[1,1.3,1.5]]]};function X(e,l,t){void 0!==t&&("mul"===l?Y[e]*=t:"mul1"===l?Y[e]*=1+t:"add"===l?Y[e]+=t:Y[e]="add_cap"===l?c(.5,Y[e]+t):t)}var Y={moveSpeed:240,critChance:0,critMult:2,xpMult:1,cdReduction:0,regenTimer:0,regenInterval:999,dodgeChance:0,dmgMult:1};function V(){Y.moveSpeed=240,Y.critChance=0,Y.critMult=2,Y.xpMult=1,Y.cdReduction=0,Y.regenInterval=999,Y.dodgeChance=0,Y.dmgMult=1;let e=O.passives;for(let l in U){let t=0|e[l];if(!t)continue;let r=U[l];for(let e=0;e<r.length;e++){let l=r[e],a=l[2];X(l[0],l[1],a[c(t,a.length-1)])}}let l=0|e._speedLoop,t=0|e._damageLoop;l&&(Y.moveSpeed*=1+.15*l),t&&(Y.dmgMult*=1+.3*t)}var z=0,K=0,q=0,G=0,Q=1;function $(e){q=h(q,e)}function j(e,l){G=e,Q=l}function J(e,l,t,r,a){a=a||3,C.save();for(let i=a;i>0;i--)C.beginPath(),C.arc(e,l,t+2.5*i,0,s),C.strokeStyle=r,C.lineWidth=2*i,C.globalAlpha=.07,C.stroke();C.beginPath(),C.arc(e,l,t,0,s),C.strokeStyle=r,C.lineWidth=1.5,C.globalAlpha=1,C.stroke(),C.restore()}function Z(e,l,t,r){C.save(),C.beginPath(),C.arc(e,l,t+4,0,s),C.fillStyle=r,C.globalAlpha=.12,C.fill(),C.beginPath(),C.arc(e,l,t,0,s),C.fillStyle=r,C.globalAlpha=.9,C.fill(),C.restore()}function ee(e,l,t,r){function a(){C.beginPath(),C.moveTo(e[0].x,e[0].y);for(let l=1;l<e.length;l++)C.lineTo(e[l].x,e[l].y);t&&C.closePath()}t=0!=t,r=r||3,C.save();for(let e=r;e>0;e--)a(),C.strokeStyle=l,C.lineWidth=2.5*e,C.globalAlpha=.07,C.stroke();a(),C.strokeStyle=l,C.lineWidth=1.5,C.globalAlpha=1,C.stroke(),C.restore()}function le(e,l,t,r){let a=[];for(let i=0;i<3;i++){let d=r+s/3*i-o/2;a.push({x:e+n(d)*t,y:l+f(d)*t})}return a}function te(e,l,t,r){let a=[];for(let i=0;i<4;i++){let d=r+s/4*i+o/4;a.push({x:e+n(d)*t,y:l+f(d)*t})}return a}function re(e,l,t,r,a,i,o){C.save(),C.font="bold "+r+"px monospace",C.textAlign=i||"left",C.textBaseline=o||"top",C.shadowColor=a,C.shadowBlur=10,C.fillStyle=a,C.globalAlpha=.5,C.fillText(e,l,t),C.shadowBlur=0,C.globalAlpha=1,C.fillText(e,l,t),C.restore()}function ae(e,l,t,r,a,i){C.beginPath(),C.arc(e,l,t,0,s),C.strokeStyle=r,C.lineWidth=a||1,void 0!==i&&(C.globalAlpha=i),C.stroke()}function ie(e,l,t,r,a,i,o,s){C.save(),void 0!==s&&(C.globalAlpha=s),a&&(C.fillStyle=a,C.fillRect(e,l,t,r)),i&&(C.strokeStyle=i,C.lineWidth=o||1,C.strokeRect(e,l,t,r)),C.restore()}function oe(e,l){let t=[];for(let r=0;r<e;r++){let e=l();e.active=0,t.push(e)}return t.spawn=e=>{for(let l=0;l<t.length;l++)if(!t[l].active)return t[l].active=1,e(t[l]),t[l];let l=0,r=1/0;for(let e=0;e<t.length;e++)t[e].spawnTime<r&&(r=t[e].spawnTime,l=e);return t[l].active=1,e(t[l]),t[l]},t.each=e=>{for(let l=0;l<t.length;l++)t[l].active&&e(t[l])},t.count=()=>{let e=0;for(let l=0;l<t.length;l++)t[l].active&&e++;return e},t.clear=()=>{for(let e=0;e<t.length;e++)t[e].active=0},t}function se(){return{active:0,x:0,y:0,vx:0,vy:0,r:4,life:0,maxLife:3,type:"normal",color:"#f44",spawnTime:0,damage:1,curve:0,pulseAmp:0,pulseFreq:0,split:0,echoed:0,echoTimer:0,baseSpeed:0,pierce:0,src:null,loopAmp:0,loopFreq:0,loopBaseAng:0,bossHomingTurn:0,bossHomingStop:0}}var ne=oe(900,se),fe=oe(150,se),de=oe(500,()=>({active:0,x:0,y:0,vx:0,vy:0,life:0,maxLife:.4,color:"#fff",r:2,spawnTime:0})),ye=oe(50,()=>({active:0,x:0,y:0,vx:0,vy:0,r:14,hp:2,maxHp:2,shape:"circle",color:"#f44",moveType:"drifter",firePattern:"single",fireTimer:0,fireCD:2,tier:"small",angle:0,hitFlash:0,spiralAngle:0,moveParams:{},fireParams:{},spawnTime:0,cc:{stunT:0,silenceT:0,rootT:0,slowAmt:0,slowT:0,fearT:0,markT:0,markAmp:0,kbVx:0,kbVy:0,disorientT:0,bleedDmg:0,bleedT:0},isBoss:0,bossAI:null,shieldHP:0})),ce=[];function he(e,l,t,r){ce.length>200||ce.push({x:e+20*(Math.random()-.5),y:l,vy:-60-30*Math.random(),text:r?t+"!":""+t,color:r?"#ff0":"#fff",life:.6,maxLife:.6,scale:r?1.4:1})}function pe(e,l,t,r,a,i,o){de.spawn(s=>{s.x=e,s.y=l,s.vx=t,s.vy=r,s.color=a,s.life=i||.4,s.maxLife=i||.4,s.r=o||2,s.spawnTime=O.time})}function xe(e,l,t,r,a){for(let i=0;i<r;i++){let r=Math.random()*s,i=a*(.3+.7*Math.random());pe(e,l,n(r)*i,f(r)*i,t,.2+.3*Math.random(),1+2*Math.random())}}function ge(e){de.each(l=>{l.x+=l.vx*e,l.y+=l.vy*e,l.vx*=.97,l.vy*=.97,l.life-=e,l.life<=0&&(l.active=0)})}function me(){de.each(e=>{let l=g(e.life/e.maxLife,0,1);C.save(),C.globalAlpha=.8*l,C.beginPath(),C.arc(e.x,e.y,e.r*l,0,s),C.fillStyle=e.color,C.fill(),C.restore()})}var ve=[];function ue(e,l,t,r,a,i,o,s){let n=a*(s?1+.35*i:.8+.4*i),f=h(s?4:3,a*(s?.45:.3)*(s?.85+.25*i:.8+.3*i)),d=h(s?2.5:2,a*(s?.2:.12));C.save(),C.lineCap="round";let y=C.createLinearGradient(e,l,t,r);y.addColorStop(0,"rgba(255,255,255,0)"),y.addColorStop(.08,"rgba(255,216,74,"+(.12+.14*i)+")"),y.addColorStop(1,s?"rgba(255,120,120,"+(.1+.22*i)+")":"rgba(255,216,74,"+(.08+.2*i)+")"),C.beginPath(),C.moveTo(e,l),C.lineTo(t,r),C.strokeStyle=y,C.lineWidth=n,C.globalAlpha=1,C.shadowColor=o,C.shadowBlur=s?18:20,C.stroke();let c=C.createLinearGradient(e,l,t,r);c.addColorStop(0,"rgba(255,255,255,0)"),c.addColorStop(s?.1:.08,"rgba(255,255,255,"+(s?.15+.2*i:.16+.2*i)+")"),c.addColorStop(1,s?"rgba(255,180,180,"+(.2+.38*i)+")":"rgba(255,216,74,"+(.2+.4*i)+")"),C.beginPath(),C.moveTo(e,l),C.lineTo(t,r),C.strokeStyle=c,C.lineWidth=f,C.shadowBlur=s?10:12,C.stroke();let p=C.createLinearGradient(e,l,t,r);p.addColorStop(0,"rgba(255,255,255,0)"),p.addColorStop(s?.12:.1,"rgba(255,255,255,"+(.25+.25*i)+")"),p.addColorStop(1,"rgba(255,255,255,"+(s?.3+.4*i:.35+.45*i)+")"),C.beginPath(),C.moveTo(e,l),C.lineTo(t,r),C.strokeStyle=p,C.lineWidth=d,C.shadowBlur=s?6:8,C.stroke(),C.restore()}function be(e,l,t,r,i,o,s,d,y){if(ve.length>=18)return;let c=r||0,p=i||1,x=o||1,v=s||1,b=-f(t),w=n(t),_=Be.x+16*n(t)+b*c,A=Be.y+16*f(t)+w*c,k=1.9*h(T,S)*v,P=m(4,26,l)*x,C=m(1.2,11,l)*p,I=g(0|e.lv.a,0,2);k*=1+.08*I,P*=1+.08*I,C*=1+.07*I;let R=_+n(t)*k,F=A+f(t)*k;ye.each(l=>{if(l.active&&(!y||l.isBoss)&&u(l.x,l.y,_,A,R,F)<=.5*P+l.r&&(Wl(l,C),"bow"===e.id)){let t=g(0|e.lv.c,0,2);t>0&&(l.cc.bleedDmg=h(l.cc.bleedDmg,[0,1.2,2.2][t]),l.cc.bleedT=h(l.cc.bleedT,[0,1.5,2.5][t]))}}),ne.each(e=>{e.active&&u(e.x,e.y,_,A,R,F)<=.55*P+e.r&&(e.active=0,xe(e.x,e.y,"#ff0",2,70))});for(let e=0;e<6;e++){let l=.15+.15*e;xe(m(_,R,l),m(A,F,l),"#ff0",2,60)}ve.push({x1:_,y1:A,x2:R,y2:F,width:P,length:k,life:.12+.1*l,maxLife:.12+.1*l,color:d||"#ff0",phase:a(),hot:0})}var we=[];function Te(e){we.push({owner:e.owner||null,x1:e.x1||0,y1:e.y1||0,angle:e.angle||0,length:e.length||800,width:e.width||20,rotSpeed:e.rotSpeed||0,life:e.life||.9,maxLife:e.life||.9,color:w(e.color||"#f66"),offsetX:e.offsetX||0,offsetY:e.offsetY||0,warn:e.warn||0,maxWarn:e.warn||0,warnColor:e.warnColor||"#ffcc66"})}var Se=500,_e=new Map,Ae=4294967295*Math.random()>>>0;function ke(e,l){let t=((e,l)=>2097152*(e+1048576)+(l+1048576))(e,l);if(_e.has(t))return _e.get(t);let r=((e,l)=>{let t=(374761393*e+668265263*l^Ae)>>>0;return t=Math.imul(t^t>>>13,1274126177),(t^t>>>16)>>>0})(e,l),a=()=>(r=1103515245*r+12345&2147483647,r/2147483647),i=x(5*a()),o=[],s=e=>{for(let l=0;l<o.length;l++){let t=o[l];if("pillar"===e.type&&"pillar"===t.type){if(v(e.x,e.y,t.x,t.y)<e.r+t.r+12)return 1}else{let l="pillar"===e.type?{x:e.x-e.r,y:e.y-e.r,w:2*e.r,h:2*e.r}:e,r="pillar"===t.type?{x:t.x-t.r,y:t.y-t.r,w:2*t.r,h:2*t.r}:t;if(l.x<l.x+l.w&&r.x<r.x+r.w){let e=l.x<r.x+r.w&&l.x+l.w>r.x,t=l.y<r.y+r.h&&l.y+l.h>r.y;if(e&&t&&!(l.x+l.w+12<r.x||l.x>r.x+r.w+12||l.y+l.h+12<r.y||l.y>r.y+r.h+12))return 1}}}return 0};for(let t=0;t<i;t++){let t=0;for(let r=0;r<10;r++){let r=e*Se+380*a()+60,i=l*Se+380*a()+60,n=a()<.5?{type:"pillar",x:r,y:i,r:18+32*a()}:{type:"wall",x:r-(50+110*a())/2,y:i-(18+45*a())/2,w:50+110*a(),h:18+45*a()};if(!s(n)){o.push(n),t=1;break}}}return _e.set(t,o),o}function Pe(e,l,t,r){let a=e.x-l,i=e.y-t,o=d(a*a+i*i),s=e.r+r;o<s&&o>.01&&(e.x=l+a/o*s,e.y=t+i/o*s)}function Ce(e,l,t,r,a){let i=g(e.x,l,l+r),o=g(e.y,t,t+a),s=e.x-i,n=e.y-o,f=d(s*s+n*n);if(f<e.r&&f>.01)e.x=i+s/f*e.r,e.y=o+n/f*e.r;else if(f<=.01&&e.x>=l&&e.x<=l+r&&e.y>=t&&e.y<=t+a){let i=[e.x-l,l+r-e.x,e.y-t,t+a-e.y],o=i.indexOf(c(...i));0===o?e.x=l-e.r:1===o?e.x=l+r+e.r:e.y=2===o?t-e.r:t+a+e.r}}function Ie(e){let l=x(e.x/Se),t=x(e.y/Se);for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){let i=ke(l+r,t+a);for(let l=0;l<i.length;l++)"pillar"===i[l].type?Pe(e,i[l].x,i[l].y,i[l].r):Ce(e,i[l].x,i[l].y,i[l].w,i[l].h)}}var Re=["#f44","#f84","#fd4","#f6f","#9f6","#f95"],Fe={t:0,enemies:[],bullets:[]};function De(e){(e=e||{}).x=t(0,T),e.y=t(0,S);let l=a(),r=t(35,95);return e.vx=n(l)*r,e.vy=f(l)*r,e.r=t(8,16),e.shape=i(["circle","triangle"]),e.color=i(Re),e.fire=t(.2,1.1),e}function Me(e){let l=p(A-e.y,_-e.x)+t(-.9,.9),r=t(120,220);Fe.bullets.push({x:e.x,y:e.y,vx:n(l)*r,vy:f(l)*r,life:t(1.2,2.6),r:2.4,color:e.color}),Fe.bullets.length>120&&Fe.bullets.splice(0,Fe.bullets.length-120)}function Ee(e,l){(e=>{if(!Fe.enemies.length)for(let e=0;e<10;e++)Fe.enemies.push(De({}));Fe.t+=e;for(let l of Fe.enemies)l.fire-=e,l.x+=l.vx*e,l.y+=l.vy*e,(l.x<-20||l.x>T+20||l.y<-20||l.y>S+20)&&De(l),l.fire<=0&&(Me(l),l.fire=t(.25,1.2));for(let l=Fe.bullets.length-1;l>=0;l--){let t=Fe.bullets[l];t.x+=t.vx*e,t.y+=t.vy*e,t.life-=e,(t.life<=0||t.x<-30||t.y<-30||t.x>T+30||t.y>S+30)&&Fe.bullets.splice(l,1)}})(e||0),C.fillStyle="#02060b",C.fillRect(0,0,T,S);let r=100,a=50,i=30*Fe.t%r,o=16*Fe.t%r,s=46*Fe.t%a,n=26*Fe.t%a;C.save(),C.strokeStyle="#2a5f82",C.lineWidth=.9,C.globalAlpha=.5,C.beginPath();for(let e=-i;e<=T+r;e+=r)C.moveTo(e,0),C.lineTo(e,S);for(let e=-o;e<=S+r;e+=r)C.moveTo(0,e),C.lineTo(T,e);C.stroke(),C.strokeStyle="#18344a",C.lineWidth=.6,C.globalAlpha=.35,C.beginPath();for(let e=-s;e<=T+a;e+=a)C.moveTo(e,0),C.lineTo(e,S);for(let e=-n;e<=S+a;e+=a)C.moveTo(0,e),C.lineTo(T,e);C.stroke(),C.fillStyle="#58b7ff",C.globalAlpha=.14;for(let e=-s;e<=T+a;e+=a)for(let l=-n;l<=S+a;l+=a)C.fillRect(e-1,l-1,2,2);C.restore();for(let e of Fe.bullets)C.save(),C.globalAlpha=.45*g(e.life/2,0,1),Z(e.x,e.y,e.r,e.color),C.restore();for(let e of Fe.enemies)C.save(),C.globalAlpha=.55,"circle"===e.shape?J(e.x,e.y,e.r,e.color,3):ee(le(e.x,e.y,e.r,1.2*Fe.t),e.color,1,3),C.restore();l&&(C.fillStyle="rgba(0,0,0,"+l+")",C.fillRect(0,0,T,S))}var Be={x:0,y:0,r:12,hp:10,maxHp:10,invuln:0,angle:0,hitFlash:0,alive:1,swordIFrame:0},Le=[{name:"GRAVITY",color:"#84f",desc:"Bullets strongly curve toward you",apply(){O.gravity=220},unapply(){O.gravity=0},tick(){}},{name:"DRIFT",color:"#4ff",desc:"Wind pushes everything",apply(){let e=a();O.windX=80*n(e),O.windY=80*f(e)},unapply(){O.windX=0,O.windY=0},tick(e){let l=p(O.windY,O.windX)+.3*e,t=d(O.windX**2+O.windY**2);O.windX=n(l)*t,O.windY=f(l)*t}},{name:"PULSE",color:"#ff0",desc:"Periodic bullet speed bursts",apply(){O.pulseTimer=0,O.pulseSpeed=0},unapply(){O.pulseSpeed=0,O.pulseTimer=0},tick(e){O.pulseTimer+=e,O.pulseTimer>3&&(O.pulseTimer=0,O.pulseSpeed=200,$(5)),O.pulseSpeed>0&&(O.pulseSpeed=h(0,O.pulseSpeed-400*e))}},{name:"ECHO",color:"#0af",desc:"Bullets spawn ghost copies",apply(){O.echo=1},unapply(){O.echo=0},tick(){}}],He=null,We=-1,Ne={drifter(e,l){if(e.x+=e.vx*l,e.y+=e.vy*l,v(e.x,e.y,Be.x,Be.y)>500){let t=p(Be.y-e.y,Be.x-e.x);e.vx+=40*n(t)*l,e.vy+=40*f(t)*l}let t=d(e.vx**2+e.vy**2);t>100&&(e.vx*=100/t,e.vy*=100/t)},chaser(e,l){let t=p(Be.y-e.y,Be.x-e.x),r=e.moveParams.speed||120;e.vx=m(e.vx,n(t)*r,2*l),e.vy=m(e.vy,f(t)*r,2*l),e.x+=e.vx*l,e.y+=e.vy*l},orbiter(e,l){let t=e.moveParams.radius||150;e.moveParams.angle=(e.moveParams.angle||0)+(e.moveParams.speed||1.5)*l,e.x=m(e.x,Be.x+n(e.moveParams.angle)*t,3*l),e.y=m(e.y,Be.y+f(e.moveParams.angle)*t,3*l)},dasher(e,l){let t=e.moveParams;if(t.state||(t.state="wait"),"wait"===t.state){t.waitTime=(t.waitTime||0)+l;let r=p(Be.y-e.y,Be.x-e.x);if(e.x+=20*n(r)*l,e.y+=20*f(r)*l,t.waitTime>1.5){let l=p(Be.y-e.y,Be.x-e.x),r=g(v(e.x,e.y,Be.x,Be.y)+36,120,260);t.state="telegraph",t.dashTx=e.x+n(l)*r,t.dashTy=e.y+f(l)*r,t.teleT=1,t.teleMax=1,e._dashTele={t:1,maxT:1,tx:t.dashTx,ty:t.dashTy}}}else if("telegraph"===t.state)t.teleT-=l,e._dashInvuln=h(e._dashInvuln,.1),e._dashTele&&(e._dashTele.t=t.teleT),t.teleT<=0&&(t.state="dashing",t.dashT=.32,t.dashMax=.32,t.sx=e.x,t.sy=e.y,t.ex=t.dashTx,t.ey=t.dashTy,e._dashTele=null);else{t.dashT-=l;let r=g(1-t.dashT/t.dashMax,0,1),a=1-(1-r)*(1-r);e.x=m(t.sx,t.ex,a),e.y=m(t.sy,t.ey,a),e._dashInvuln=h(e._dashInvuln,.3),t.dashT<=0&&(e.x=t.ex,e.y=t.ey,t.state="wait",t.waitTime=0)}},sentry(e,l){let t=p(Be.y-e.y,Be.x-e.x);e.x+=15*n(t)*l,e.y+=15*f(t)*l,e.angle+=1.5*l},weaver(e,l){let t=e.moveParams;t.t=(t.t||0)+l;let r=p(Be.y-e.y,Be.x-e.x),a=t.speed||100,i=t.freq||2,s=r+o/2,d=80*f(t.t*i);e.x+=(n(r)*a+n(s)*d*i)*l,e.y+=(f(r)*a+f(s)*d*i)*l},stationary(e,l){},bossChase(e,l){let t=p(Be.y-e.y,Be.x-e.x);e.x+=60*n(t)*l,e.y+=60*f(t)*l},converge(e,l){let t=p(Be.y-e.y,Be.x-e.x),r=e.moveParams.speed||150;e.x+=n(t)*r*l,e.y+=f(t)*r*l}},Oe={single(e){let l=p(Be.y-e.y,Be.x-e.x),t=180+10*O.difficulty;Ue(e.x,e.y,n(l)*t,f(l)*t,4,e.color,"normal",3)},triple(e){let l=p(Be.y-e.y,Be.x-e.x),t=170+8*O.difficulty;for(let r=-1;r<=1;r++)Ue(e.x,e.y,n(l+.2*r)*t,f(l+.2*r)*t,3.5,e.color,"normal",2.5)},radial(e){let l=e.fireParams.count||8,t=140+5*O.difficulty,r=e.fireParams.offset||0;for(let a=0;a<l;a++){let i=s/l*a+r;Ue(e.x,e.y,n(i)*t,f(i)*t,3.5,e.color,"normal",3)}e.fireParams.offset=(r+.15)%s},spiral(e){let l=160+6*O.difficulty;e.spiralAngle=(e.spiralAngle||0)+.4,Ue(e.x,e.y,n(e.spiralAngle)*l,f(e.spiralAngle)*l,4,e.color,"curve",3.5,{curve:.4})},ringpop(e){for(let l=0;l<10;l++){let t=s/10*l;Ue(e.x,e.y,200*n(t),200*f(t),3,e.color,"pulse",3,{pulseAmp:.7,pulseFreq:3})}},wave(e){let l=p(Be.y-e.y,Be.x-e.x),t=160+5*O.difficulty,r=l+o/2;for(let a=0;a<5;a++){let i=15*(a-2);Ue(e.x+n(r)*i,e.y+f(r)*i,n(l)*t,f(l)*t,3,e.color,"normal",3)}},bossRadial(e){let l=e.spiralAngle||0;for(let t=0;t<16;t++){let r=s/16*t+l;Xe(e.x,e.y,150*n(r),150*f(r),5,e.color,"normal",4)}e.spiralAngle=(l+.2)%s},bossWall(e){let l=p(Be.y-e.y,Be.x-e.x),t=l+o/2;for(let r=0;r<13;r++){let a=30*(r-6);Xe(e.x+n(t)*a,e.y+f(t)*a,220*n(l),220*f(l),4.2,e.color,"normal",3.2)}}};function Ue(e,l,t,r,a,i,o,s,n){ne.spawn(f=>{f.x=e,f.y=l,f.vx=t,f.vy=r,f.r=a||4,f.color=w(i||"#f44"),f.type=o||"normal",f.life=s||3,f.maxLife=s||3,f.spawnTime=O.time,f.echoed=0,f.echoTimer=0,f.damage=1,f.curve=n&&n.curve||0,f.pulseAmp=n&&n.pulseAmp||0,f.pulseFreq=n&&n.pulseFreq||0,f.split=n&&n.split||0,f.baseSpeed=d(t*t+r*r),f.loopAmp=n&&n.loopAmp||0,f.loopFreq=n&&n.loopFreq||0,f.loopBaseAng=n&&void 0!==n.loopBaseAng?n.loopBaseAng:p(r,t),f.bossFx=n&&n.bossFx||"normal",f.bossFxPower=n&&n.bossFxPower||0,f.bossFxFreq=n&&n.bossFxFreq||0,f.bossFxPhase=n&&n.bossFxPhase||0,f.bossWindX=n&&n.bossWindX||0,f.bossWindY=n&&n.bossWindY||0,f.bossFxSpin=n&&n.bossFxSpin||0,f.bossHomingTurn=n&&n.bossHomingTurn||0,f.bossHomingStop=n&&n.bossHomingStop||0})}function Xe(e,l,t,r,o,s,d,y,c){let h=(()=>{let e=i(["normal","gravity","speed_shift","wind_shift","homing"]);if("gravity"===e)return{bossFx:"gravity",bossFxPower:360+220*Math.random()};if("speed_shift"===e)return{bossFx:"speed_shift",bossFxPower:1.25+.95*Math.random(),bossFxFreq:6+4*Math.random(),bossFxPhase:a()};if("wind_shift"===e){let e=a(),l=260+170*Math.random();return{bossFx:"wind_shift",bossWindX:n(e)*l,bossWindY:f(e)*l,bossFxSpin:.8+1.1*Math.random()}}return"homing"===e?{bossFx:"homing",bossHomingTurn:2.4+1.8*Math.random(),bossHomingStop:150+90*Math.random()}:{bossFx:"normal"}})();if(c)for(let e in c)h[e]=c[e];Ue(e,l,t,r,o,s,d,y,h)}var Ye=["#f44","#f84","#ff4","#4f4","#4ff","#f4f","#84f"],Ve=["circle","square","triangle"],ze=["drifter","chaser","orbiter","dasher","sentry","weaver"],Ke=["single","triple","radial","spiral","ringpop","wave"];function qe(e,l){let o="elite"===(e=e||"small");ye.spawn(s=>{let d=a(),y=h(_,A)+50+t(0,100);s.x=l&&void 0!==l.x?l.x:Be.x+n(d)*y,s.y=l&&void 0!==l.y?l.y:Be.y+f(d)*y,s.shape=l&&l.shape||i(Ve),s.color=w(l&&l.color||i(Ye)),s.moveType=l&&l.moveType||i(ze),s.firePattern=l&&l.firePattern||i(Ke),s.tier=e,s.r=o?22:14;let c=1+.11*O.wave+O.wave*O.wave*.003;if(s.hp=(o?10:3)*c|0,s.maxHp=s.hp,s.fireCD=(o?t(.8,1.5):t(1.5,3))/(1+.08*O.difficulty),l&&l.fireMult&&(s.fireCD/=l.fireMult),s.fireTimer=t(.5,s.fireCD),s.hitFlash=0,s.angle=a(),s.spiralAngle=a(),s.spawnTime=O.time,s._dashTele=null,s._dashInvuln=0,s.moveParams=l&&l.moveParams||{},s.fireParams={},s.isBoss=0,s.bossAI=null,s.shieldHP=0,s.cc={stunT:0,silenceT:0,rootT:0,slowAmt:0,slowT:0,fearT:0,markT:0,markAmp:0,kbVx:0,kbVy:0,disorientT:0,bleedDmg:0,bleedT:0},"drifter"===s.moveType){let e=t(40,80),l=a();s.vx=n(l)*e,s.vy=f(l)*e}else"orbiter"===s.moveType?(s.moveParams.radius=s.moveParams.radius||t(100,200),s.moveParams.speed=s.moveParams.speed||t(1,2.5)*(Math.random()<.5?1:-1),s.moveParams.angle=s.moveParams.angle||a()):"dasher"===s.moveType?(s.moveParams.state="wait",s.moveParams.waitTime=0,s.vx=0,s.vy=0):"weaver"===s.moveType?(s.moveParams.t=0,s.moveParams.speed=s.moveParams.speed||t(60,120),s.moveParams.freq=s.moveParams.freq||t(2,5)):"chaser"===s.moveType?(s.moveParams.speed=s.moveParams.speed||t(80,140),s.vx=0,s.vy=0):"sentry"===s.moveType?(s.vx=t(-20,20),s.vy=t(-20,20)):"converge"===s.moveType&&(s.moveParams.speed=s.moveParams.speed||150);return"radial"===s.firePattern&&(s.fireParams.count=o?r(10,16):r(6,10),s.fireParams.offset=a()),l&&l.hpMult&&(s.hp=s.hp*l.hpMult|0,s.maxHp=s.hp),l&&l.spdMult&&(s.moveParams.speed=(s.moveParams.speed||100)*l.spdMult),s})}function Ge(e,l,t,r){let a=O.time+r,i=g(t,0,1),o=(60+8*f(6*a))*(.8+.25*i);C.save(),C.translate(e,l),C.rotate(1.2*a),C.beginPath(),C.arc(0,0,o+10,0,s),C.strokeStyle="rgba(138,93,255,"+.28*i+")",C.lineWidth=8,C.stroke(),C.beginPath(),C.arc(0,0,o,0,s),C.strokeStyle="rgba(210,170,255,"+.55*i+")",C.lineWidth=3,C.stroke();for(let e=0;e<8;e++){let l=s/8*e+.8*a;C.beginPath(),C.moveTo(.45*n(l)*o,.45*f(l)*o),C.lineTo(n(l)*(o+8),f(l)*(o+8)),C.strokeStyle="rgba(220,190,255,"+.35*i+")",C.lineWidth=1.4,C.stroke()}C.restore()}function Qe(e,l,t){O.frozen&&!t||e.each(e=>{if("curve"===e.type&&e.curve){let t=d(e.vx**2+e.vy**2),r=p(e.vy,e.vx)+e.curve*l;e.vx=n(r)*t,e.vy=f(r)*t}if("loop"===e.type&&e.loopAmp){let l=(O.time-e.spawnTime)*(e.loopFreq||2.6),t=e.loopBaseAng,r=h(80,e.baseSpeed),a=f(l*s)*(e.loopAmp||120),i=n(t),o=f(t),d=-o,y=i;e.vx=i*r+d*a,e.vy=o*r+y*a}if("pulse"===e.type&&e.pulseAmp){let l=1-e.life/e.maxLife,t=e.baseSpeed*(1+f(l*e.pulseFreq*s)*e.pulseAmp),r=p(e.vy,e.vx);e.vx=n(r)*t,e.vy=f(r)*t}if(!t){if("gravity"===e.bossFx){let t=Be.x-e.x,r=Be.y-e.y,a=h(45,d(t*t+r*r)),i=e.bossFxPower||420;e.vx+=t/a*i*l,e.vy+=r/a*i*l}else if("speed_shift"===e.bossFx){let l=e.bossFxPower||1.6,t=e.bossFxFreq||7,r=e.bossFxPhase||0,a=e.baseSpeed*(1+f((O.time+e.spawnTime)*t+r)*l*.45),i=p(e.vy,e.vx);e.vx=n(i)*h(80,a),e.vy=f(i)*h(80,a)}else if("wind_shift"===e.bossFx){let t=e.bossFxSpin||0;if(t){let r=p(e.bossWindY,e.bossWindX)+l*t,a=d(e.bossWindX*e.bossWindX+e.bossWindY*e.bossWindY);e.bossWindX=n(r)*a,e.bossWindY=f(r)*a}e.vx+=e.bossWindX*l,e.vy+=e.bossWindY*l}else if("homing"===e.bossFx){let t=Be.x-e.x,r=Be.y-e.y;if(d(t*t+r*r)>(e.bossHomingStop||180)){let a=p(r,t),i=p(e.vy,e.vx),o=i+g(b(a-i),-(e.bossHomingTurn||3)*l,(e.bossHomingTurn||3)*l),s=h(90,d(e.vx*e.vx+e.vy*e.vy));e.vx=n(o)*s,e.vy=f(o)*s}}if(O.gravity){let t=Be.x-e.x,r=Be.y-e.y,a=h(50,d(t*t+r*r));e.vx+=t/a*O.gravity*l,e.vy+=r/a*O.gravity*l}if(O.pulseSpeed){let t=d(e.vx**2+e.vy**2)+O.pulseSpeed*l,r=p(e.vy,e.vx);e.vx=n(r)*t,e.vy=f(r)*t}O.echo&&!e.echoed&&(e.echoTimer+=l,e.echoTimer>.15&&(e.echoed=1,ne.spawn(l=>{l.x=e.x,l.y=e.y,l.vx=.7*e.vx,l.vy=.7*e.vy,l.r=.7*e.r,l.color=e.color,l.type="normal",l.life=.5*e.life,l.maxLife=l.life,l.spawnTime=O.time,l.echoed=1,l.echoTimer=0,l.curve=0,l.pulseAmp=0,l.split=0,l.damage=1,l.baseSpeed=d(l.vx**2+l.vy**2)}))),e.vx+=O.windX*l*.5,e.vy+=O.windY*l*.5}if(e.x+=e.vx*l,e.y+=e.vy*l,e.life-=l,(e=>{let l=x(e.x/Se),t=x(e.y/Se);for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){let i=ke(l+r,t+a);for(let l=0;l<i.length;l++){let t=i[l];if("pillar"===t.type){if(v(e.x,e.y,t.x,t.y)<e.r+t.r)return t}else{let l=g(e.x,t.x,t.x+t.w),r=g(e.y,t.y,t.y+t.h);if(v(e.x,e.y,l,r)<e.r)return t}}}return null})(e)&&(e.active=0,xe(e.x,e.y,e.color,3,60)),v(e.x,e.y,Be.x,Be.y)>1400&&(e.active=0),e.life<=0&&(e.active=0,e.split&&!t))for(let l=0;l<3;l++){let l=Math.random()*s;Ue(e.x,e.y,100*n(l),100*f(l),2.5,e.color,"normal",1.5)}})}function $e(e){e.each(e=>{let l=g(e.life/e.maxLife,0,1);C.save(),C.globalAlpha=l;let t="rocket"===e.src||"rocket_mini"===e.src?"rocket_mini"===e.src?"#fa0":"#f80":e.color;Z(e.x,e.y,e.r,t),e.bossFx&&"normal"!==e.bossFx&&(C.beginPath(),C.arc(e.x,e.y,e.r+2,0,s),C.strokeStyle="gravity"===e.bossFx?"#f8f":"speed_shift"===e.bossFx?"#ff8":"#8ff",C.lineWidth=1,C.globalAlpha=.4*l,C.stroke()),C.restore()})}var je=(e,l)=>{for(let t in l)e[t]=l[t]},Je={dagger:e=>je(e,{state:"idle",dx:0,dy:0,tx:0,ty:0,speed:800,dmg:4,idleTimer:0,spinTimer:0,spinR:25}),sword:e=>je(e,{swingCD:0,lungeTimer:0,lungeDir:0,lungeDist:120,lungeStartX:0,lungeStartY:0,lungeProg:0}),bow:e=>je(e,{charging:0,chargeTime:0,maxCharge:1.5,shotCD:0}),chain:e=>je(e,{timer:.1,range:200,chains:4,stunDur:.3,dmg:5,_arcTimer:0,_targets:null}),rocket:e=>je(e,{timer:.1,blastR:90,kbForce:250,lastFired:0}),drone:e=>je(e,{timer:.1,_drones:[],droneCount:1,droneRange:150,silenceDur:1.5})};function Ze(e){let l={id:e,lv:{a:0,b:0,c:0,d:0}},t=Je[e];return t&&t(l),l}var el={};for(let e of[["dagger","MAGIC DAGGER","#0ff","starter","Click to throw. Click again to redirect.","",[["a","PIERCING THROW",3,["+50% speed","90% + homing","120% + homing"]],["b","SPECTRAL COPY",3,["1 ghost 50% dmg","2 ghosts 60%","3 ghosts 75%"]],["d","DAGGER STORM",2,["0.8s +75% radius","1.2s +150% radius"]]]],["sword","PLASMA SWORD","#f0f","starter","Click to lunge-slash forward, cleaving enemies and bullets. i-frames during dash.","",[["a","LUNGE REACH",3,["+33% range","+67%","+108%"]],["b","WIDE CLEAVE",3,["+25% size","+50%","+88%"]],["c","EDGE CHARGE",2,["+15% length +2 dmg","+30% length +4 dmg"]]]],["bow","VOLT BOW","#ff0","starter","Hold to charge, release a piercing beam.","",[["a","PRISM SPLIT",2,["1 side pair","2 side pairs"]],["b","QUICK DRAW",3,["1.0s charge","0.8s","0.6s"]],["c","PLASMA BURN",2,["Applies burn","Stronger burn"]]]],["chain","CHAIN LIGHTNING","#a0f","cc","Auto-zaps nearby bullets, chains between targets, and can leave stun fields.","BULLET CLEAR",[["a","EXTRA CHAINS",2,["+3 chains (7)","+3 (10)"]],["b","MULTI STRIKE",2,["2 bolts at once","3 bolts"]],["c","STATIC FIELD",2,["3s lingering stun zone","5s zone + wider"]]]],["rocket","ROCKET LAUNCHER","#f80","cc","Homing rockets explode for knockback and bullet clearing.","KNOCKBACK",[["a","CONCUSSIVE BLAST",3,["+60 knockback","+120 kb","+200 kb"]],["b","CLUSTER BOMB",2,["5 homing mini-rockets","7"]],["c","BLAST RADIUS",2,["+44% radius","+78% radius"]]]],["drone","PULSE DRONE","#0aa","cc","Drone silences enemies, slows bullets.","SILENCE",[["a","EXTRA DRONE",2,["+1 drone","+1 (3 total)"]],["b","EXT SILENCE",2,["2.5s","3.5s"]],["c","DISRUPTION",2,["20% slow","40%"]],["d","OVERDRIVE",2,["0.9s cd","0.7s"]]]]]){let l=[];for(let t=0;t<e[6].length;t++){let r=e[6][t];l.push({id:r[0],name:r[1],maxLv:r[2],desc:r[3]})}let t={name:e[1],color:e[2],type:e[3],desc:e[4],upgrades:l};e[5]&&(t.cc=e[5]),el[e[0]]=t}var ll=["dagger","sword","bow"],tl=["chain","rocket","drone"];function rl(e){let l=null,t=null;for(let e=0;e<O.weapons.length;e++){let r=O.weapons[e];if("starter"===el[r.id].type){if(l){t=r;break}l=r}}return 0===e?l:2===e?t:null}function al(e,l){if("flying"===e.state){let t=[1,1.5,1.9,2.2][e.lv.a],r=p(e.ty-e.dy,e.tx-e.dx),a=e.speed*t*l;v(e.dx,e.dy,e.tx,e.ty)<a+5?(e.dx=e.tx,e.dy=e.ty,e.lv.d>0?(e.state="spinning",e.spinTimer=[0,.8,1.2][e.lv.d],e.spinR=[0,35,50][e.lv.d]):(e.state="waiting",e.idleTimer=0)):(e.dx+=n(r)*a,e.dy+=f(r)*a),il(e,e.dmg)}else if("spinning"===e.state)e.spinTimer-=l,e.angle=(e.angle||0)+15*l,((e,l)=>{ye.each(t=>{t.active&&v(e.dx,e.dy,t.x,t.y)<e.spinR+t.r&&Wl(t,[0,3,4][e.lv.d]*l*10)})})(e,l),e.spinTimer<=0&&(e.state="waiting",e.idleTimer=0);else if("waiting"===e.state)e.idleTimer+=l,e.idleTimer>2&&(e.state="returning");else if("returning"===e.state){let t=p(Be.y-e.dy,Be.x-e.dx),r=1.2*e.speed*l;e.dx+=n(t)*r,e.dy+=f(t)*r,il(e,e.dmg),v(e.dx,e.dy,Be.x,Be.y)<20&&(e.state="idle")}else e.dx=Be.x,e.dy=Be.y;if(e.lv.b>0){let l=[0,1,2,3][e.lv.b];e._ghosts||(e._ghosts=[]),e._posHistory||(e._posHistory=[]),e._posHistory.push({x:e.dx,y:e.dy}),e._posHistory.length>30&&e._posHistory.shift(),e._ghosts=[];for(let t=0;t<l;t++){let l=h(0,e._posHistory.length-1-6*(t+1));e._ghosts.push({x:e._posHistory[l].x,y:e._posHistory[l].y})}}}function il(e,l){if(ye.each(t=>{t.active&&v(e.dx,e.dy,t.x,t.y)<t.r+8&&Wl(t,l)}),e.lv.b>0&&e._ghosts){let t=l*[0,.5,.6,.75][e.lv.b];for(let l of e._ghosts)ye.each(e=>{e.active&&v(l.x,l.y,e.x,e.y)<e.r+8&&Wl(e,t)})}}function ol(e){let l=e.dx||Be.x,t=e.dy||Be.y;if("idle"===e.state){let e=Be.angle,l=Be.x+18*n(e),t=Be.y+18*f(e);ee([{x:l+8*n(e),y:t+8*f(e)},{x:l+5*n(e+2.3),y:t+5*f(e+2.3)},{x:l+5*n(e-2.3),y:t+5*f(e-2.3)}],"#0ff",1,3)}else{let r="spinning"===e.state?e.angle||0:p(e.dy-("returning"===e.state?Be.y:e.ty),e.dx-("returning"===e.state?Be.x:e.tx))+o;if(ee([{x:l+10*n(r),y:t+10*f(r)},{x:l+6*n(r+2.3),y:t+6*f(r+2.3)},{x:l+6*n(r-2.3),y:t+6*f(r-2.3)}],"#0ff",1,4),"spinning"===e.state&&((e,l,t,r,a,i)=>{C.save();for(let r=3;r>0;r--)C.beginPath(),C.arc(e,l,t,0,a),C.strokeStyle=i,C.lineWidth=1+2*r,C.globalAlpha=.06,C.stroke();C.beginPath(),C.arc(e,l,t,0,a),C.strokeStyle=i,C.lineWidth=1,C.globalAlpha=1,C.stroke(),C.restore()})(l,t,e.spinR,0,s,"#0ff"),e.lv.b>0&&e._ghosts&&"idle"!==e.state)for(let l=0;l<e._ghosts.length;l++){let t=e._ghosts[l],r="spinning"===e.state?e.angle||0:p(e.dy-t.y,e.dx-t.x);C.save(),C.globalAlpha=.35-.08*l,ee([{x:t.x+10*n(r),y:t.y+10*f(r)},{x:t.x+6*n(r+2.3),y:t.y+6*f(r+2.3)},{x:t.x+6*n(r-2.3),y:t.y+6*f(r-2.3)}],"#0ff",1,3),C.restore()}}}function sl(e,l){if(e.swingCD=h(0,e.swingCD-l),e.lungeTimer>0){e.lungeTimer-=l;let t=.18;e.lungeProg=g(1-e.lungeTimer/t,0,1);let r=e.lungeDist,a=[35,50,60,75][e.lv.b],i=e.lungeStartX+n(e.lungeDir)*r*e.lungeProg,o=e.lungeStartY+f(e.lungeDir)*r*e.lungeProg;Be.x=i,Be.y=o,Be.invuln=h(Be.invuln,.25),Be.swordIFrame=h(Be.swordIFrame,.25);let s=8+[0,2,4][e.lv.c],d=70*(1+[0,.15,.3][e.lv.c]);ye.each(l=>{if(!l.active)return;let t=l.x-i,r=l.y-o,c=n(e.lungeDir),h=f(e.lungeDir),p=t*c+r*h;p<-15-l.r||p>d+l.r||y(t*-h+r*c)<a+l.r&&(!l._swordHitT||O.time-l._swordHitT>.15)&&(l._swordHitT=O.time,Wl(l,s,0,0),$(2))}),ne.each(l=>{if(!l.active)return;let t=l.x-i,r=l.y-o,s=n(e.lungeDir),c=f(e.lungeDir),h=t*s+r*c;h<-15-l.r||h>d+l.r||y(t*-c+r*s)<a+l.r&&(l.active=0,xe(l.x,l.y,"#f0f",3,80))}),e.lungeTimer<=0&&(e.lungeTimer=0,e.lungeProg=0,xe(Be.x,Be.y,"#f0f",8,120),$(4))}}function nl(e){let l=60*(1+[0,.15,.3][e.lv.c]),t=e.lungeTimer>0?e.lungeDir:Be.angle,r=t+o/2;if(e.lungeTimer>0){let{lungeProg:r,lungeDist:a}=e,i=[35,50,60,75][e.lv.b],s=e.lungeStartX,d=e.lungeStartY,y=.5*(s+(s+n(t)*a*r)),c=.5*(d+(d+f(t)*a*r)),p=h(10,a*r);C.save(),C.translate(y,c),C.rotate(t),C.fillStyle="rgba(255,120,255,.14)",C.fillRect(.5*-p,.45*-i,p,.9*i),C.strokeStyle="rgba(255,170,255,.22)",C.lineWidth=1,C.strokeRect(.5*-p,.45*-i,p,.9*i),C.restore();let x=t+(-o/2+o*r),g=x+o/2,m=Be.x+10*n(x),v=Be.y+10*f(x),u=Be.x+n(x)*(10+l),b=Be.y+f(x)*(10+l);ee([{x:m+4*n(g),y:v+4*f(g)},{x:m-4*n(g),y:v-4*f(g)},{x:u-1.5*n(g),y:b-1.5*f(g)},{x:u+6*n(x),y:b+6*f(x)},{x:u+1.5*n(g),y:b+1.5*f(g)}],"#f0f",1,5)}else{let e=Be.x+14*n(t),a=Be.y+14*f(t),i=Be.x+n(t)*(14+.7*l),o=Be.y+f(t)*(14+.7*l);ee([{x:e+2.5*n(r),y:a+2.5*f(r)},{x:e-2.5*n(r),y:a-2.5*f(r)},{x:i-1*n(r),y:o-1*f(r)},{x:i+4*n(t),y:o+4*f(t)},{x:i+1*n(r),y:o+1*f(r)}],"#f0f",1,2)}}function fl(e,l){e.shotCD=h(0,e.shotCD-l);let t=[1.5,1,.8,.6][e.lv.b];e.maxCharge=t,e.charging&&(e.chargeTime=c(e.chargeTime+l,t))}function dl(e){if(e.charging){let l=g(e.chargeTime/e.maxCharge,0,1),t=18+10*l,r=Be.angle,a=Be.x+n(r)*(t+2),i=Be.y+f(r)*(t+2),s=r+o/2;C.save();let d=a+n(r)*(5+3*l),y=i+f(r)*(5+3*l),c=a+n(s)*(2+1.5*l),h=i+f(s)*(2+1.5*l),p=a-n(s)*(2+1.5*l),x=i-f(s)*(2+1.5*l);C.beginPath(),C.moveTo(d,y),C.lineTo(c,h),C.lineTo(p,x),C.closePath(),C.fillStyle="#ff0",C.globalAlpha=.35+.4*l,C.shadowColor="#ff0",C.shadowBlur=8+10*l,C.fill(),ae(Be.x,Be.y,t,"#ffd84a",1.2+1.2*l,.3+.5*l),ae(Be.x,Be.y,.55*t,"#fff",.9+.9*l,.25+.45*l),C.restore()}}function yl(e,l,t,r){let a=null,i=void 0===t?1/0:t;return ye.each(t=>{if(!t.active)return;if(r&&(r.has?r.has(t):r(t)))return;let o=v(e,l,t.x,t.y);o<i&&(i=o,a=t)}),a}function cl(e,l,t,r,a){let i=null,o=void 0===t?1/0:t;return ne.each(t=>{if(!t.active)return;if(r&&(r.has?r.has(t):r(t)))return;if(a&&(a.has?a.has(t):a(t)))return;let s=v(e,l,t.x,t.y);s<o&&(o=s,i=t)}),i}function hl(e,l){if((e=>{let l=window._staticFields;for(let t=l.length-1;t>=0;t--){let r=l[t];r.life-=e,r.x+=r.vx*e,r.y+=r.vy*e,r.vx*=.95,r.vy*=.95,r.vx+=40*(Math.random()-.5)*e,r.vy+=40*(Math.random()-.5)*e,r.life<=0?l.splice(t,1):(r._checkT=(r._checkT||0)-e,r._checkT>0||(r._checkT=.2,ye.each(e=>{if(e.active&&v(r.x,r.y,e.x,e.y)<e.r+8){if(O.time-(e._lastStaticStun||0)<3)return;let l=e.isBoss?.2:1;e.cc.stunT=h(e.cc.stunT,r.stunDur*l),e._lastStaticStun=O.time}})))}})(l),e.timer-=l*(1-Y.cdReduction),e.timer<=0){let l=e.range,t=e.chains+[0,3,3][e.lv.a],r=[1,2,3][e.lv.b]||1,a=e.lv.c;if(!cl(Be.x,Be.y,l))return;e.timer=.8,e._zigzags=[],e._targets=[];let i=new Set;for(let o=0;o<r;o++){let d=new Set,y=[],c=Be.x,h=Be.y;if(o>0){let e=s/r*o;c=Be.x+15*n(e),h=Be.y+15*f(e)}for(let e=0;e<t;e++){let t=cl(c,h,l+(e>0?100:0),d,i);if(!t)break;if(d.add(t),i.add(t),y.push({x:t.x,y:t.y}),xe(t.x,t.y,"#a0f",3,80),t.active=0,a>0){let e=[0,3,5][a],l=[0,25,40][a];xl(t.x,t.y,e,l)}c=t.x,h=t.y}let p=o>0?Be.x+15*n(s/r*o):Be.x,x=o>0?Be.y+15*f(s/r*o):Be.y;for(let l of y){let t=gl(p,x,l.x,l.y,8);e._zigzags.push(t),e._targets.push(l),p=l.x,x=l.y}}e._arcTimer=.45}e._arcTimer>0&&(e._arcTimer-=l)}window._staticFields||(window._staticFields=[]);var pl=200;function xl(e,l,t,r){if(window._staticFields.length>=pl)return;let a=3+Math.floor(3*Math.random());for(let i=0;i<a&&!(window._staticFields.length>=pl);i++){let a=Math.random()*s,i=Math.random()*r;window._staticFields.push({x:e+n(a)*i,y:l+f(a)*i,life:t,maxLife:t,r:r,stunDur:.15,vx:20*(Math.random()-.5),vy:20*(Math.random()-.5),size:2+3*Math.random()})}}function gl(e,l,t,r,a){let i=[{x:e,y:l}],o=t-e,s=r-l,n=d(o*o+s*s),f=-s/n,y=o/n;for(let t=1;t<a;t++){let r=t/a,d=e+o*r,c=l+s*r,h=(Math.random()-.5)*n*.18;i.push({x:d+f*h,y:c+y*h})}return i.push({x:t,y:r}),i}function ml(e){if(e._arcTimer>0&&e._zigzags){let l=g(e._arcTimer/.45,0,1),t=(e,l,t,r,a)=>{C.beginPath(),C.moveTo(e[0].x,e[0].y);for(let l=1;l<e.length;l++)C.lineTo(e[l].x,e[l].y);C.strokeStyle=l,C.lineWidth=t,C.globalAlpha=r,C.shadowColor=l,C.shadowBlur=a,C.stroke()};C.save();for(let r of e._zigzags){t(r,"#a0f",6,.25*l,15),t(r,"#c6f",3,.6*l,8),t(r,"#eaf",1.5,l,4);let e=r[r.length-1];C.beginPath(),C.arc(e.x,e.y,4*l,0,s),C.fillStyle="#fff",C.globalAlpha=.8*l,C.shadowBlur=10,C.fill()}C.restore()}}function vl(e,l){if(e.timer-=l*(1-Y.cdReduction),e.timer<=0){e.timer=2.2;let l=yl(Be.x,Be.y,9999),t=l?p(l.y-Be.y,l.x-Be.x):Be.angle,r=350;fe.spawn(e=>{e.x=Be.x+16*n(t),e.y=Be.y+16*f(t),e.vx=n(t)*r,e.vy=f(t)*r,e.r=6,e.life=5,e.maxLife=5,e.type="normal",e.color="#f80",e.spawnTime=O.time,e.damage=0,e.pierce=0,e.split=0,e.echoed=0,e.baseSpeed=r,e.curve=0,e.pulseAmp=0,e.src="rocket",e._homing=1,e._homingDelay=0}),e.lastFired=O.time}fe.each(e=>{if(!e.active||"rocket"!==e.src&&"rocket_mini"!==e.src||!e._homing)return;if(e._homingDelay>0)return void(e._homingDelay-=l);let t=yl(e.x,e.y,800);if(t){let r="rocket_mini"===e.src?4:3.5,a=((e,l,t,r,a,i,o,s)=>{let y=p(r-i,t-a),c=p(l,e),h=c+g(b(y-c),-o*s,o*s),x=d(e*e+l*l);return{vx:n(h)*x,vy:f(h)*x}})(e.vx,e.vy,t.x,t.y,e.x,e.y,r,l);e.vx=a.vx,e.vy=a.vy}})}function ul(e){}function bl(e,l){let t=e.droneCount+[0,1,2][e.lv.a],r=e.droneRange,a=[1.5,2.5,3.5][e.lv.b],i=[0,.2,.4][e.lv.c]||0,o=[1.5,.9,.7][e.lv.d]||1.5;for(;e._drones.length<t;)e._drones.push({angle:s/t*e._drones.length,orbitR:60+15*e._drones.length,pulseT:0,x:Be.x,y:Be.y});for(let t=0;t<e._drones.length;t++){let s=e._drones[t];s.x||(s.x=Be.x),s.y||(s.y=Be.y),s.pulseT=h(0,s.pulseT-l);let y=yl(s.x,s.y,400),c=80;if(y){let e=p(y.y-s.y,y.x-s.x);s.x+=n(e)*c*l,s.y+=f(e)*c*l}else{s.angle+=l*(2.5-.3*t);let e=Be.x+n(s.angle)*s.orbitR,r=Be.y+f(s.angle)*s.orbitR;s.x=m(s.x,e,4*l),s.y=m(s.y,r,4*l)}let x=v(s.x,s.y,Be.x,Be.y);if(x>250){let e=p(Be.y-s.y,Be.x-s.x);s.x+=n(e)*(x-250)*3*l,s.y+=f(e)*(x-250)*3*l}if(ne.each(e=>{if(e.active&&v(s.x,s.y,e.x,e.y)<r){let t=d(e.vx*e.vx+e.vy*e.vy);if(t>50){let r=p(e.vy,e.vx),a=t*(1-.4*3*l);e.vx=n(r)*a,e.vy=f(r)*a}}}),s._fireT=(s._fireT||0)-l*(1-Y.cdReduction),s._fireT<=0){s._fireT=o;let e=yl(s.x,s.y,r+80);if(e&&v(s.x,s.y,e.x,e.y)<r+e.r){let l=e.isBoss?.3:1;e.isBoss||(e.cc.silenceT=h(e.cc.silenceT,a*l)),i>0&&(e.cc.slowAmt=h(e.cc.slowAmt,i),e.cc.slowT=h(e.cc.slowT,a*l)),Wl(e,1),s.pulseT=.3,xe(s.x,s.y,"#0aa",5,80)}}}e.timer=e._drones[0]?e._drones[0]._fireT:0}function wl(e){for(let l of e._drones){C.save();let t=l.pulseT>0?1+2*l.pulseT:1;if(C.beginPath(),C.arc(l.x,l.y,6*t,0,s),C.fillStyle="#0aa",C.globalAlpha=.6,C.fill(),ae(l.x,l.y,6*t,"#0ff",1.5,.8),C.beginPath(),C.arc(l.x,l.y,3*t,0,s),C.fillStyle="#fff",C.globalAlpha=.5,C.fill(),ae(l.x,l.y,e.droneRange,"#0aa",.5,.1),l.pulseT>0){let t=e.droneRange*(1-l.pulseT/.3);ae(l.x,l.y,t,"#0ff",2,l.pulseT/.3*.4)}C.restore()}}var Tl=[["regen","REGENERATION","#4f4",3,["Heal 1HP/14s","1HP/8s","1HP/8s + emergency heal"]],["speed","SPEED BOOST","#4f4",3,["+15% speed","+30%","+40% + 8% dodge"]],["cooldown","COOLDOWN REDUCTION","#48f",3,["-12% all CDs","-20%","-25% + faster weapons"]],["damage","POWER SURGE","#f44",2,["+30% damage","+50% damage"]]],Sl={};for(let e=0;e<Tl.length;e++){let l=Tl[e];Sl[l[0]]={name:l[1],color:l[2],maxLv:l[3],desc:l[4]}}var _l=Tl.map(e=>e[0]),Al=["#f66","#f8c","#c8f","#8cf","#a0f","#ff8"],kl=["circle","square","triangle"],Pl=[1,2,4,8,16],Cl=[1,8,16,2],Il=[0,1,2,3,4,5],Rl=["Void","Astral","Iron","Crimson","Aether","Obsidian","Radiant","Grim"],Fl=["Warden","Revenant","Harbinger","Sentinel","Seraph","Tyrant","Overseer","Monarch"],Dl=["Prime","Ascendant","Omega","the Hollow","the Unbound","of Ruin","of Echoes","Mk-II"],Ml=[e=>{Oe.bossRadial(e)},e=>{Oe.bossWall(e)},e=>{for(let l=0;l<5;l++){let t=e.angle+s/5*l;Xe(e.x,e.y,205*n(t),205*f(t),4,e.color,"loop",3.4,{loopAmp:160,loopFreq:1.15,loopBaseAng:t})}},e=>{let l=p(Be.y-e.y,Be.x-e.x);for(let t=-3;t<=3;t++)Xe(e.x,e.y,220*n(l+.11*t),220*f(l+.11*t),4,e.color,"normal",2.6)},(e,l)=>{l.laserSpin+=.36;let t=l.enraged?5:3;for(let r=0;r<t;r++)Te({owner:e,angle:l.laserSpin+s/t*r,length:1.9*h(T,S),width:l.enraged?28:22,life:l.enraged?2.1:1.8,color:e.color,rotSpeed:l.enraged?.75:.45,warn:l.enraged?1.15:1,warnColor:"#ff9f66"})},(e,l)=>{if(l._dashStrike)return;let t=p(Be.y-e.y,Be.x-e.x),r=g(v(e.x,e.y,Be.x,Be.y)+52+(l.enraged?20:0),180,360);l._dashStrike={phase:"tele",t:1,maxT:1,sx:e.x,sy:e.y,ex:e.x+n(t)*r,ey:e.y+f(t)*r,a:t,burst:0},xe(e.x,e.y,e.color,8,130)}];function El(e,l,t){let r=a()+t*o,i=h(_,A)+100;e.x=Be.x+n(r)*i,e.y=Be.y+f(r)*i,e.shape=l.shape,e.color=w(l.color),e.tier="boss",e.isBoss=1,e.bossKind="generated",e.bossShape=l.shape,e.bossAccessory=l.accessory,e.bossName=l.name,e.bossMods=l.mods,e.bossAttacks=l.attacks,e.r=l.r,e.hp=l.hp,e.maxHp=l.hp,e.fireCD=l.fireCD,e.fireTimer=.45+.2*t,e.hitFlash=0,e.angle=0,e.spawnTime=O.time,e.moveParams={speed:l.moveSpeed},e.fireParams={count:10,offset:0},e.cc={stunT:0,silenceT:0,rootT:0,slowAmt:0,slowT:0,fearT:0,markT:0,markAmp:0,kbVx:0,kbVy:0,disorientT:0,bleedDmg:0,bleedT:0},e.shieldHP=0,e._dashInvuln=0,e._role=4&l.mods&&1===t?"melee":"ranged",e._twinIdx=t,e._twinPartner=null,e.moveType="chaser",e.firePattern="bossAimed"}function Bl(e){return{timer:0,attackIdx:0,laserSpin:a(),shieldNodes:[],enraged:0,linkBeam:0,linkTimer:0,dashTimer:0,warpTimer:0,warpCD:3,_portals:[],_warpTele:null,_dashStrike:null,summonTimer:0,update(l,r){if(this.timer+=r,l.angle+=r*(this.enraged?1.8:1.1),this._dashStrike){let e=this._dashStrike;if("tele"===e.phase)e.t-=r,l._dashInvuln=h(l._dashInvuln,.1),l._dashTele={t:e.t,maxT:e.maxT,tx:e.ex,ty:e.ey},e.t<=0&&(e.phase="dash",e.t=.32,e.maxT=.32,e.sx=l.x,e.sy=l.y,l._dashTele=null);else{e.t-=r;let t=g(1-e.t/e.maxT,0,1),a=1-(1-t)*(1-t);if(l.x=m(e.sx,e.ex,a),l.y=m(e.sy,e.ey,a),l._dashInvuln=h(l._dashInvuln,.3),(45*this.timer|0)%2==0&&xe(l.x,l.y,l.color,2,70),e.t<=0){if(l.x=e.ex,l.y=e.ey,!e.burst){e.burst=1,xe(l.x,l.y,l.color,10,160);for(let t=0;t<10;t++){let r=s/10*t+.35*e.a;Xe(l.x,l.y,230*n(r),230*f(r),4,l.color,"normal",.9)}}this._dashStrike=null}}return}let i=p(Be.y-l.y,Be.x-l.x),d=v(l.x,l.y,Be.x,Be.y),y=l.moveParams.speed;if("melee"===l._role)if(d>195+20*l._twinIdx)l.x+=n(i)*y*r,l.y+=f(i)*y*r;else{let e=i+(0===l._twinIdx?o/2:-o/2);l.x+=n(e)*y*.7*r,l.y+=f(e)*y*.7*r}else l.x+=n(i)*y*.35*r,l.y+=f(i)*y*.35*r;if(1&e.mods&&l.hp<.6*l.maxHp&&0===this.shieldNodes.length){for(let e=0;e<4;e++)this.shieldNodes.push({angle:s/4*e,hp:12,lastHit:O.time});O.bannerTimer=.9,O.bannerText="BOSS SHIELD NODES",O.bannerColor=l.color,O.waveModTimer=4,O.waveModText="SHIELD NODES: break the glowing hex shields around the boss. Boss is invincible until all are destroyed."}for(let e of this.shieldNodes)e.angle+=.7*r;if(2&e.mods&&l.hp<.35*l.maxHp&&!this.enraged&&(this.enraged=1,l.fireCD*=.72,l._baseColor||(l._baseColor=l.color),l.color="#f33",O.bannerTimer=1.1,O.bannerText="BOSS ENRAGED",O.bannerColor=l.color),4&e.mods&&(this.linkTimer+=r,this.linkBeam=this.linkTimer%3.6<2.2),8&e.mods)if(this._warpTele){if(this._warpTele.t-=r,this._warpTele.t<=0){let e=this._warpTele;this._warpTele=null;let{x:t,y:r}=l;l.x=e.toX,l.y=e.toY;for(let e=0;e<8;e++){let a=s/8*e;Xe(t,r,150*n(a),150*f(a),4,l.color,"normal",2.8)}this._portals.push({x1:t,y1:r,x2:e.toX,y2:e.toY,life:.25}),xe(t,r,l.color,10,120),xe(e.toX,e.toY,l.color,10,120)}}else if(this.warpTimer+=r,this.warpTimer>this.warpCD){this.warpTimer=0;let e=a(),l=t(120,240);this._warpTele={toX:Be.x+n(e)*l,toY:Be.y+f(e)*l,t:1,maxT:1}}for(let e=this._portals.length-1;e>=0;e--)this._portals[e].life-=r,this._portals[e].life<=0&&this._portals.splice(e,1);if(16&e.mods&&"encounter"===O.waveState&&(this.summonTimer+=r,this.summonTimer>(this.enraged?6:8))){this.summonTimer=0;let e=this.enraged?2:1;for(let r=0;r<e;r++){let e=a(),r=t(90,170);qe("small",{x:l.x+n(e)*r,y:l.y+f(e)*r,moveType:"converge",moveParams:{speed:145},hpMult:1.1,fireMult:1.2,color:l.color})}}},fire(l){if("melee"===l._role)return;let t=e.attacks[this.attackIdx%e.attacks.length];this.attackIdx++;let r=Ml[t];if(r&&r(l,this),8&e.mods&&this._portals.length&&4!==t)for(let e of this._portals)for(let t=0;t<5;t++){let r=s/5*t;Xe(e.x1,e.y1,130*n(r),130*f(r),3.5,l.color,"curve",2.6,{curve:.3})}}}}var Ll=0;function Hl(){var e;O.wave++,O.waveKills=0,O.waveQuota=c(16,4+2*O.wave),O.difficulty=.8+.5*O.wave+O.wave*O.wave*.02,O.waveState="spawning",He&&He.unapply(),e=(()=>{let e,l=0;do{e=r(0,Le.length-1),l++}while(e===We&&l<10);return We=e,e})(),He&&He.unapply(),O.wavePhaseIdx=e,(He=Le[e]).apply(),O.waveBannerTimer=2,O.waveBannerText="WAVE "+O.wave,O.waveBannerSub=He?He.name:"",O.waveModTimer=3,O.waveModText=He?He.desc:""}function Wl(e,l,t,r){if(!e.active)return;if(e._dashInvuln>0)return;let a=l;e.cc.markAmp>0&&(a*=1+e.cc.markAmp);let i=r||0;if(!i&&Y.critChance>0&&Math.random()<Y.critChance&&(i=1,a*=Y.critMult),a*=Y.dmgMult,e.cc.markT>0&&(a*=1+e.cc.markAmp),e.isBoss&&e.bossAI&&e.bossAI.shieldNodes&&e.bossAI.shieldNodes.some(e=>e.hp>0)){let l=null,t=1/0,r=0,i=0;for(let r of e.bossAI.shieldNodes)r.hp<=0||r.hp<t&&(t=r.hp,l=r);if(l){r=e.x+n(l.angle)*(e.r+24),i=e.y+f(l.angle)*(e.r+24);let t=h(1,.9*a);l.hp=h(0,l.hp-t),l.lastHit=O.time,xe(r,i,"#9ef",8,140),he(r,i,0|t,0),e.bossAI.shieldNodes.some(e=>e.hp>0)||(O.bannerTimer=1.2,O.bannerText="SHIELD BROKEN",O.bannerColor="#9ef")}return}e.hp-=a,e.hitFlash=1,he(e.x,e.y,0|a,i),xe(e.x,e.y,e.color,3,80),e.hp<=0&&Nl(e)}function Nl(e){if(!e.active)return;e.active=0;let l=(e.isBoss?450:"elite"===e.tier?55:15)*Y.xpMult;for(O.xp+=l;O.xp>=O.xpToNext&&O.xpToNext>0;)O.xp-=O.xpToNext,O.level++,O.xpToNext=x(.64*(100+100*O.level)),O.levelUpQueue++;if(O.totalKills++,O.waveKills++,(e.isBoss||"elite"===e.tier)&&(O.killFlash=.05),"circle"===e.shape)for(let l=0;l<12;l++){let t=s/12*l;pe(e.x,e.y,200*n(t),200*f(t),e.color,.3,2)}else if("square"===e.shape)for(let l=0;l<8;l++){let t=o/4+s/8*l;pe(e.x+n(t)*e.r,e.y+f(t)*e.r,150*n(t),150*f(t),e.color,.3,3)}else for(let l=0;l<3;l++){let r=s/3*l;for(let l=0;l<4;l++)pe(e.x,e.y,n(r+t(-.3,.3))*(100+50*l),f(r+t(-.3,.3))*(100+50*l),e.color,.3,2)}if(e.isBoss)if(xe(e.x,e.y,"#fff",40,300),xe(e.x,e.y,e.color,30,250),$(15),j(.5,.3),O._twinBoss&&void 0!==e._twinIdx){let l=e._twinPartner;l&&l.active?O.bossEntity=l:(O.bossEntity=null,O._twinBoss=null)}else O.bossEntity=null;else xe(e.x,e.y,e.color,15,180),$("elite"===e.tier?8:3),j(.06,.5)}function Ol(){Be.invuln>0||!Be.alive||(Be.hp--,Be.invuln=.8,Be.hitFlash=.3,$(10),xe(Be.x,Be.y,"#0ff",15,200),Be.hp<=0&&(Be.alive=0,xe(Be.x,Be.y,"#0ff",40,300),xe(Be.x,Be.y,"#fff",20,250),$(15),F.clear(),B=0,L=0,E=null,O.gameOverFade=0,N="dying"))}var Ul=[];function Xl(){let e=[];for(let l of O.weapons){let t=el[l.id];if(t)for(let r of t.upgrades)l.lv[r.id]<r.maxLv&&e.push({type:"weaponUpg",weaponId:l.id,upgId:r.id,def:r,wdef:t,curLv:l.lv[r.id]})}if(O.weapons.filter(e=>"cc"===el[e.id].type).length<2){let l=O.weapons.map(e=>e.id);for(let t of tl)l.includes(t)||e.push({type:"newWeapon",weaponId:t,wdef:el[t]})}let l=0;for(let e=0;e<_l.length;e++)(0|O.passives[_l[e]])>0&&l++;for(let t of _l){let r=O.passives[t]||0,a=Sl[t];a&&(r>0&&r<a.maxLv?e.push({type:"passiveUpg",passiveId:t,def:a,curLv:r}):0===r&&l<3&&e.push({type:"newPassive",passiveId:t,def:a}))}for(let l=e.length-1;l>0;l--){let t=r(0,l);[e[l],e[t]]=[e[t],e[l]]}if((Ul=e.slice(0,5)).length<5)for(;Ul.length<5;){let e=1&Ul.length?"speed":"damage";Ul.push({type:"loopPassive",passiveId:e,def:Sl[e]})}}function Yl(e){let l=Ul[e];if(l){if("weaponUpg"===l.type){let e=O.weapons.find(e=>e.id===l.weaponId);e&&e.lv[l.upgId]++}else if("newWeapon"===l.type)O.weapons.push(Ze(l.weaponId));else if("newPassive"===l.type)O.passives[l.passiveId]=1;else if("passiveUpg"===l.type)O.passives[l.passiveId]++;else if("loopPassive"===l.type){let e="speed"===l.passiveId?"_speedLoop":"_damageLoop";O.passives[e]=1+(0|O.passives[e])}V(),O.levelUpQueue--,O.levelUpQueue>0?(Xl(),N="levelUp",O.refreshAvailable=1):N="playing"}}function Vl(){C.save(),C.fillStyle="#000",C.globalAlpha=.04;for(let e=0;e<S;e+=4)C.fillRect(0,e,T,1);C.restore()}var zl=0;function Kl(e){e<0||e>=ll.length||(O.weapons=[Ze(ll[e])],N="playing",Hl())}function ql(e,l){O.gameOverFade=c(1,(O.gameOverFade||0)+2.8*e),l&&(ge(e),me()),C.fillStyle="rgba(0,0,0,"+O.gameOverFade+")",C.fillRect(0,0,T,S),Vl(),O.gameOverFade>=1&&(N="gameover")}function Gl(){R(),Be.x=0,Be.y=0,Be.hp=10,Be.maxHp=10,Be.invuln=0,Be.hitFlash=0,Be.alive=1,Be.angle=0,Be.swordIFrame=0,V(),ne.clear(),fe.clear(),de.clear(),ye.clear(),_e.clear(),ce.length=0,I.x=0,I.y=0,O.time=0,O.difficulty=.8,O.wave=0,O.waveKills=0,O.waveQuota=0,O.waveState="clear",O.xp=0,O.level=1,O.xpToNext=x(128),O.levelUpQueue=0,O.totalKills=0,O.frozen=0,O.freezeTimer=0,O.killFlash=0,O.bannerTimer=0,O.waveBannerTimer=0,O.waveModTimer=0,O.waveModText="",O.gravity=0,O.windX=0,O.windY=0,O.pulseTimer=0,O.pulseSpeed=0,O.reversed=0,O.reverseTimer=0,O.reverseCD=0,O.pierce=0,O.echo=0,O.weapons=[],O.passives={},O.bossEntity=null,O._twinBoss=null,O._rocketRings=[],O._upgradeTransition=1,O.refreshAvailable=0,O._bossLaserHitCD=0,O._bossModQueue=[],O._bossSpawnPending=0,O.gameOverFade=0,we.length=0,window._staticFields=[],ve.length=0,He=null,We=-1,Ll=1,G=0,N="weaponSelect"}function Ql(e){let l=rl(e);l&&"bow"===l.id&&(e=>{if(!e.charging)return;if(e.charging=0,e.shotCD>0)return void(e.chargeTime=0);let{chargeTime:l,maxCharge:t}=e,r=g(l/t,0,1),a=Be.angle,i=10+18*r;for(let l=0;l<1;l++){let t=(l-0)*i;be(e,r,a,t,1,1,1,"#ff0");let o=g(0|e.lv.a,0,2);for(let l=1;l<=o;l++){let i=.07*l;be(e,r,a+i,t,.5,.7,.85,"#ffd84a"),be(e,r,a-i,t,.5,.7,.85,"#ffd84a")}}e.chargeTime=0,e.shotCD=.22,$(2+4*r),j(.04,.7+.3*r),xe(Be.x+22*n(a),Be.y+22*f(a),"#fff",8,140)})(l)}addEventListener("keydown",e=>{F.add(e.code),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)&&e.preventDefault();let l=e.code;if("dying"!==N&&("Escape"===l&&("playing"===N?N="paused":"paused"===N&&(N="playing")),"Enter"===l&&"title"===N&&Gl(),"KeyR"===l&&"gameover"===N&&Gl(),"weaponSelect"===N&&("Digit1"===l&&Kl(0),"Digit2"===l&&Kl(1),"Digit3"===l&&Kl(2)),"levelUp"===N&&(O._upgradeTransition||0)>=.9&&("Digit1"===l&&Yl(0),"Digit2"===l&&Yl(1),"Digit3"===l&&Yl(2),"Digit4"===l&&Yl(3),"Digit5"===l&&Yl(4),"KeyR"===l&&O.refreshAvailable>0&&(O.refreshAvailable--,Xl())),"KeyR"===l&&"playing"===N)){let e=O.weapons.find(e=>"dagger"===e.id);e&&"idle"!==e.state&&(e.state="returning")}});var $l=performance.now();requestAnimationFrame(function a(b){requestAnimationFrame(a);let w=g((b-$l)/1e3,0,.05);if($l=b,"title"!==N){if("paused"===N)return C.save(),C.fillStyle="rgba(0,0,0,.5)",C.fillRect(0,0,T,S),C.restore(),re("PAUSED",_,A-20,36,"#0ff",e,l),void re("Press ESC to Resume",_,A+30,16,"#888",e,l);if("weaponSelect"!==N)if("dying"!==N){if("gameover"===N)return C.fillStyle="#000",C.fillRect(0,0,T,S),C.save(),C.fillStyle="rgba(0,0,0,.6)",C.fillRect(0,0,T,S),C.restore(),re("GAME OVER",_,A-110,36,"#f44",e,l),re("Waves Survived: "+h(0,O.wave-1),_,A-66,17,"#fff",e,l),re("Enemies Killed: "+O.totalKills,_,A-44,14,"#9cf",e,l),re("[R] Restart",_,A+30,12,"#888",e,l),void Vl();if("levelUp"===N){void 0===O._upgradeTransition&&(O._upgradeTransition=1),O._upgradeTransition=c(1,O._upgradeTransition+4*w);let t=O._upgradeTransition,r=t<1?1-Math.pow(1-t,3):1;if(Ee(w,.24),C.fillStyle="rgba(0,0,0,"+.35*r+")",C.fillRect(0,0,T,S),E&&t>=.9){let e=c(5,Ul.length),l=_-(150*e+12*(e-1))/2,t=A-60;for(let r=0;r<e;r++){let e=l+162*r;if(E.x>=e&&E.x<=e+150&&E.y>=t&&E.y<=t+140){Yl(r);break}}E=null}else E&&(E=null);return(t=>{t=t||1,C.save(),C.globalAlpha=t,re("LEVEL UP",_,A-140,22,"#ff0",e,l),C.restore();let r=c(5,Ul.length),a=140,i=_-(150*r+12*(r-1))/2,o=A-60;for(let t=0;t<r;t++){let r=Ul[t],s=i+162*t,n=o,f=D>=s&&D<=s+150&&M>=n&&M<=n+a,d="#0ff",y="",c="";"weaponUpg"===r.type?(d=r.wdef.color,y=r.wdef.name+": "+r.def.name,c=r.def.desc[r.curLv]||""):"newWeapon"===r.type?(d=r.wdef.color,y="NEW "+r.wdef.name,c=r.wdef.cc?"CC: "+r.wdef.cc:r.wdef.desc):"newPassive"===r.type?(d=r.def.color,y="NEW "+r.def.name,c=r.def.desc[0]):"passiveUpg"===r.type?(d=r.def.color,y=r.def.name,c=r.def.desc[r.curLv]||""):"loopPassive"===r.type&&(d=r.def.color,y=r.def.name,c=r.def.desc[0]),ie(s,n,150,a,"rgba(8,16,24,.9)",f?"#fff":d,f?2:1.2,f?1:.78),re(y,s+75,n+24,10,f?"#fff":d,e,l),re(c,s+75,n+70,9,"#9aa",e,l),re("["+(t+1)+"]",s+75,n+a-14,12,"#666",e,l)}re(O.refreshAvailable>0?"[R] Reroll ("+O.refreshAvailable+")":"[R] No rerolls",_,o+a+20,13,O.refreshAvailable>0?"#4f4":"#666",e,l)})(r),void Vl()}if(E&&"playing"===N){let e=W();(function(e,l,t){let r=rl(e);r&&("dagger"===r.id?((e,l,t)=>{"idle"===e.state||"waiting"===e.state||"spinning"===e.state?(e.state="flying",e.tx=l,e.ty=t,"idle"===e.state&&(e.dx=Be.x,e.dy=Be.y)):"flying"===e.state?(e.tx=l,e.ty=t):"returning"===e.state&&(e.state="flying",e.tx=l,e.ty=t)})(r,l,t):"sword"===r.id?(e=>{let l=.4*(1-Y.cdReduction);e.swingCD>0||e.lungeTimer>0||(e.swingCD=l,e.lungeDir=Be.angle,e.lungeDist=[120,160,200,250][e.lv.a]*(1+[0,.15,.3][e.lv.c]),e.lungeStartX=Be.x,e.lungeStartY=Be.y,e.lungeTimer=.18,e.lungeProg=0,(()=>{let e=0;return ye.each(l=>{l.isBoss&&(e=1)}),e})()&&be(e,1,e.lungeDir,0,2,1.35,1.25,"#f6f",1),xe(Be.x+15*n(e.lungeDir),Be.y+15*f(e.lungeDir),"#f0f",6,100))})(r):"bow"===r.id&&(e=>{e.shotCD<=0&&(e.charging=1)})(r))})(E.btn,e.x,e.y),E=null}if(B||Ql(0),L||Ql(2),G>0&&(G-=w,w*=Q),O.time+=w,O.killFlash=h(0,O.killFlash-w),O.levelUpQueue>0&&"playing"===N)return Xl(),N="levelUp",O._upgradeTransition=0,void(O.refreshAvailable=1);if(I.x=m(I.x,Be.x,8*w),I.y=m(I.y,Be.y,8*w),C.fillStyle="rgba(0,0,0,0.18)",C.fillRect(0,0,T,S),q>.2?(z=(Math.random()-.5)*q*2,K=(Math.random()-.5)*q*2,q*=.87):z=K=q=0,C.save(),C.translate(-I.x+_+z,-I.y+A+K),(()=>{let e=I.x-_-100,l=I.y-A-100,t=I.x+_+100,r=I.y+A+100,a=100*x(e/100),i=100*x(l/100),o=50*x(e/50),s=50*x(l/50);C.save(),C.strokeStyle="#2a5f82",C.lineWidth=.9,C.globalAlpha=.62,C.beginPath();for(let e=a;e<=t;e+=100)C.moveTo(e,l),C.lineTo(e,r);for(let l=i;l<=r;l+=100)C.moveTo(e,l),C.lineTo(t,l);C.stroke(),C.strokeStyle="#18344a",C.lineWidth=.6,C.globalAlpha=.38,C.beginPath();for(let e=o;e<=t;e+=50)C.moveTo(e,l),C.lineTo(e,r);for(let l=s;l<=r;l+=50)C.moveTo(e,l),C.lineTo(t,l);C.stroke(),C.fillStyle="#58b7ff",C.globalAlpha=.22;for(let e=o;e<=t;e+=50)for(let l=s;l<=r;l+=50)C.fillRect(e-1.5,l-1.5,3,3);C.restore()})(),(()=>{let e=x((I.x-_)/Se)-1,l=x((I.x+_)/Se)+1,t=x((I.y-A)/Se)-1,r=x((I.y+A)/Se)+1;for(let a=e;a<=l;a++)for(let e=t;e<=r;e++){let l=ke(a,e);for(let e=0;e<l.length;e++){let t=l[e];"pillar"===t.type?(C.save(),C.beginPath(),C.arc(t.x,t.y,t.r,0,s),C.fillStyle="#0a1520",C.globalAlpha=.6,C.fill(),C.restore(),J(t.x,t.y,t.r,"#1a4a6a",2)):(C.save(),C.fillStyle="#0a1520",C.globalAlpha=.6,C.fillRect(t.x,t.y,t.w,t.h),C.restore(),ee([{x:t.x,y:t.y},{x:t.x+t.w,y:t.y},{x:t.x+t.w,y:t.y+t.h},{x:t.x,y:t.y+t.h}],"#1a4a6a",1,2))}}})(),(e=>{if(!Be.alive)return;let l=O.weapons.find(e=>"sword"===e.id);if(l&&l.lungeTimer>0){Be.invuln=h(0,Be.invuln-e),Be.hitFlash=h(0,Be.hitFlash-5*e),Be.swordIFrame=h(0,Be.swordIFrame-e);let l=W(),t=l.x-Be.x,r=l.y-Be.y;return t*t+r*r>4&&(Be.angle=p(r,t)),Ie(Be),void(O.passives.regen&&(Y.regenTimer-=e,Y.regenTimer<=0&&(Y.regenTimer=Y.regenInterval,Be.hp<Be.maxHp&&Be.hp++)))}let t=(()=>{let e=0,l=0;(H("KeyW")||H("ArrowUp"))&&(l=-1),(H("KeyS")||H("ArrowDown"))&&(l=1),(H("KeyA")||H("ArrowLeft"))&&(e=-1),(H("KeyD")||H("ArrowRight"))&&(e=1);let t=d(e*e+l*l);return t>0?{x:e/t,y:l/t}:{x:0,y:0}})(),r=t.x,a=t.y;O.reversed&&(r=-r,a=-a),Be.x+=r*Y.moveSpeed*1*e,Be.y+=a*Y.moveSpeed*1*e,(0!==r||0!==a)&&(Be.x+=O.windX*e*.3,Be.y+=O.windY*e*.3),Ie(Be);let i=W(),o=i.x-Be.x,s=i.y-Be.y;o*o+s*s>4&&(Be.angle=p(s,o)),Be.invuln=h(0,Be.invuln-e),Be.hitFlash=h(0,Be.hitFlash-5*e),Be.swordIFrame=h(0,Be.swordIFrame-e),Y.regenTimer=(Y.regenTimer||0)+e,Y.regenTimer>=Y.regenInterval&&Be.hp<Be.maxHp&&(Y.regenTimer=0,Be.hp=c(Be.hp+1,Be.maxHp))})(w),(e=>{for(let l of O.weapons)"dagger"===l.id?al(l,e):"sword"===l.id?sl(l,e):"bow"===l.id?fl(l,e):"chain"===l.id?hl(l,e):"rocket"===l.id?vl(l,e):"drone"===l.id&&bl(l,e)})(w),(e=>{O.frozen||ye.each(l=>{let t=l.cc;if(t.bleedT>0&&(t.bleedT-=e,l.hp-=t.bleedDmg*e,l.hp<=0&&Nl(l)),t.stunT>0)return t.stunT-=e,l.hitFlash=.2,void Ie(l);if(t.silenceT>0&&(t.silenceT-=e),t.rootT>0&&(t.rootT-=e),t.slowT>0?t.slowT-=e:t.slowAmt=0,t.fearT>0){t.fearT-=e;let r=p(l.y-Be.y,l.x-Be.x),a=1.5*(l.moveParams.speed||100);l.x+=n(r)*a*e,l.y+=f(r)*a*e}else if(t.disorientT>0)t.disorientT-=e,l.x+=200*(Math.random()-.5)*e,l.y+=200*(Math.random()-.5)*e;else if(t.kbVx||t.kbVy)l.x+=t.kbVx*e,l.y+=t.kbVy*e,t.kbVx*=.9,t.kbVy*=.9,y(t.kbVx)<5&&(t.kbVx=0),y(t.kbVy)<5&&(t.kbVy=0);else if(t.rootT<=0){let r=t.slowT>0?1-t.slowAmt:1,a=l.moveParams.speed;a&&(l.moveParams.speed=a*r),l.isBoss&&l.bossAI?l.bossAI.update(l,e):Ne[l.moveType]&&Ne[l.moveType](l,e),a&&(l.moveParams.speed=a)}if(t.markT>0?t.markT-=e:t.markAmp=0,t.silenceT<=0){let r=t.slowT>0?1-.5*t.slowAmt:1;l.fireTimer-=e*r,l.fireTimer<=0&&Be.alive&&(l.fireTimer+=l.fireCD,l.isBoss&&l.bossAI?l.bossAI.fire(l):Oe[l.firePattern]&&Oe[l.firePattern](l))}l.angle+=e*("sentry"===l.moveType?1.5:.5),l.hitFlash=h(0,l.hitFlash-5*e),l._dashInvuln>0&&(l._dashInvuln=h(0,l._dashInvuln-e)),Ie(l),v(l.x,l.y,Be.x,Be.y)>1400&&!l.isBoss&&(l.active=0)})})(w),(e=>{O._bossLaserHitCD=h(0,(O._bossLaserHitCD||0)-e);for(let l=we.length-1;l>=0;l--){let t=we[l];if(!t.owner||!t.owner.active){we.splice(l,1);continue}if(t.angle+=t.rotSpeed*e,t.x1=t.owner.x+t.offsetX,t.y1=t.owner.y+t.offsetY,t.warn>0){t.warn=h(0,t.warn-e);continue}if(t.life-=e,t.life<=0){we.splice(l,1);continue}let r=t.x1+n(t.angle)*t.length,a=t.y1+f(t.angle)*t.length;Be.alive&&Be.invuln<=0&&O._bossLaserHitCD<=0&&u(Be.x,Be.y,t.x1,t.y1,r,a)<=.45*t.width+Be.r&&(O._bossLaserHitCD=.12,Ol())}})(w),Qe(ne,w,0),Qe(fe,w,1),ge(w),(e=>{for(let l=ce.length-1;l>=0;l--){let t=ce[l];t.y+=t.vy*e,t.vy+=100*e,t.life-=e,t.life<=0&&ce.splice(l,1)}})(w),(e=>{for(let l=ve.length-1;l>=0;l--)ve[l].life-=e,ve[l].life<=0&&ve.splice(l,1)})(w),Be.alive&&(fe.each(e=>{e.active&&ye.each(l=>{if(l.active){if(l.isBoss&&l.bossAI&&l.bossAI.shieldNodes&&l.bossAI.shieldNodes.some(e=>e.hp>0))for(let t of l.bossAI.shieldNodes){if(t.hp<=0)continue;let r=l.x+n(t.angle)*(l.r+24),a=l.y+f(t.angle)*(l.r+24);if(v(e.x,e.y,r,a)<e.r+10)return t.hp=h(0,t.hp-h(1,1.1*e.damage)),t.lastHit=O.time,xe(r,a,"#f99",6,120),void(e.active=0)}if(v(e.x,e.y,l.x,l.y)<e.r+l.r){if("rocket"===e.src)return e.active=0,void((e,l)=>{let t=O.weapons.find(e=>"rocket"===e.id);if(!t)return;let r=t.blastR+[0,30,50][t.lv.c],a=t.kbForce+[0,40,80,120][t.lv.a],i=[.5,.8,1.2,1.5][t.lv.a]||.5;if(xe(e,l,"#f80",25,250),xe(e,l,"#ff4",15,180),$(8),O._rocketRings||(O._rocketRings=[]),O._rocketRings.push({x:e,y:l,r:r,life:.3,maxLife:.3}),ne.each(t=>{t.active&&v(e,l,t.x,t.y)<r&&(t.active=0,xe(t.x,t.y,"#f80",2,60))}),ye.each(t=>{if(t.active&&v(e,l,t.x,t.y)<r+t.r){Wl(t,1);let r=t.isBoss?.4:1,o=p(t.y-l,t.x-e);t.cc.kbVx=n(o)*a*r,t.cc.kbVy=f(o)*a*r,t.cc.disorientT=i*r}}),t.lv.b>0){let r=[0,5,7][t.lv.b];for(let t=0;t<r;t++){let a=s/r*t;fe.spawn(t=>{t.x=e+10*n(a),t.y=l+10*f(a),t.vx=220*n(a),t.vy=220*f(a),t.r=3,t.life=2,t.maxLife=2,t.type="normal",t.color="#fa0",t.spawnTime=O.time,t.damage=1,t.pierce=0,t.split=0,t.echoed=0,t.baseSpeed=220,t.curve=0,t.pulseAmp=0,t.src="rocket_mini",t._homing=1,t._homingDelay=.35})}}})(e.x,e.y);if("rocket_mini"===e.src)return e.active=0,xe(e.x,e.y,"#fa0",8,100),$(2),void ye.each(l=>{if(l.active&&v(e.x,e.y,l.x,l.y)<40+l.r){Wl(l,1);let t=p(l.y-e.y,l.x-e.x);l.cc.kbVx+=80*n(t),l.cc.kbVy+=80*f(t)}});Wl(l,e.damage,e.src),e.pierce>0?e.pierce--:O.pierce||(e.active=0)}}})}),Be.invuln<=0&&(ne.each(e=>{if(e.active&&v(e.x,e.y,Be.x,Be.y)<e.r+Be.r){if(Y.dodgeChance>0&&Math.random()<Y.dodgeChance)return;e.active=0,Ol()}}),ye.each(e=>{e.active&&v(e.x,e.y,Be.x,Be.y)<e.r+Be.r&&Ol()}))),"dying"===N)return C.restore(),ql(w,0),void(E=null);if((e=>{if("spawning"===O.waveState){if((Ll-=e)<=0){let e=6+2.4*O.wave+1.2*O.difficulty;ye.count()<e&&qe(Math.random()<.1+.02*O.wave?"elite":"small"),Ll=h(.16,1.65-.11*O.wave-.1*O.difficulty-O.wave*O.wave*.0015)}O.waveKills>=O.waveQuota&&(O.waveState="encounter",O._bossSpawnPending=1,O.killFlash=h(O.killFlash,.16),setTimeout(()=>{(()=>{let e=function(){let e=(O._bossModQueue&&0!==O._bossModQueue.length||(O._bossModQueue=(e=>{for(let l=e.length-1;l>0;l--){let t=r(0,l);[e[l],e[t]]=[e[t],e[l]]}return e})(Cl.slice())),O._bossModQueue.pop()),l=c(4,1+x(h(0,O.wave-1)/4)),a=1;for(;a<l;){let l=Pl.filter(l=>!(e&l));if(12&e&&(l=l.filter(e=>!(12&e))),!l.length)break;e|=i(l),a++}let o=((e,l)=>{let t=e.slice();for(let e=t.length-1;e>0;e--){let l=r(0,e);[t[e],t[l]]=[t[l],t[e]]}return t.slice(0,l)})(Il,4&e?2:3),s=i(kl),n=i(Al),f=r(0,2),d=x(.5*(190+85*O.wave+O.wave*O.wave*22+r(-40,60))),y=r(34,48),p=t(.9,1.45)*h(.52,1-.02*O.wave),g=t(70,105)+1.3*O.wave,m=(e=>4&e?"Twin "+i(Fl)+" "+i(["Apex","Prime","Ascendant"]):i(Rl)+" "+i(Fl)+" "+i(Dl))(e);return{mods:e,attacks:o,shape:s,color:n,accessory:f,hp:d,r:y,fireCD:p,moveSpeed:g,name:m}}();ye.each(e=>{e.active&&!e.isBoss&&(e.active=0)}),ne.clear();let l=!!(4&e.mods),a=[];for(let t=0;t<(l?2:1);t++)ye.spawn(l=>{El(l,e,t),l.bossAI=Bl(e),a.push(l)});2===a.length?(a[0]._twinPartner=a[1],a[1]._twinPartner=a[0],O._twinBoss=a):O._twinBoss=null,O.bossEntity=a[0],O.bannerTimer=2,O.bannerText="BOSS: "+e.name,O.bannerColor=e.color})(),O._bossSpawnPending=0},120))}else if("encounter"===O.waveState){if(O._bossSpawnPending)return;let e=1;ye.each(l=>{l.isBoss&&(e=0)}),e&&(O.waveState="clear",ne.clear(),xe(Be.x,Be.y,"#fff",30,250),$(10),j(.3,.3),O.bannerTimer=2,O.bannerText="WAVE "+O.wave+" CLEAR!",O.bannerColor="#0ff",setTimeout(()=>Hl(),2e3))}O.frozen&&(O.freezeTimer-=e,O.freezeTimer<=0&&(O.frozen=0)),He&&He.tick(e)})(w),(()=>{for(let e of we){let l=g(e.life/e.maxLife,0,1),t=e.x1+n(e.angle)*e.length,r=e.y1+f(e.angle)*e.length;if(e.warn>0){let l=g(e.warn/h(1e-4,e.maxWarn),0,1),a=.45+.45*y(f(18*O.time));C.save(),C.lineCap="round",C.setLineDash([12,10]),C.beginPath(),C.moveTo(e.x1,e.y1),C.lineTo(t,r),C.strokeStyle=e.warnColor,C.lineWidth=h(2,.22*e.width),C.globalAlpha=(.2+.55*(1-l))*a,C.shadowColor=e.warnColor,C.shadowBlur=10,C.stroke(),C.setLineDash([]),C.restore();continue}ue(e.x1,e.y1,t,r,e.width,l,e.color,1)}})(),$e(ne),$e(fe),ye.each(e=>{let l=e.hitFlash>0?"#fff":e.color,t=e.cc;t.fearT>0&&(l="#ddd");let r=e.r+(e.hitFlash>0?2:0);if(e.isBoss)(e=>{let l=e.r,t=e.color||"#f6c";C.save(),C.translate(e.x,e.y),C.rotate(.6*e.angle);let r=e.bossShape||"circle";if("square"===r?ee(te(0,0,l,0),t,1,4):"triangle"===r?ee(le(0,0,l,0),t,1,4):J(0,0,l,t,4),C.beginPath(),C.arc(0,0,.24*l+1.2*f(5*O.time),0,s),C.fillStyle="#fff",C.globalAlpha=.7,C.fill(),e._dashInvuln>0&&(C.beginPath(),C.arc(0,0,l+7+1.8*f(16*O.time),0,s),C.strokeStyle="rgba(255,235,180,.55)",C.lineWidth=2,C.stroke()),C.restore(),e.bossAI&&e.bossAI.shieldNodes&&e.bossAI.shieldNodes.some(e=>e.hp>0))for(let l of e.bossAI.shieldNodes){if(l.hp<=0)continue;let r=e.x+n(l.angle)*(e.r+22),a=e.y+f(l.angle)*(e.r+22);J(r,a,8,t,2),Z(r,a,2.5,"#fff")}})(e);else{let t="elite"===e.tier?4:3;"circle"===e.shape?J(e.x,e.y,r,l,t):"square"===e.shape?ee(te(e.x,e.y,r,e.angle),l,1,t):ee(le(e.x,e.y,r,e.angle),l,1,t)}if(e._dashTele&&("dasher"===e.moveType||e.isBoss)&&(e=>{if(!e._dashTele)return;let l=e._dashTele,t=1-g(l.t/h(1e-4,l.maxT),0,1),r=p(l.ty-e.y,l.tx-e.x),a=e.x+n(r)*(e.r+12),i=e.y+f(r)*(e.r+12);C.save(),ae(e.x,e.y,e.r+8+2*f(18*O.time),"rgba(255,235,140,"+(.24+.42*t)+")",2.1),C.translate(a,i),C.rotate(r);let o=7+1.8*t;C.beginPath(),C.moveTo(o,0),C.lineTo(.55*-o,.55*-o),C.lineTo(.55*-o,.55*o),C.closePath(),C.fillStyle="rgba(255,245,180,"+(.35+.4*t)+")",C.fill(),C.restore()})(e),"elite"===e.tier&&e.hp<e.maxHp&&!e.isBoss){let l=2*e.r;C.fillStyle="#333",C.fillRect(e.x-l/2,e.y-e.r-8,l,3),C.fillStyle=e.color,C.fillRect(e.x-l/2,e.y-e.r-8,l*(e.hp/e.maxHp),3)}if(t.markT>0&&(C.beginPath(),C.arc(e.x,e.y-e.r-10,3,0,s),C.fillStyle="#ccc",C.fill()),(t.stunT>0||t.rootT>0||t.slowT>0||t.bleedT>0)&&(C.beginPath(),C.arc(e.x,e.y,e.r+3,0,s),C.strokeStyle="rgba(255,255,255,.4)",C.lineWidth=1.2,C.stroke()),t.silenceT>0){let l=e.r+5;C.beginPath(),C.moveTo(e.x-l,e.y-l),C.lineTo(e.x+l,e.y+l),C.moveTo(e.x+l,e.y-l),C.lineTo(e.x-l,e.y+l),C.strokeStyle="#0aa",C.lineWidth=2.2,C.globalAlpha=.85,C.stroke()}}),(()=>{if(!Be.alive)return;if(Be.invuln>0&&Be.swordIFrame<=0&&(20*O.time|0)%2==0)return;let e=Be.hitFlash>0?"#fff":"#0ff";if(ee(le(Be.x,Be.y,Be.r,Be.angle+o/2),e,1,4),C.save(),C.beginPath(),C.arc(Be.x,Be.y,.4*Be.r,0,s),C.fillStyle=e,C.globalAlpha=.15,C.fill(),C.restore(),Be.swordIFrame>0){let e=g(Be.swordIFrame/.25,0,1),l=Be.r+8+2*f(18*O.time);C.save(),C.beginPath(),C.arc(Be.x,Be.y,l,0,s),C.strokeStyle="#f6f",C.lineWidth=2.2,C.globalAlpha=.2+.35*e,C.shadowColor="#f6f",C.shadowBlur=10,C.stroke(),C.beginPath(),C.arc(Be.x,Be.y,l-4,0,s),C.strokeStyle="#8ff",C.lineWidth=1.2,C.globalAlpha=.15+.25*e,C.shadowColor="#8ff",C.shadowBlur=6,C.stroke();for(let l=0;l<2;l++){let t=14*O.time+l*o,r=le(Be.x-n(Be.angle)*(8+5*l)+2*n(t),Be.y-f(Be.angle)*(8+5*l)+2*f(t),.65*Be.r,Be.angle+o/2);C.beginPath(),C.moveTo(r[0].x,r[0].y),C.lineTo(r[1].x,r[1].y),C.lineTo(r[2].x,r[2].y),C.closePath(),C.fillStyle="#f6f",C.globalAlpha=.08+.12*e,C.fill()}C.restore()}})(),(()=>{for(let e of O.weapons)"dagger"===e.id?ol(e):"sword"===e.id?nl(e):"bow"===e.id?dl(e):"chain"===e.id?ml(e):"rocket"===e.id?ul():"drone"===e.id&&wl(e)})(),(()=>{for(let e of ve){let l=g(e.life/e.maxLife,0,1),t=.9+.1*f(40*O.time+e.phase);ue(e.x1,e.y1,e.x2,e.y2,e.width*t,l,e.color,0),C.save();for(let t=0;t<5;t++){let r=(t+.5)/5+.015*f(10*O.time+t+e.phase),a=m(e.x1,e.x2,g(r,0,1)),i=m(e.y1,e.y2,g(r,0,1));C.beginPath(),C.arc(a,i,2+3*l,0,s),C.fillStyle="#fff",C.globalAlpha=.1+.25*l,C.fill()}C.restore()}})(),(()=>{for(let e of window._staticFields){let l=g(e.life/e.maxLife,0,1);C.save(),C.globalAlpha=.8*l,C.beginPath(),C.arc(e.x,e.y,e.size*l,0,s),C.fillStyle="#c6f",C.fill(),C.beginPath(),C.arc(e.x,e.y,e.size*l*2,0,s),C.fillStyle="#a0f",C.globalAlpha=.15*l,C.fill(),C.restore()}})(),me(),(()=>{for(let t of ce){let r=t.life/t.maxLife;C.save(),C.globalAlpha=r,C.font="bold "+12*t.scale+"px monospace",C.textAlign=e,C.textBaseline=l,C.fillStyle=t.color,C.shadowColor=t.color,C.shadowBlur=6,C.fillText(t.text,t.x,t.y),C.restore()}})(),O._twinBoss){let e=O._twinBoss;if(e[0]&&e[0].active&&e[1]&&e[1].active&&e[0].bossAI.linkBeam){C.save();let l=g(.4+.2*f(5*O.time),0,1);C.beginPath(),C.moveTo(e[0].x,e[0].y),C.lineTo(e[1].x,e[1].y),C.strokeStyle="#f4a",C.lineWidth=6,C.globalAlpha=.3*l,C.shadowColor="#f4a",C.shadowBlur=15,C.stroke(),C.beginPath(),C.moveTo(e[0].x,e[0].y),C.lineTo(e[1].x,e[1].y),C.strokeStyle="#fff",C.lineWidth=2,C.globalAlpha=.5*l,C.shadowBlur=8,C.stroke();let t=e[1].x-e[0].x,r=e[1].y-e[0].y,a=d(t*t+r*r);if(a>0){let l=-r/a,i=t/a,o=Be.x-e[0].x,s=Be.y-e[0].y,n=o*t/a+s*r/a,f=y(o*l+s*i);n>0&&n<a&&f<20&&Ol()}C.restore()}else e[0]&&!e[0].active&&e[1]&&e[1].active&&(O.bossEntity=e[1])}if(ye.each(e=>{if(e.active&&e.isBoss&&e.bossAI&&e.bossAI._portals)for(let l of e.bossAI._portals){let e=g(l.life/.25,0,1);Ge(l.x1,l.y1,e,0),Ge(l.x2,l.y2,e,1.1)}}),ye.each(e=>{if(!(e.active&&e.isBoss&&e.bossAI&&e.bossAI._warpTele))return;let l=e.bossAI._warpTele,t=1-g(l.t/h(1e-4,l.maxT),0,1);Ge(l.toX,l.toY,.35+.65*t,1.6),Ge(e.x,e.y,.25+.45*t,.35)}),O._rocketRings)for(let e=O._rocketRings.length-1;e>=0;e--){let l=O._rocketRings[e];if(l.life-=w,l.life<=0){O._rocketRings.splice(e,1);continue}let t=1-l.life/l.maxLife;C.save(),C.beginPath(),C.arc(l.x,l.y,l.r*t,0,s),C.strokeStyle="#f80",C.lineWidth=3*(1-t),C.globalAlpha=.6*(1-t),C.shadowColor="#f80",C.shadowBlur=10,C.stroke(),C.beginPath(),C.arc(l.x,l.y,l.r*t*.6,0,s),C.strokeStyle="#ff4",C.lineWidth=2*(1-t),C.globalAlpha=.4*(1-t),C.stroke(),C.restore()}C.restore(),O.killFlash>0&&(C.save(),C.fillStyle="#fff",C.globalAlpha=3*O.killFlash,C.fillRect(0,0,T,S),C.restore()),O.frozen&&(C.save(),C.fillStyle="rgba(50,100,200,0.08)",C.fillRect(0,0,T,S),C.restore()),(()=>{let e=C.createRadialGradient(_,A,.3*c(T,S),_,A,.7*c(T,S));e.addColorStop(0,"rgba(0,0,0,0)");let l=Be.hp<=1&&Be.alive;e.addColorStop(1,l?"rgba(80,0,0,0.5)":"rgba(0,0,0,0.35)"),C.save(),C.fillStyle=e,C.fillRect(0,0,T,S),C.restore()})(),(()=>{let t=c(T-16,560),r=_-t/2,a=g(Be.hp/h(1,Be.maxHp),0,1),i=g(O.xp/O.xpToNext,0,1),o=a>.5?"#0ef":a>.25?"#fd4":"#f55";ie(r,10,t,54,"rgba(0,0,0,.55)","rgba(255,255,255,.15)",1);let s=r+42,n=t-54,f=(n-18)/10;for(let e=0;e<10;e++){let l=s+e*(f+2),t=g(10*a-e,0,1);C.fillStyle="rgba(18,18,18,.95)",C.fillRect(l,19,f,12),t>0&&(C.fillStyle=o,C.fillRect(l,19,f*t,12)),C.strokeStyle="rgba(255,255,255,.24)",C.strokeRect(l,19,f,12)}C.fillStyle="rgba(18,18,18,.95)",C.fillRect(s,37,n,9),C.fillStyle="#fd4",C.fillRect(s,37,n*i,9),C.strokeStyle="rgba(255,223,74,.3)",C.strokeRect(s,37,n,9),re("HP",r+12,19,10,"#dff"),re("XP",r+12,36,10,"#fd4");let d=O.time%60|0;re("TIME "+(O.time/60|0)+":"+(d<10?"0":"")+d,r+12,51,9,"#8ea"),He&&re(He.name,r+t-12,51,9,He.color,"right");let y=c(T-80,460),p=_-y/2;if(O.bossEntity&&O.bossEntity.active){let l=O.bossEntity,t=l.hp/l.maxHp;re(l.bossName||"BOSS",_,88,11,l.color,e,"top"),ie(p,72,y,12,"#222","rgba(255,80,80,.6)",1),C.fillStyle="#c33",C.fillRect(p,72,y*t,12)}else if("spawning"===O.waveState){let e=g(O.waveKills/O.waveQuota,0,1);ie(p,72,y,7,"rgba(20,20,20,.92)","rgba(0,255,255,.32)",1),C.fillStyle="#0ff",C.fillRect(p,72,y*e,7)}let x={chain:.8,rocket:2.2,drone:1.5},m=_-52*h(1,O.weapons.length)/2+26;for(let t=0;t<O.weapons.length;t++){let r=O.weapons[t],a=el[r.id],i=m+52*t,o=S-46;ie(i-18,o-12,36,24,"rgba(0,0,0,.5)",a.color,1),re(a.name.charAt(0),i,o-1,12,a.color,e,l);let s=x[r.id];if(s&&void 0!==r.timer){let e=g(1-r.timer/s,0,1);C.fillStyle="rgba(0,0,0,.55)",C.fillRect(i-18,o+14,36,3),C.fillStyle=a.color,C.fillRect(i-18,o+14,36*e,3)}}if(O.bannerTimer>0&&(O.bannerTimer-=.016666666666666666,C.save(),C.globalAlpha=c(1,2*O.bannerTimer),re(O.bannerText,_,A-60,24,O.bannerColor,e,l),C.restore()),O.waveBannerTimer>0){O.waveBannerTimer-=.016666666666666666;let t=c(1,O.waveBannerTimer);C.save(),C.globalAlpha=t;let r=30+20*(1-t);re(O.waveBannerText,_,A-30,r,"#fff",e,l),O.waveBannerSub&&re(O.waveBannerSub,_,A+10,16,He?He.color:"#888",e,l),C.restore()}if(O.waveModTimer>0&&O.waveModText){O.waveModTimer-=.016666666666666666;let l=g(O.waveModTimer/3,0,1),t=c(T-40,720),r=50,a=_-t/2,i=S-136;ie(a,i,t,r,"#000",He?He.color:"#aaa",1.4,.24*l),ie(a,i,t,r,null,He?He.color:"#aaa",1.4,.4*l),re("MODIFIER: "+O.waveModText,_,i+16,16,He?He.color:"#9ab",e,"top")}})(),Vl(),E=null}else ql(w,1);else{if(E){let e=ll.length,l=_-(180*e+20*(e-1))/2,t=A-70;for(let r=0;r<e;r++){let e=l+200*r;if(E.x>=e&&E.x<=e+180&&E.y>=t&&E.y<=t+200){Kl(r);break}}E=null}(t=>{Ee(t,.35),re("CHOOSE YOUR WEAPON",_,60,24,"#0ff",e,l);let r=ll.length,a=_-(180*r+20*(r-1))/2,i=A-70;function o(l,t,r,a,i){C.save(),C.font="bold 9px monospace";let o=(l||"").split(/\s+/).filter(Boolean),s=[],n="";for(let e=0;e<o.length;e++){let l=n?n+" "+o[e]:o[e];C.measureText(l).width>a&&n?(s.push(n),n=o[e]):n=l}n&&s.push(n);let f=s.slice(0,i);s.length>i&&f.length&&(f[f.length-1]=f[f.length-1].replace(/\.*$/,"")+"..."),C.textAlign=e,C.textBaseline="top",C.fillStyle="#9aa";for(let e=0;e<f.length;e++)C.fillText(f[e],t,r+12*e);C.restore()}for(let t=0;t<r;t++){let r=el[ll[t]],s=a+200*t,n=i,f=D>=s&&D<=s+180&&M>=n&&M<=n+200,d=f?"#fff":r.color;ie(s,n,180,200,"rgba(8,16,24,0.9)",d,f?2:1.2,f?1:.75),re(r.name,s+90,n+25,13,d,e,l),re("starter"===r.type?"PRIMARY":"CC",s+90,n+62,10,r.color,e,l),o(r.desc,s+90,n+84,158,4),re("["+(t+1)+"]",s+90,n+200-20,14,"#555",e,l)}Vl()})(w)}}else(t=>{zl+=t,Ee(t,.28),C.save(),C.globalAlpha=.7+.3*f(3*zl),re("NEON PHASES",_,A-80,42,"#0ff",e,l),C.restore(),(2*zl|0)%2&&re("Press ENTER to Start",_,A+12,16,"#fff",e,l),Vl()})(w)})})();</script></body></html>