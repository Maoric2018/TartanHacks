<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>NEON PHASES</title><style>*{margin:0;padding:0}body{background:#000;overflow:hidden}canvas{display:block;cursor:crosshair}</style></head><body><canvas id="c"></canvas><script>"use strict";var e,l,t;e="center",l="middle",t="round",(()=>{function r(e,l){return e+Math.random()*(l-e)}function a(e,l){return e+Math.random()*(l-e+1)|0}function i(){return Math.random()*Math.PI*2}function o(e){return e[Math.random()*e.length|0]}var s=Math.PI,n=2*s,{cos:f,sin:d,sqrt:c,abs:y,min:h,max:x,atan2:p,floor:m}=Math;function g(e,l,t){return e<l?l:e>t?t:e}function v(e,l,t){return e+(l-e)*t}function u(e,l,t,r){return c((e-t)**2+(l-r)**2)}function b(e,l,t,r,a,i){let o=a-t,s=i-r,n=o*o+s*s;if(n<=1e-6)return u(e,l,t,r);let f=g(((e-t)*o+(l-r)*s)/n,0,1);return u(e,l,t+o*f,r+s*f)}function T(e){for(;e>s;)e-=n;for(;e<-s;)e+=n;return e}function w(e){return"string"==typeof e&&"#0ff"===e.toLowerCase()?"#0cf":e||"#f44"}var S,k,_,A,P,C=document.getElementById("c"),R=C.getContext("2d"),E={x:0,y:0};function I(){P=devicePixelRatio||1,S=innerWidth,k=innerHeight,C.width=S*P,C.height=k*P,C.style.width=S+"px",C.style.height=k+"px",R.setTransform(P,0,0,P,0,0),_=S/2,A=k/2}addEventListener("resize",I),I();var D=new Set,F=_,L=A,M=null,B=0,W=0;function H(e){return D.has(e)}function N(){return{x:F-_+E.x,y:L-A+E.y}}addEventListener("keyup",e=>D.delete(e.code)),addEventListener("mousemove",e=>{F=e.clientX,L=e.clientY}),addEventListener("mousedown",e=>{0===e.button&&(B=1),2===e.button&&(W=1),M={x:e.clientX,y:e.clientY,btn:e.button}}),addEventListener("mouseup",e=>{0===e.button&&(B=0),2===e.button&&(W=0)}),addEventListener("contextmenu",e=>e.preventDefault());var O="title",U={time:0,difficulty:.8,wave:0,waveKills:0,waveQuota:0,waveState:"spawning",wavePhaseIdx:-1,bossEntity:null,xp:0,level:1,xpToNext:160,levelUpQueue:0,totalKills:0,frozen:0,freezeTimer:0,bannerTimer:0,bannerText:"",bannerColor:"#fff",gravity:0,windX:0,windY:0,pulseTimer:0,pulseSpeed:0,reversed:0,reverseTimer:0,reverseCD:0,pierce:0,echo:0,bounce:0,mirror:0,fragile:0,lucky:0,weapons:[],passives:{},killFlash:0,waveBannerTimer:0,waveBannerText:"",waveBannerSub:"",waveModTimer:0,waveModText:"",_bossLaserHitCD:0,_bossModQueue:[],_bossSpawnPending:0,gameOverFade:0},X={speed:[["moveSpeed","mul",[1,1.15,1.3,1.4]],["dodgeChance","set",[0,0,0,.08]]],regen:[["regenInterval","set",[999,14,8,8]]],cooldown:[["cdReduction","set",[0,.12,.2,.25]]],damage:[["dmgMult","mul",[1,1.3,1.5]]]};function Y(e,l,t){void 0!==t&&("mul"===l?V[e]*=t:"mul1"===l?V[e]*=1+t:"add"===l?V[e]+=t:V[e]="add_cap"===l?h(.5,V[e]+t):t)}var V={moveSpeed:240,critChance:0,critMult:2,xpMult:1,cdReduction:0,regenTimer:0,regenInterval:999,dodgeChance:0,dmgMult:1};function z(){V.moveSpeed=240,V.critChance=0,V.critMult=2,V.xpMult=1,V.cdReduction=0,V.regenInterval=999,V.dodgeChance=0,V.dmgMult=1;let e=U.passives;for(let l in X){let t=0|e[l];if(!t)continue;let r=X[l];for(let e=0;e<r.length;e++){let l=r[e],a=l[2];Y(l[0],l[1],a[h(t,a.length-1)])}}let l=0|e._speedLoop,t=0|e._damageLoop;l&&(V.moveSpeed*=1+.15*l),t&&(V.dmgMult*=1+.3*t)}var K=0,q=0,G=0,Q=0,j=1;function $(e){G=x(G,e)}function Z(e,l){Q=e,j=l}function J(e,l,t,r,a){a=a||3,R.save();for(let i=a;i>0;i--)R.beginPath(),R.arc(e,l,t+2.5*i,0,n),R.strokeStyle=r,R.lineWidth=2*i,R.globalAlpha=.07,R.stroke();R.beginPath(),R.arc(e,l,t,0,n),R.strokeStyle=r,R.lineWidth=1.5,R.globalAlpha=1,R.stroke(),R.restore()}function ee(e,l,t,r){R.save(),R.beginPath(),R.arc(e,l,t+4,0,n),R.fillStyle=r,R.globalAlpha=.12,R.fill(),R.beginPath(),R.arc(e,l,t,0,n),R.fillStyle=r,R.globalAlpha=.9,R.fill(),R.restore()}function le(e,l,t,r){function a(){R.beginPath(),R.moveTo(e[0].x,e[0].y);for(let l=1;l<e.length;l++)R.lineTo(e[l].x,e[l].y);t&&R.closePath()}t=0!=t,r=r||3,R.save();for(let e=r;e>0;e--)a(),R.strokeStyle=l,R.lineWidth=2.5*e,R.globalAlpha=.07,R.stroke();a(),R.strokeStyle=l,R.lineWidth=1.5,R.globalAlpha=1,R.stroke(),R.restore()}function te(e,l,t,r){let a=[];for(let i=0;i<3;i++){let o=r+n/3*i-s/2;a.push({x:e+f(o)*t,y:l+d(o)*t})}return a}function re(e,l,t,r){let a=[];for(let i=0;i<4;i++){let o=r+n/4*i+s/4;a.push({x:e+f(o)*t,y:l+d(o)*t})}return a}function ae(e,l,t,r,a,i,o){R.save(),R.font="bold "+r+"px monospace",R.textAlign=i||"left",R.textBaseline=o||"top",R.shadowColor=a,R.shadowBlur=10,R.fillStyle=a,R.globalAlpha=.5,R.fillText(e,l,t),R.shadowBlur=0,R.globalAlpha=1,R.fillText(e,l,t),R.restore()}function ie(e,l,t,r,a,i,o){R.save();for(let s=3;s>0;s--)R.beginPath(),R.arc(e,l,t,r,a),R.strokeStyle=i,R.lineWidth=(o||2)+2*s,R.globalAlpha=.06,R.stroke();R.beginPath(),R.arc(e,l,t,r,a),R.strokeStyle=i,R.lineWidth=o||2,R.globalAlpha=1,R.stroke(),R.restore()}function oe(e,l,t,r,a,i){R.beginPath(),R.arc(e,l,t,0,n),R.strokeStyle=r,R.lineWidth=a||1,void 0!==i&&(R.globalAlpha=i),R.stroke()}function se(e,l,t,r,a,i,o,s){R.save(),void 0!==s&&(R.globalAlpha=s),a&&(R.fillStyle=a,R.fillRect(e,l,t,r)),i&&(R.strokeStyle=i,R.lineWidth=o||1,R.strokeRect(e,l,t,r)),R.restore()}function ne(e,l){let t=[];for(let r=0;r<e;r++){let e=l();e.active=0,t.push(e)}return t.spawn=e=>{for(let l=0;l<t.length;l++)if(!t[l].active)return t[l].active=1,e(t[l]),t[l];let l=0,r=1/0;for(let e=0;e<t.length;e++)t[e].spawnTime<r&&(r=t[e].spawnTime,l=e);return t[l].active=1,e(t[l]),t[l]},t.each=e=>{for(let l=0;l<t.length;l++)t[l].active&&e(t[l])},t.count=()=>{let e=0;for(let l=0;l<t.length;l++)t[l].active&&e++;return e},t.clear=()=>{for(let e=0;e<t.length;e++)t[e].active=0},t}function fe(){return{active:0,x:0,y:0,vx:0,vy:0,r:4,life:0,maxLife:3,type:"normal",color:"#f44",spawnTime:0,damage:1,curve:0,pulseAmp:0,pulseFreq:0,split:0,echoed:0,echoTimer:0,baseSpeed:0,pierce:0,src:null,loopAmp:0,loopFreq:0,loopBaseAng:0,bossHomingTurn:0,bossHomingStop:0,_bounced:0}}var de=ne(900,fe),ce=ne(150,fe),ye=ne(500,()=>({active:0,x:0,y:0,vx:0,vy:0,life:0,maxLife:.4,color:"#fff",r:2,spawnTime:0})),he=ne(50,()=>({active:0,x:0,y:0,vx:0,vy:0,r:14,hp:2,maxHp:2,shape:"circle",color:"#f44",moveType:"drifter",firePattern:"single",fireTimer:0,fireCD:2,tier:"small",angle:0,hitFlash:0,spiralAngle:0,moveParams:{},fireParams:{},spawnTime:0,cc:{stunT:0,silenceT:0,rootT:0,slowAmt:0,slowT:0,fearT:0,markT:0,markAmp:0,kbVx:0,kbVy:0,disorientT:0,bleedDmg:0,bleedT:0},isBoss:0,bossAI:null,shieldHP:0})),xe=[];function pe(e,l,t,r){xe.length>200||xe.push({x:e+20*(Math.random()-.5),y:l,vy:-60-30*Math.random(),text:r?t+"!":""+t,color:r?"#ff0":"#fff",life:.6,maxLife:.6,scale:r?1.4:1})}function me(e,l,t,r,a,i,o){ye.spawn(s=>{s.x=e,s.y=l,s.vx=t,s.vy=r,s.color=a,s.life=i||.4,s.maxLife=i||.4,s.r=o||2,s.spawnTime=U.time})}function ge(e,l,t,r,a){for(let i=0;i<r;i++){let r=Math.random()*n,i=a*(.3+.7*Math.random());me(e,l,f(r)*i,d(r)*i,t,.2+.3*Math.random(),1+2*Math.random())}}function ve(e){ye.each(l=>{l.x+=l.vx*e,l.y+=l.vy*e,l.vx*=.97,l.vy*=.97,l.life-=e,l.life<=0&&(l.active=0)})}function ue(){ye.each(e=>{let l=g(e.life/e.maxLife,0,1);R.save(),R.globalAlpha=.8*l,R.beginPath(),R.arc(e.x,e.y,e.r*l,0,n),R.fillStyle=e.color,R.fill(),R.restore()})}var be=[],Te=[],we=[];function Se(e,l,r,a,i,o,s,n){let f=i*(n?1+.35*o:.8+.4*o),d=x(n?4:3,i*(n?.45:.3)*(n?.85+.25*o:.8+.3*o)),c=x(n?2.5:2,i*(n?.2:.12));R.save(),R.lineCap=t;let y=R.createLinearGradient(e,l,r,a);y.addColorStop(0,"rgba(255,255,255,0)"),y.addColorStop(.08,"rgba(255,216,74,"+(.12+.14*o)+")"),y.addColorStop(1,n?"rgba(255,120,120,"+(.1+.22*o)+")":"rgba(255,216,74,"+(.08+.2*o)+")"),R.beginPath(),R.moveTo(e,l),R.lineTo(r,a),R.strokeStyle=y,R.lineWidth=f,R.globalAlpha=1,R.shadowColor=s,R.shadowBlur=n?18:20,R.stroke();let h=R.createLinearGradient(e,l,r,a);h.addColorStop(0,"rgba(255,255,255,0)"),h.addColorStop(n?.1:.08,"rgba(255,255,255,"+(n?.15+.2*o:.16+.2*o)+")"),h.addColorStop(1,n?"rgba(255,180,180,"+(.2+.38*o)+")":"rgba(255,216,74,"+(.2+.4*o)+")"),R.beginPath(),R.moveTo(e,l),R.lineTo(r,a),R.strokeStyle=h,R.lineWidth=d,R.shadowBlur=n?10:12,R.stroke();let p=R.createLinearGradient(e,l,r,a);p.addColorStop(0,"rgba(255,255,255,0)"),p.addColorStop(n?.12:.1,"rgba(255,255,255,"+(.25+.25*o)+")"),p.addColorStop(1,"rgba(255,255,255,"+(n?.3+.4*o:.35+.45*o)+")"),R.beginPath(),R.moveTo(e,l),R.lineTo(r,a),R.strokeStyle=p,R.lineWidth=c,R.shadowBlur=n?6:8,R.stroke(),R.restore()}function ke(e,l,t,r,a,o,s,n,c){if(we.length>=18)return;let y=r||0,h=a||1,p=o||1,m=s||1,u=-d(t),T=f(t),w=Ne.x+16*f(t)+u*y,_=Ne.y+16*d(t)+T*y,A=1.9*x(S,k)*m,P=v(4,26,l)*p,C=v(1.2,11,l)*h,R=g(0|e.lv.a,0,2);A*=1+.08*R,P*=1+.08*R,C*=1+.07*R;let E=w+f(t)*A,I=_+d(t)*A;he.each(l=>{if(l.active&&(!c||l.isBoss)&&b(l.x,l.y,w,_,E,I)<=.5*P+l.r&&(Kl(l,C,"bow_beam"),"bow"===e.id)){let t=g(0|e.lv.c,0,2);t>0&&(l.cc.bleedDmg=x(l.cc.bleedDmg,[0,1.2,2.2][t]),l.cc.bleedT=x(l.cc.bleedT,[0,1.5,2.5][t]))}}),de.each(e=>{e.active&&b(e.x,e.y,w,_,E,I)<=.55*P+e.r&&(e.active=0,ge(e.x,e.y,"#ff0",2,70))});for(let e=0;e<6;e++){let l=.15+.15*e;ge(v(w,E,l),v(_,I,l),"#ff0",2,60)}we.push({x1:w,y1:_,x2:E,y2:I,width:P,length:A,life:.12+.1*l,maxLife:.12+.1*l,color:n||"#ff0",phase:i(),hot:0})}var _e=[];function Ae(e){_e.push({owner:e.owner||null,x1:e.x1||0,y1:e.y1||0,angle:e.angle||0,length:e.length||800,width:e.width||20,rotSpeed:e.rotSpeed||0,life:e.life||.9,maxLife:e.life||.9,color:w(e.color||"#f66"),offsetX:e.offsetX||0,offsetY:e.offsetY||0,warn:e.warn||0,maxWarn:e.warn||0,warnColor:e.warnColor||"#ffcc66"})}var Pe=500,Ce=new Map,Re=4294967295*Math.random()>>>0;function Ee(e,l){let t=((e,l)=>2097152*(e+1048576)+(l+1048576))(e,l);if(Ce.has(t))return Ce.get(t);let r=((e,l)=>{let t=(374761393*e+668265263*l^Re)>>>0;return t=Math.imul(t^t>>>13,1274126177),(t^t>>>16)>>>0})(e,l),a=()=>(r=1103515245*r+12345&2147483647,r/2147483647),i=m(5*a()),o=[],s=e=>{for(let l=0;l<o.length;l++){let t=o[l];if("pillar"===e.type&&"pillar"===t.type){if(u(e.x,e.y,t.x,t.y)<e.r+t.r+12)return 1}else{let l="pillar"===e.type?{x:e.x-e.r,y:e.y-e.r,w:2*e.r,h:2*e.r}:e,r="pillar"===t.type?{x:t.x-t.r,y:t.y-t.r,w:2*t.r,h:2*t.r}:t;if(l.x<l.x+l.w&&r.x<r.x+r.w){let e=l.x<r.x+r.w&&l.x+l.w>r.x,t=l.y<r.y+r.h&&l.y+l.h>r.y;if(e&&t&&!(l.x+l.w+12<r.x||l.x>r.x+r.w+12||l.y+l.h+12<r.y||l.y>r.y+r.h+12))return 1}}}return 0};for(let t=0;t<i;t++){let t=0;for(let r=0;r<10;r++){let r=e*Pe+380*a()+60,i=l*Pe+380*a()+60,n=a()<.5?{type:"pillar",x:r,y:i,r:18+32*a()}:{type:"wall",x:r-(50+110*a())/2,y:i-(18+45*a())/2,w:50+110*a(),h:18+45*a()};if(!s(n)){o.push(n),t=1;break}}}return Ce.set(t,o),o}function Ie(e,l,t,r){let a=e.x-l,i=e.y-t,o=c(a*a+i*i),s=e.r+r;o<s&&o>.01&&(e.x=l+a/o*s,e.y=t+i/o*s)}function De(e,l,t,r,a){let i=g(e.x,l,l+r),o=g(e.y,t,t+a),s=e.x-i,n=e.y-o,f=c(s*s+n*n);if(f<e.r&&f>.01)e.x=i+s/f*e.r,e.y=o+n/f*e.r;else if(f<=.01&&e.x>=l&&e.x<=l+r&&e.y>=t&&e.y<=t+a){let i=[e.x-l,l+r-e.x,e.y-t,t+a-e.y],o=i.indexOf(h(...i));0===o?e.x=l-e.r:1===o?e.x=l+r+e.r:e.y=2===o?t-e.r:t+a+e.r}}function Fe(e){let l=m(e.x/Pe),t=m(e.y/Pe);for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){let i=Ee(l+r,t+a);for(let l=0;l<i.length;l++)"pillar"===i[l].type?Ie(e,i[l].x,i[l].y,i[l].r):De(e,i[l].x,i[l].y,i[l].w,i[l].h)}}var Le=["#f44","#f84","#fd4","#f6f","#9f6","#f95"],Me={t:0,enemies:[],bullets:[]};function Be(e){(e=e||{}).x=r(0,S),e.y=r(0,k);let l=i(),t=r(35,95);return e.vx=f(l)*t,e.vy=d(l)*t,e.r=r(8,16),e.shape=o(["circle","triangle"]),e.color=o(Le),e.fire=r(.2,1.1),e}function We(e){let l=p(A-e.y,_-e.x)+r(-.9,.9),t=r(120,220);Me.bullets.push({x:e.x,y:e.y,vx:f(l)*t,vy:d(l)*t,life:r(1.2,2.6),r:2.4,color:e.color}),Me.bullets.length>120&&Me.bullets.splice(0,Me.bullets.length-120)}function He(e,l){(e=>{if(!Me.enemies.length)for(let e=0;e<10;e++)Me.enemies.push(Be({}));Me.t+=e;for(let l of Me.enemies)l.fire-=e,l.x+=l.vx*e,l.y+=l.vy*e,(l.x<-20||l.x>S+20||l.y<-20||l.y>k+20)&&Be(l),l.fire<=0&&(We(l),l.fire=r(.25,1.2));for(let l=Me.bullets.length-1;l>=0;l--){let t=Me.bullets[l];t.x+=t.vx*e,t.y+=t.vy*e,t.life-=e,(t.life<=0||t.x<-30||t.y<-30||t.x>S+30||t.y>k+30)&&Me.bullets.splice(l,1)}})(e||0),R.fillStyle="#02060b",R.fillRect(0,0,S,k);let t=100,a=50,i=30*Me.t%t,o=16*Me.t%t,s=46*Me.t%a,n=26*Me.t%a;R.save(),R.strokeStyle="#2a5f82",R.lineWidth=.9,R.globalAlpha=.5,R.beginPath();for(let e=-i;e<=S+t;e+=t)R.moveTo(e,0),R.lineTo(e,k);for(let e=-o;e<=k+t;e+=t)R.moveTo(0,e),R.lineTo(S,e);R.stroke(),R.strokeStyle="#18344a",R.lineWidth=.6,R.globalAlpha=.35,R.beginPath();for(let e=-s;e<=S+a;e+=a)R.moveTo(e,0),R.lineTo(e,k);for(let e=-n;e<=k+a;e+=a)R.moveTo(0,e),R.lineTo(S,e);R.stroke(),R.fillStyle="#58b7ff",R.globalAlpha=.14;for(let e=-s;e<=S+a;e+=a)for(let l=-n;l<=k+a;l+=a)R.fillRect(e-1,l-1,2,2);R.restore();for(let e of Me.bullets)R.save(),R.globalAlpha=.45*g(e.life/2,0,1),ee(e.x,e.y,e.r,e.color),R.restore();for(let e of Me.enemies)R.save(),R.globalAlpha=.55,"circle"===e.shape?J(e.x,e.y,e.r,e.color,3):le(te(e.x,e.y,e.r,1.2*Me.t),e.color,1,3),R.restore();l&&(R.fillStyle="rgba(0,0,0,"+l+")",R.fillRect(0,0,S,k))}var Ne={x:0,y:0,r:12,hp:10,maxHp:10,invuln:0,angle:0,hitFlash:0,alive:1,swordIFrame:0},Oe=[{name:"GRAVITY",color:"#84f",desc:"Bullets strongly curve toward you",apply(){U.gravity=220},unapply(){U.gravity=0},tick(){}},{name:"DRIFT",color:"#4ff",desc:"Wind pushes everything",apply(){let e=i();U.windX=80*f(e),U.windY=80*d(e)},unapply(){U.windX=0,U.windY=0},tick(e){let l=p(U.windY,U.windX)+.3*e,t=c(U.windX**2+U.windY**2);U.windX=f(l)*t,U.windY=d(l)*t}},{name:"PULSE",color:"#ff0",desc:"Periodic bullet speed bursts",apply(){U.pulseTimer=0,U.pulseSpeed=0},unapply(){U.pulseSpeed=0,U.pulseTimer=0},tick(e){U.pulseTimer+=e,U.pulseTimer>3&&(U.pulseTimer=0,U.pulseSpeed=200,$(5)),U.pulseSpeed>0&&(U.pulseSpeed=x(0,U.pulseSpeed-400*e))}},{name:"ECHO",color:"#0af",desc:"Bullets spawn ghost copies",apply(){U.echo=1},unapply(){U.echo=0},tick(){}},{name:"REVERSE",color:"#f6c",desc:"Controls periodically invert",apply(){U.reversed=0,U.reverseTimer=1.8,U.reverseCD=0},unapply(){U.reversed=0,U.reverseTimer=0,U.reverseCD=0},tick(e){U.reverseTimer-=e,U.reverseTimer<=0&&(U.reversed=!U.reversed,U.reverseTimer=U.reversed?2.2:1.6)}},{name:"FREEZE",color:"#9cf",desc:"Short enemy time-freeze pulses",apply(){this._t=1.6,U.frozen=0,U.freezeTimer=0},unapply(){U.frozen=0,U.freezeTimer=0,this._t=0},tick(e){this._t-=e,this._t<=0&&!U.frozen&&(U.frozen=1,U.freezeTimer=.65,this._t=2.4,$(4))}},{name:"PIERCE",color:"#8f8",desc:"Your projectiles pierce targets",apply(){U.pierce=1},unapply(){U.pierce=0},tick(){}},{name:"MIRROR",color:"#aff",desc:"Reflect enemy bullets near you",apply(){U.mirror=1},unapply(){U.mirror=0},tick(){}},{name:"BOUNCE",color:"#fa8",desc:"Enemy bullets ricochet off obstacles once",apply(){U.bounce=1},unapply(){U.bounce=0},tick(){}},{name:"FRAGILE",color:"#f88",desc:"Projectiles decay faster",apply(){U.fragile=1},unapply(){U.fragile=0},tick(){}},{name:"LUCKY",color:"#ff8",desc:"Bonus XP and extra crit chance",apply(){U.lucky=1},unapply(){U.lucky=0},tick(){}}],Ue=null,Xe=-1,Ye={drifter(e,l){if(e.x+=e.vx*l,e.y+=e.vy*l,u(e.x,e.y,Ne.x,Ne.y)>500){let t=p(Ne.y-e.y,Ne.x-e.x);e.vx+=40*f(t)*l,e.vy+=40*d(t)*l}let t=c(e.vx**2+e.vy**2);t>100&&(e.vx*=100/t,e.vy*=100/t)},chaser(e,l){let t=p(Ne.y-e.y,Ne.x-e.x),r=e.moveParams.speed||120;e.vx=v(e.vx,f(t)*r,2*l),e.vy=v(e.vy,d(t)*r,2*l),e.x+=e.vx*l,e.y+=e.vy*l},orbiter(e,l){let t=e.moveParams.radius||150;e.moveParams.angle=(e.moveParams.angle||0)+(e.moveParams.speed||1.5)*l,e.x=v(e.x,Ne.x+f(e.moveParams.angle)*t,3*l),e.y=v(e.y,Ne.y+d(e.moveParams.angle)*t,3*l)},dasher(e,l){let t=e.moveParams;if(t.state||(t.state="wait"),"wait"===t.state){t.waitTime=(t.waitTime||0)+l;let r=p(Ne.y-e.y,Ne.x-e.x);if(e.x+=20*f(r)*l,e.y+=20*d(r)*l,t.waitTime>1.5){let l=p(Ne.y-e.y,Ne.x-e.x),r=g(u(e.x,e.y,Ne.x,Ne.y)+36,120,260);t.state="telegraph",t.dashTx=e.x+f(l)*r,t.dashTy=e.y+d(l)*r,t.teleT=1,t.teleMax=1,e._dashTele={t:1,maxT:1,tx:t.dashTx,ty:t.dashTy}}}else if("telegraph"===t.state)t.teleT-=l,e._dashInvuln=x(e._dashInvuln,.1),e._dashTele&&(e._dashTele.t=t.teleT),t.teleT<=0&&(t.state="dashing",t.dashT=.32,t.dashMax=.32,t.sx=e.x,t.sy=e.y,t.ex=t.dashTx,t.ey=t.dashTy,e._dashTele=null);else{t.dashT-=l;let r=g(1-t.dashT/t.dashMax,0,1),a=1-(1-r)*(1-r);e.x=v(t.sx,t.ex,a),e.y=v(t.sy,t.ey,a),e._dashInvuln=x(e._dashInvuln,.3),t.dashT<=0&&(e.x=t.ex,e.y=t.ey,t.state="wait",t.waitTime=0)}},sentry(e,l){let t=p(Ne.y-e.y,Ne.x-e.x);e.x+=15*f(t)*l,e.y+=15*d(t)*l,e.angle+=1.5*l},weaver(e,l){let t=e.moveParams;t.t=(t.t||0)+l;let r=p(Ne.y-e.y,Ne.x-e.x),a=t.speed||100,i=t.freq||2,o=r+s/2,n=80*d(t.t*i);e.x+=(f(r)*a+f(o)*n*i)*l,e.y+=(d(r)*a+d(o)*n*i)*l},stationary(e,l){},bossChase(e,l){let t=p(Ne.y-e.y,Ne.x-e.x);e.x+=60*f(t)*l,e.y+=60*d(t)*l},converge(e,l){let t=p(Ne.y-e.y,Ne.x-e.x),r=e.moveParams.speed||150;e.x+=f(t)*r*l,e.y+=d(t)*r*l}},Ve={single(e){let l=p(Ne.y-e.y,Ne.x-e.x),t=180+10*U.difficulty;ze(e.x,e.y,f(l)*t,d(l)*t,4,e.color,"normal",3)},triple(e){let l=p(Ne.y-e.y,Ne.x-e.x),t=170+8*U.difficulty;for(let r=-1;r<=1;r++)ze(e.x,e.y,f(l+.2*r)*t,d(l+.2*r)*t,3.5,e.color,"normal",2.5)},radial(e){let l=e.fireParams.count||8,t=140+5*U.difficulty,r=e.fireParams.offset||0;for(let a=0;a<l;a++){let i=n/l*a+r;ze(e.x,e.y,f(i)*t,d(i)*t,3.5,e.color,"normal",3)}e.fireParams.offset=(r+.15)%n},spiral(e){let l=160+6*U.difficulty;e.spiralAngle=(e.spiralAngle||0)+.4,ze(e.x,e.y,f(e.spiralAngle)*l,d(e.spiralAngle)*l,4,e.color,"curve",3.5,{curve:.4})},ringpop(e){for(let l=0;l<10;l++){let t=n/10*l;ze(e.x,e.y,200*f(t),200*d(t),3,e.color,"pulse",3,{pulseAmp:.7,pulseFreq:3})}},wave(e){let l=p(Ne.y-e.y,Ne.x-e.x),t=160+5*U.difficulty,r=l+s/2;for(let a=0;a<5;a++){let i=15*(a-2);ze(e.x+f(r)*i,e.y+d(r)*i,f(l)*t,d(l)*t,3,e.color,"normal",3)}},bossRadial(e){let l=e.spiralAngle||0;for(let t=0;t<16;t++){let r=n/16*t+l;Ke(e.x,e.y,150*f(r),150*d(r),5,e.color,"normal",4)}e.spiralAngle=(l+.2)%n},bossWall(e){let l=p(Ne.y-e.y,Ne.x-e.x),t=l+s/2;for(let r=0;r<13;r++){let a=30*(r-6);Ke(e.x+f(t)*a,e.y+d(t)*a,220*f(l),220*d(l),4.2,e.color,"normal",3.2)}}};function ze(e,l,t,r,a,i,o,s,n){de.spawn(f=>{f.x=e,f.y=l,f.vx=t,f.vy=r,f.r=a||4,f.color=w(i||"#f44"),f.type=o||"normal",f.life=s||3,f.maxLife=s||3,f.spawnTime=U.time,f.echoed=0,f.echoTimer=0,f.damage=1,f.curve=n&&n.curve||0,f.pulseAmp=n&&n.pulseAmp||0,f.pulseFreq=n&&n.pulseFreq||0,f.split=n&&n.split||0,f.baseSpeed=c(t*t+r*r),f.loopAmp=n&&n.loopAmp||0,f.loopFreq=n&&n.loopFreq||0,f.loopBaseAng=n&&void 0!==n.loopBaseAng?n.loopBaseAng:p(r,t),f.bossFx=n&&n.bossFx||"normal",f.bossFxPower=n&&n.bossFxPower||0,f.bossFxFreq=n&&n.bossFxFreq||0,f.bossFxPhase=n&&n.bossFxPhase||0,f.bossWindX=n&&n.bossWindX||0,f.bossWindY=n&&n.bossWindY||0,f.bossFxSpin=n&&n.bossFxSpin||0,f.bossHomingTurn=n&&n.bossHomingTurn||0,f.bossHomingStop=n&&n.bossHomingStop||0,f._bounced=0})}function Ke(e,l,t,r,a,s,n,c,y){let h=(()=>{let e=o(["normal","gravity","speed_shift","wind_shift","homing"]);if("gravity"===e)return{bossFx:"gravity",bossFxPower:360+220*Math.random()};if("speed_shift"===e)return{bossFx:"speed_shift",bossFxPower:1.25+.95*Math.random(),bossFxFreq:6+4*Math.random(),bossFxPhase:i()};if("wind_shift"===e){let e=i(),l=260+170*Math.random();return{bossFx:"wind_shift",bossWindX:f(e)*l,bossWindY:d(e)*l,bossFxSpin:.8+1.1*Math.random()}}return"homing"===e?{bossFx:"homing",bossHomingTurn:2.4+1.8*Math.random(),bossHomingStop:150+90*Math.random()}:{bossFx:"normal"}})();if(y)for(let e in y)h[e]=y[e];ze(e,l,t,r,a,s,n,c,h)}var qe=["#f44","#f84","#ff4","#4f4","#4ff","#f4f","#84f"],Ge=["circle","square","triangle"],Qe=["drifter","chaser","orbiter","dasher","sentry","weaver"],je=["single","triple","radial","spiral","ringpop","wave"];function $e(e,l){let t="elite"===(e=e||"small");he.spawn(s=>{let n=i(),c=x(_,A)+50+r(0,100);s.x=l&&void 0!==l.x?l.x:Ne.x+f(n)*c,s.y=l&&void 0!==l.y?l.y:Ne.y+d(n)*c,s.shape=l&&l.shape||o(Ge),s.color=w(l&&l.color||o(qe)),s.moveType=l&&l.moveType||o(Qe),s.firePattern=l&&l.firePattern||o(je),s.tier=e,s.r=t?22:14;let y=1+.11*U.wave+U.wave*U.wave*.003;if(s.hp=(t?10:3)*y|0,s.maxHp=s.hp,s.fireCD=(t?r(.8,1.5):r(1.5,3))/(1+.08*U.difficulty),l&&l.fireMult&&(s.fireCD/=l.fireMult),s.fireTimer=r(.5,s.fireCD),s.hitFlash=0,s.angle=i(),s.spiralAngle=i(),s.spawnTime=U.time,s._dashTele=null,s._dashInvuln=0,s.moveParams=l&&l.moveParams||{},s.fireParams={},s.isBoss=0,s.bossAI=null,s.shieldHP=0,s.cc={stunT:0,silenceT:0,rootT:0,slowAmt:0,slowT:0,fearT:0,markT:0,markAmp:0,kbVx:0,kbVy:0,disorientT:0,bleedDmg:0,bleedT:0},"drifter"===s.moveType){let e=r(40,80),l=i();s.vx=f(l)*e,s.vy=d(l)*e}else"orbiter"===s.moveType?(s.moveParams.radius=s.moveParams.radius||r(100,200),s.moveParams.speed=s.moveParams.speed||r(1,2.5)*(Math.random()<.5?1:-1),s.moveParams.angle=s.moveParams.angle||i()):"dasher"===s.moveType?(s.moveParams.state="wait",s.moveParams.waitTime=0,s.vx=0,s.vy=0):"weaver"===s.moveType?(s.moveParams.t=0,s.moveParams.speed=s.moveParams.speed||r(60,120),s.moveParams.freq=s.moveParams.freq||r(2,5)):"chaser"===s.moveType?(s.moveParams.speed=s.moveParams.speed||r(80,140),s.vx=0,s.vy=0):"sentry"===s.moveType?(s.vx=r(-20,20),s.vy=r(-20,20)):"converge"===s.moveType&&(s.moveParams.speed=s.moveParams.speed||150);return"radial"===s.firePattern&&(s.fireParams.count=t?a(10,16):a(6,10),s.fireParams.offset=i()),l&&l.hpMult&&(s.hp=s.hp*l.hpMult|0,s.maxHp=s.hp),l&&l.spdMult&&(s.moveParams.speed=(s.moveParams.speed||100)*l.spdMult),s})}function Ze(e,l,t,r){let a=U.time+r,i=g(t,0,1),o=(60+8*d(6*a))*(.8+.25*i);R.save(),R.translate(e,l),R.rotate(1.2*a),R.beginPath(),R.arc(0,0,o+10,0,n),R.strokeStyle="rgba(138,93,255,"+.28*i+")",R.lineWidth=8,R.stroke(),R.beginPath(),R.arc(0,0,o,0,n),R.strokeStyle="rgba(210,170,255,"+.55*i+")",R.lineWidth=3,R.stroke();for(let e=0;e<8;e++){let l=n/8*e+.8*a;R.beginPath(),R.moveTo(.45*f(l)*o,.45*d(l)*o),R.lineTo(f(l)*(o+8),d(l)*(o+8)),R.strokeStyle="rgba(220,190,255,"+.35*i+")",R.lineWidth=1.4,R.stroke()}R.restore()}function Je(e,l,t){U.frozen&&!t||e.each(e=>{if("curve"===e.type&&e.curve){let t=c(e.vx**2+e.vy**2),r=p(e.vy,e.vx)+e.curve*l;e.vx=f(r)*t,e.vy=d(r)*t}if("loop"===e.type&&e.loopAmp){let l=(U.time-e.spawnTime)*(e.loopFreq||2.6),t=e.loopBaseAng,r=x(80,e.baseSpeed),a=d(l*n)*(e.loopAmp||120),i=f(t),o=d(t),s=-o,c=i;e.vx=i*r+s*a,e.vy=o*r+c*a}if("pulse"===e.type&&e.pulseAmp){let l=1-e.life/e.maxLife,t=e.baseSpeed*(1+d(l*e.pulseFreq*n)*e.pulseAmp),r=p(e.vy,e.vx);e.vx=f(r)*t,e.vy=d(r)*t}if(!t){if("gravity"===e.bossFx){let t=Ne.x-e.x,r=Ne.y-e.y,a=x(45,c(t*t+r*r)),i=e.bossFxPower||420;e.vx+=t/a*i*l,e.vy+=r/a*i*l}else if("speed_shift"===e.bossFx){let l=e.bossFxPower||1.6,t=e.bossFxFreq||7,r=e.bossFxPhase||0,a=e.baseSpeed*(1+d((U.time+e.spawnTime)*t+r)*l*.45),i=p(e.vy,e.vx);e.vx=f(i)*x(80,a),e.vy=d(i)*x(80,a)}else if("wind_shift"===e.bossFx){let t=e.bossFxSpin||0;if(t){let r=p(e.bossWindY,e.bossWindX)+l*t,a=c(e.bossWindX*e.bossWindX+e.bossWindY*e.bossWindY);e.bossWindX=f(r)*a,e.bossWindY=d(r)*a}e.vx+=e.bossWindX*l,e.vy+=e.bossWindY*l}else if("homing"===e.bossFx){let t=Ne.x-e.x,r=Ne.y-e.y;if(c(t*t+r*r)>(e.bossHomingStop||180)){let a=p(r,t),i=p(e.vy,e.vx),o=i+g(T(a-i),-(e.bossHomingTurn||3)*l,(e.bossHomingTurn||3)*l),s=x(90,c(e.vx*e.vx+e.vy*e.vy));e.vx=f(o)*s,e.vy=d(o)*s}}if(U.gravity){let t=Ne.x-e.x,r=Ne.y-e.y,a=x(50,c(t*t+r*r));e.vx+=t/a*U.gravity*l,e.vy+=r/a*U.gravity*l}if(U.pulseSpeed){let t=c(e.vx**2+e.vy**2)+U.pulseSpeed*l,r=p(e.vy,e.vx);e.vx=f(r)*t,e.vy=d(r)*t}U.echo&&!e.echoed&&(e.echoTimer+=l,e.echoTimer>.15&&(e.echoed=1,de.spawn(l=>{l.x=e.x,l.y=e.y,l.vx=.7*e.vx,l.vy=.7*e.vy,l.r=.7*e.r,l.color=e.color,l.type="normal",l.life=.5*e.life,l.maxLife=l.life,l.spawnTime=U.time,l.echoed=1,l.echoTimer=0,l.curve=0,l.pulseAmp=0,l.split=0,l.damage=1,l.baseSpeed=c(l.vx**2+l.vy**2)}))),e.vx+=U.windX*l*.5,e.vy+=U.windY*l*.5}if(e.x+=e.vx*l,e.y+=e.vy*l,e.life-=l*(U.fragile&&!t?1.45:1),U.mirror&&!t){let l=Ne.r+18;if(u(e.x,e.y,Ne.x,Ne.y)<l+e.r){let l=1.08*-e.vx,t=1.08*-e.vy,r=h(2,e.life+.4);return ce.spawn(a=>{a.x=e.x,a.y=e.y,a.vx=l,a.vy=t,a.r=x(2.5,.85*e.r),a.life=r,a.maxLife=r,a.type="normal",a.color="#9ff",a.spawnTime=U.time,a.damage=1,a.pierce=0,a.split=0,a.echoed=0,a.baseSpeed=c(l*l+t*t),a.curve=0,a.pulseAmp=0,a.src="mirror"}),e.active=0,void ge(e.x,e.y,"#aff",4,90)}}let r=(e=>{let l=m(e.x/Pe),t=m(e.y/Pe);for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){let i=Ee(l+r,t+a);for(let l=0;l<i.length;l++){let t=i[l];if("pillar"===t.type){if(u(e.x,e.y,t.x,t.y)<e.r+t.r)return t}else{let l=g(e.x,t.x,t.x+t.w),r=g(e.y,t.y,t.y+t.h);if(u(e.x,e.y,l,r)<e.r)return t}}}return null})(e);if(r)if(!U.bounce||t||e._bounced)e.active=0,ge(e.x,e.y,e.color,3,60);else{if(e._bounced=1,"wall"===r.type){let l=g(e.x,r.x,r.x+r.w),t=g(e.y,r.y,r.y+r.h),a=e.x-l,i=e.y-t;y(a)>y(i)?e.vx*=-.9:e.vy*=-.9}else{let l=e.x-r.x,t=e.y-r.y,a=x(1,c(l*l+t*t)),i=(e.vx*l+e.vy*t)/a;e.vx-=2*i*l/a,e.vy-=2*i*t/a}e.life*=.85,ge(e.x,e.y,"#fa8",3,70)}if(u(e.x,e.y,Ne.x,Ne.y)>1400&&(e.active=0),e.life<=0&&(e.active=0,e.split&&!t))for(let l=0;l<3;l++){let l=Math.random()*n;ze(e.x,e.y,100*f(l),100*d(l),2.5,e.color,"normal",1.5)}})}function el(e){e.each(e=>{let l=g(e.life/e.maxLife,0,1);R.save(),R.globalAlpha=l;let t="rocket"===e.src||"rocket_mini"===e.src?"rocket_mini"===e.src?"#fa0":"#f80":e.color;ee(e.x,e.y,e.r,t),e.bossFx&&"normal"!==e.bossFx&&(R.beginPath(),R.arc(e.x,e.y,e.r+2,0,n),R.strokeStyle="gravity"===e.bossFx?"#f8f":"speed_shift"===e.bossFx?"#ff8":"#8ff",R.lineWidth=1,R.globalAlpha=.4*l,R.stroke()),R.restore()})}var ll=(e,l)=>{for(let t in l)e[t]=l[t]},tl={dagger:e=>ll(e,{state:"idle",dx:0,dy:0,tx:0,ty:0,speed:800,dmg:4,idleTimer:0,spinTimer:0,spinR:25}),sword:e=>ll(e,{swingCD:0,lungeTimer:0,lungeDir:0,lungeDist:120,lungeStartX:0,lungeStartY:0,lungeProg:0}),bow:e=>ll(e,{charging:0,chargeTime:0,maxCharge:1.5,shotCD:0}),chain:e=>ll(e,{timer:.1,range:200,chains:4,stunDur:.3,dmg:5,_arcTimer:0,_targets:null}),rocket:e=>ll(e,{timer:.1,blastR:90,kbForce:250,lastFired:0}),mines:e=>ll(e,{timer:.2,placeCD:2.1,mineLife:7,mineR:48,damage:18,maxMines:3,_mines:[]}),shuriken:e=>ll(e,{timer:.1,count:1,markDur:3,markAmp:.3,bounces:2,_shurikens:[]}),drone:e=>ll(e,{timer:.1,_drones:[],droneCount:1,droneRange:150,silenceDur:1.5})};function rl(e){let l={id:e,lv:{a:0,b:0,c:0,d:0}},t=tl[e];return t&&t(l),l}var al={};for(let e of[["dagger","MAGIC DAGGER","#0ff","starter","Click to throw. Click again to redirect.","",[["a","PIERCING THROW",3,["+50% speed","90% + homing","120% + homing"]],["b","SPECTRAL COPY",3,["1 ghost 50% dmg","2 ghosts 60%","3 ghosts 75%"]],["d","DAGGER STORM",2,["0.8s +75% radius","1.2s +150% radius"]]]],["sword","PLASMA SWORD","#f0f","starter","Click to lunge-slash forward, cleaving enemies and bullets. i-frames during dash.","",[["a","LUNGE REACH",3,["+33% range","+67%","+108%"]],["b","WIDE CLEAVE",3,["+25% size","+50%","+88%"]],["c","EDGE CHARGE",2,["+15% length +2 dmg","+30% length +4 dmg"]],["d","PHASE TRAIL",2,["Afterimage trail +12% cleave","Trail +28% cleave, denser"]]]],["bow","VOLT BOW","#ff0","starter","Hold to charge, release a piercing beam.","",[["a","PRISM SPLIT",2,["1 side pair","2 side pairs"]],["b","QUICK DRAW",3,["1.0s charge","0.8s","0.6s"]],["c","PLASMA BURN",2,["Applies burn","Stronger burn"]]]],["chain","CHAIN LIGHTNING","#a0f","cc","Auto-zaps nearby bullets, chains between targets, and can leave stun fields.","BULLET CLEAR",[["a","EXTRA CHAINS",2,["+3 chains (7)","+3 (10)"]],["b","MULTI STRIKE",2,["2 bolts at once","3 bolts"]],["c","STATIC FIELD",2,["3s lingering stun zone","5s zone + wider"]]]],["rocket","ROCKET LAUNCHER","#f80","cc","Homing rockets explode for knockback and bullet clearing.","KNOCKBACK",[["a","CONCUSSIVE BLAST",3,["+60 knockback","+120 kb","+200 kb"]],["b","CLUSTER BOMB",2,["5 homing mini-rockets","7"]],["c","BLAST RADIUS",2,["+44% radius","+78% radius"]]]],["mines","LANDMINES","#7f7","cc","Auto-deploys proximity mines that detonate in an area and clear bullets.","AREA DENIAL",[["a","BLAST CHAMBER",2,["+35% blast radius","+70% blast radius"]],["b","RESERVE RACK",2,["+1 max mine","+2 max mines"]],["c","SHOCK FUSE",2,["Leaves short stun field","Longer field + larger radius"]]]],["shuriken","SHURIKEN","#bbb","cc","Bouncing shurikens mark enemies for bonus damage.","MARK",[["a","EXTRA SHURIKEN",2,["+1","+1 (3 total)"]],["b","DEEP MARK",2,["45% bonus dmg","60%"]],["c","EXT MARK",2,["5s","7s"]],["d","EXTRA BOUNCES",3,["+2 bounces (4)","+2 (6)","+2 (8)"]]]],["drone","PULSE DRONE","#0aa","cc","Drone silences enemies, slows bullets.","SILENCE",[["a","EXTRA DRONE",2,["+1 drone","+1 (3 total)"]],["b","EXT SILENCE",2,["2.5s","3.5s"]],["c","DISRUPTION",2,["20% slow","40%"]],["d","OVERDRIVE",2,["0.9s cd","0.7s"]]]]]){let l=[];for(let t=0;t<e[6].length;t++){let r=e[6][t];l.push({id:r[0],name:r[1],maxLv:r[2],desc:r[3]})}let t={name:e[1],color:e[2],type:e[3],desc:e[4],upgrades:l};e[5]&&(t.cc=e[5]),al[e[0]]=t}var il=["dagger","sword","bow"],ol=["chain","rocket","mines","shuriken","drone"];function sl(e){let l=null,t=null;for(let e=0;e<U.weapons.length;e++){let r=U.weapons[e];if("starter"===al[r.id].type){if(l){t=r;break}l=r}}return 0===e?l:2===e?t:null}function nl(e,l){if("flying"===e.state){let t=[1,1.5,1.9,2.2][e.lv.a],r=p(e.ty-e.dy,e.tx-e.dx),a=e.speed*t*l;u(e.dx,e.dy,e.tx,e.ty)<a+5?(e.dx=e.tx,e.dy=e.ty,e.lv.d>0?(e.state="spinning",e.spinTimer=[0,.8,1.2][e.lv.d],e.spinR=[0,35,50][e.lv.d]):(e.state="waiting",e.idleTimer=0)):(e.dx+=f(r)*a,e.dy+=d(r)*a),fl(e,e.dmg)}else if("spinning"===e.state)e.spinTimer-=l,e.angle=(e.angle||0)+15*l,((e,l)=>{he.each(t=>{t.active&&u(e.dx,e.dy,t.x,t.y)<e.spinR+t.r&&Kl(t,[0,3,4][e.lv.d]*l*10,"dagger")})})(e,l),e.spinTimer<=0&&(e.state="waiting",e.idleTimer=0);else if("waiting"===e.state)e.idleTimer+=l,e.idleTimer>2&&(e.state="returning");else if("returning"===e.state){let t=p(Ne.y-e.dy,Ne.x-e.dx),r=1.2*e.speed*l;e.dx+=f(t)*r,e.dy+=d(t)*r,fl(e,e.dmg),u(e.dx,e.dy,Ne.x,Ne.y)<20&&(e.state="idle")}else e.dx=Ne.x,e.dy=Ne.y;if(e.lv.b>0){let l=[0,1,2,3][e.lv.b];e._ghosts||(e._ghosts=[]),e._posHistory||(e._posHistory=[]),e._posHistory.push({x:e.dx,y:e.dy}),e._posHistory.length>30&&e._posHistory.shift(),e._ghosts=[];for(let t=0;t<l;t++){let l=x(0,e._posHistory.length-1-6*(t+1));e._ghosts.push({x:e._posHistory[l].x,y:e._posHistory[l].y})}}}function fl(e,l){if(he.each(t=>{t.active&&u(e.dx,e.dy,t.x,t.y)<t.r+8&&Kl(t,l,"dagger")}),e.lv.b>0&&e._ghosts){let t=l*[0,.5,.6,.75][e.lv.b];for(let l of e._ghosts)he.each(e=>{e.active&&u(l.x,l.y,e.x,e.y)<e.r+8&&Kl(e,t,"dagger_ghost")})}}function dl(e){let l=e.dx||Ne.x,t=e.dy||Ne.y;if("idle"===e.state){let e=Ne.angle,l=Ne.x+18*f(e),t=Ne.y+18*d(e);le([{x:l+8*f(e),y:t+8*d(e)},{x:l+5*f(e+2.3),y:t+5*d(e+2.3)},{x:l+5*f(e-2.3),y:t+5*d(e-2.3)}],"#0ff",1,3)}else{let r="spinning"===e.state?e.angle||0:p(e.dy-("returning"===e.state?Ne.y:e.ty),e.dx-("returning"===e.state?Ne.x:e.tx))+s;if(le([{x:l+10*f(r),y:t+10*d(r)},{x:l+6*f(r+2.3),y:t+6*d(r+2.3)},{x:l+6*f(r-2.3),y:t+6*d(r-2.3)}],"#0ff",1,4),"spinning"===e.state&&ie(l,t,e.spinR,0,n,"#0ff",1),e.lv.b>0&&e._ghosts&&"idle"!==e.state)for(let l=0;l<e._ghosts.length;l++){let t=e._ghosts[l],r="spinning"===e.state?e.angle||0:p(e.dy-t.y,e.dx-t.x);R.save(),R.globalAlpha=.35-.08*l,le([{x:t.x+10*f(r),y:t.y+10*d(r)},{x:t.x+6*f(r+2.3),y:t.y+6*d(r+2.3)},{x:t.x+6*f(r-2.3),y:t.y+6*d(r-2.3)}],"#0ff",1,3),R.restore()}}}function cl(e,l){if(e.swingCD=x(0,e.swingCD-l),e.lungeTimer>0){e.lungeTimer-=l;let t=.18;e.lungeProg=g(1-e.lungeTimer/t,0,1);let r=e.lungeDist,a=[35,50,60,75][e.lv.b],i=e.lungeStartX+f(e.lungeDir)*r*e.lungeProg,o=e.lungeStartY+d(e.lungeDir)*r*e.lungeProg;Ne.x=i,Ne.y=o,Ne.invuln=x(Ne.invuln,.25),Ne.swordIFrame=x(Ne.swordIFrame,.25);let s=8+[0,2,4][e.lv.c],n=70*(1+[0,.15,.3][e.lv.c]);if(he.each(l=>{if(!l.active)return;let t=l.x-i,r=l.y-o,c=f(e.lungeDir),h=d(e.lungeDir),x=t*c+r*h;x<-15-l.r||x>n+l.r||y(t*-h+r*c)<a+l.r&&(!l._swordHitT||U.time-l._swordHitT>.15)&&(l._swordHitT=U.time,Kl(l,s,"sword",0),$(2))}),de.each(l=>{if(!l.active)return;let t=l.x-i,r=l.y-o,s=f(e.lungeDir),c=d(e.lungeDir),h=t*s+r*c;h<-15-l.r||h>n+l.r||y(t*-c+r*s)<a+l.r&&(l.active=0,ge(l.x,l.y,"#f0f",3,80))}),e.lv.d>0&&(e._aftershockEnd={x:i,y:o,w:a}),e.lungeTimer<=0){e.lungeTimer=0,e.lungeProg=0;let l=g(0|e.lv.d,0,2);if(l>0&&e._aftershockEnd){let t=[0,2,3][l],r=[0,1.8,2.5][l];((e,l,t,r,a,i,o)=>{if(be.length>=18)return;let s=x(.4,o||1),n=x(6,a||40),f=x(1,i||1);be.push({x1:e,y1:l,x2:t,y2:r,width:n,dmg:f,life:s,maxLife:s,tickT:0})})(e.lungeStartX,e.lungeStartY,e._aftershockEnd.x,e._aftershockEnd.y,1.1*e._aftershockEnd.w,t,r)}e._aftershockEnd=null,ge(Ne.x,Ne.y,"#f0f",8,120),$(4)}}}function yl(e){let l=60*(1+[0,.15,.3][e.lv.c]),r=e.lungeTimer>0?e.lungeDir:Ne.angle,a=r+s/2;if(e.lungeTimer>0){let{lungeProg:i,lungeDist:o}=e,n=[35,50,60,75][e.lv.b],c=e.lungeStartX,y=e.lungeStartY,h=c+f(r)*o*i,p=y+d(r)*o*i,m=.65*n,g=1.05*n,u=x(8,.2*n);R.save();let b=R.createLinearGradient(c,y,h,p);b.addColorStop(0,"rgba(255,120,255,0)"),b.addColorStop(.35,"rgba(255,120,255,.08)"),b.addColorStop(1,"rgba(255,180,255,.18)"),R.beginPath(),R.moveTo(c+f(a)*m,y+d(a)*m),R.quadraticCurveTo(.5*(c+h)+f(a)*u,.5*(y+p)+d(a)*u,h+f(a)*g,p+d(a)*g),R.lineTo(h-f(a)*g,p-d(a)*g),R.quadraticCurveTo(.5*(c+h)-f(a)*u,.5*(y+p)-d(a)*u,c-f(a)*m,y-d(a)*m),R.closePath(),R.fillStyle=b,R.globalAlpha=1,R.fill(),R.strokeStyle="rgba(255,120,255,.24)",R.lineWidth=1.2,R.stroke(),R.restore(),R.save();for(let e=0;e<5;e++){let l=e/5,t=v(c,h,l),i=v(y,p,l),o=(e%2==0?1:-1)*n*.5;R.beginPath(),R.moveTo(t+f(a)*o,i+d(a)*o),R.lineTo(t+f(a)*o-15*f(r),i+d(a)*o-15*d(r)),R.strokeStyle="#f0f",R.lineWidth=1.5,R.globalAlpha=.25*(1-l),R.stroke()}R.restore();let T=r+(-s/2+s*i),w=T+s/2,S=Ne.x+10*f(T),k=Ne.y+10*d(T),_=Ne.x+f(T)*(10+l),A=Ne.y+d(T)*(10+l);le([{x:S+4*f(w),y:k+4*d(w)},{x:S-4*f(w),y:k-4*d(w)},{x:_-1.5*f(w),y:A-1.5*d(w)},{x:_+6*f(T),y:A+6*d(T)},{x:_+1.5*f(w),y:A+1.5*d(w)}],"#f0f",1,5),R.save(),R.lineCap=t;let P=7;for(let e=1;e<=P;e++){let t=x(0,i-.05*e),a=r+(-s/2+s*t),o=1-e/P,n=2.2*d(20*U.time+.9*e)*o,c=f(a+s/2),y=d(a+s/2),h=Ne.x+10*f(a)+c*n,p=Ne.y+10*d(a)+y*n,m=Ne.x+f(a)*(10+l)+c*n*1.4,g=Ne.y+d(a)*(10+l)+y*n*1.4,v=.5*(h+m)+c*(6+2*o),u=.5*(p+g)+y*(6+2*o),b=R.createLinearGradient(h,p,m,g);b.addColorStop(0,"rgba(255,120,255,0)"),b.addColorStop(.35,"rgba(255,120,255,"+(.08+.15*o)+")"),b.addColorStop(1,"rgba(255,255,255,"+(.05+.15*o)+")"),R.strokeStyle=b,R.lineWidth=2.2+3.4*o,R.beginPath(),R.moveTo(h,p),R.quadraticCurveTo(v,u,m,g),R.stroke()}R.restore()}else{let e=Ne.x+14*f(r),t=Ne.y+14*d(r),i=Ne.x+f(r)*(14+.7*l),o=Ne.y+d(r)*(14+.7*l);le([{x:e+2.5*f(a),y:t+2.5*d(a)},{x:e-2.5*f(a),y:t-2.5*d(a)},{x:i-1*f(a),y:o-1*d(a)},{x:i+4*f(r),y:o+4*d(r)},{x:i+1*f(a),y:o+1*d(a)}],"#f0f",1,2)}}function hl(e,l){e.shotCD=x(0,e.shotCD-l);let t=[1.5,1,.8,.6][e.lv.b];e.maxCharge=t,e.charging&&(e.chargeTime=h(e.chargeTime+l,t))}function xl(e){if(e.charging){let l=g(e.chargeTime/e.maxCharge,0,1),t=18+10*l,r=Ne.angle,a=Ne.x+f(r)*(t+2),i=Ne.y+d(r)*(t+2),o=r+s/2;R.save();let n=a+f(r)*(5+3*l),c=i+d(r)*(5+3*l),y=a+f(o)*(2+1.5*l),h=i+d(o)*(2+1.5*l),x=a-f(o)*(2+1.5*l),p=i-d(o)*(2+1.5*l);R.beginPath(),R.moveTo(n,c),R.lineTo(y,h),R.lineTo(x,p),R.closePath(),R.fillStyle="#ff0",R.globalAlpha=.35+.4*l,R.shadowColor="#ff0",R.shadowBlur=8+10*l,R.fill(),oe(Ne.x,Ne.y,t,"#ffd84a",1.2+1.2*l,.3+.5*l),oe(Ne.x,Ne.y,.55*t,"#fff",.9+.9*l,.25+.45*l),R.restore()}}function pl(e,l,t,r){let a=null,i=void 0===t?1/0:t;return he.each(t=>{if(!t.active)return;if(r&&(r.has?r.has(t):r(t)))return;let o=u(e,l,t.x,t.y);o<i&&(i=o,a=t)}),a}function ml(e,l,t,r,a){let i=null,o=void 0===t?1/0:t;return de.each(t=>{if(!t.active)return;if(r&&(r.has?r.has(t):r(t)))return;if(a&&(a.has?a.has(t):a(t)))return;let s=u(e,l,t.x,t.y);s<o&&(o=s,i=t)}),i}function gl(e,l){if((e=>{let l=window._staticFields;for(let t=l.length-1;t>=0;t--){let r=l[t];r.life-=e,r.x+=r.vx*e,r.y+=r.vy*e,r.vx*=.95,r.vy*=.95,r.vx+=40*(Math.random()-.5)*e,r.vy+=40*(Math.random()-.5)*e,r.life<=0?l.splice(t,1):(r._checkT=(r._checkT||0)-e,r._checkT>0||(r._checkT=.2,he.each(e=>{if(e.active&&u(r.x,r.y,e.x,e.y)<e.r+8){if(U.time-(e._lastStaticStun||0)<3)return;let l=e.isBoss?.2:1;e.cc.stunT=x(e.cc.stunT,r.stunDur*l),e._lastStaticStun=U.time}})))}})(l),e.timer-=l*(1-V.cdReduction),e.timer<=0){let l=e.range,t=e.chains+[0,3,3][e.lv.a],r=[1,2,3][e.lv.b]||1,a=e.lv.c;if(!ml(Ne.x,Ne.y,l))return;e.timer=.8,e._zigzags=[],e._targets=[];let i=new Set;for(let o=0;o<r;o++){let s=new Set,c=[],y=Ne.x,h=Ne.y;if(o>0){let e=n/r*o;y=Ne.x+15*f(e),h=Ne.y+15*d(e)}for(let e=0;e<t;e++){let t=ml(y,h,l+(e>0?100:0),s,i);if(!t)break;if(s.add(t),i.add(t),c.push({x:t.x,y:t.y}),ge(t.x,t.y,"#a0f",3,80),t.active=0,a>0){let e=[0,3,5][a],l=[0,25,40][a];ul(t.x,t.y,e,l)}y=t.x,h=t.y}let x=o>0?Ne.x+15*f(n/r*o):Ne.x,p=o>0?Ne.y+15*d(n/r*o):Ne.y;for(let l of c){let t=bl(x,p,l.x,l.y,8);e._zigzags.push(t),e._targets.push(l),x=l.x,p=l.y}}e._arcTimer=.45}e._arcTimer>0&&(e._arcTimer-=l)}window._staticFields||(window._staticFields=[]);var vl=200;function ul(e,l,t,r){if(window._staticFields.length>=vl)return;let a=3+Math.floor(3*Math.random());for(let i=0;i<a&&!(window._staticFields.length>=vl);i++){let a=Math.random()*n,i=Math.random()*r;window._staticFields.push({x:e+f(a)*i,y:l+d(a)*i,life:t,maxLife:t,r:r,stunDur:.15,vx:20*(Math.random()-.5),vy:20*(Math.random()-.5),size:2+3*Math.random()})}}function bl(e,l,t,r,a){let i=[{x:e,y:l}],o=t-e,s=r-l,n=c(o*o+s*s),f=-s/n,d=o/n;for(let t=1;t<a;t++){let r=t/a,c=e+o*r,y=l+s*r,h=(Math.random()-.5)*n*.18;i.push({x:c+f*h,y:y+d*h})}return i.push({x:t,y:r}),i}function Tl(e){if(e._arcTimer>0&&e._zigzags){let l=g(e._arcTimer/.45,0,1),t=(e,l,t,r,a)=>{R.beginPath(),R.moveTo(e[0].x,e[0].y);for(let l=1;l<e.length;l++)R.lineTo(e[l].x,e[l].y);R.strokeStyle=l,R.lineWidth=t,R.globalAlpha=r,R.shadowColor=l,R.shadowBlur=a,R.stroke()};R.save();for(let r of e._zigzags){t(r,"#a0f",6,.25*l,15),t(r,"#c6f",3,.6*l,8),t(r,"#eaf",1.5,l,4);let e=r[r.length-1];R.beginPath(),R.arc(e.x,e.y,4*l,0,n),R.fillStyle="#fff",R.globalAlpha=.8*l,R.shadowBlur=10,R.fill()}R.restore()}}function wl(e,l){if(e.timer-=l*(1-V.cdReduction),e.timer<=0){e.timer=2.2;let l=pl(Ne.x,Ne.y,9999),t=l?p(l.y-Ne.y,l.x-Ne.x):Ne.angle,r=350;ce.spawn(e=>{e.x=Ne.x+16*f(t),e.y=Ne.y+16*d(t),e.vx=f(t)*r,e.vy=d(t)*r,e.r=6,e.life=5,e.maxLife=5,e.type="normal",e.color="#f80",e.spawnTime=U.time,e.damage=0,e.pierce=0,e.split=0,e.echoed=0,e.baseSpeed=r,e.curve=0,e.pulseAmp=0,e.src="rocket",e._homing=1,e._homingDelay=0}),e.lastFired=U.time}ce.each(e=>{if(!e.active||"rocket"!==e.src&&"rocket_mini"!==e.src||!e._homing)return;if(e._homingDelay>0)return void(e._homingDelay-=l);let t=pl(e.x,e.y,800);if(t){let r="rocket_mini"===e.src?4:3.5,a=((e,l,t,r,a,i,o,s)=>{let n=p(r-i,t-a),y=p(l,e),h=y+g(T(n-y),-o*s,o*s),x=c(e*e+l*l);return{vx:f(h)*x,vy:d(h)*x}})(e.vx,e.vy,t.x,t.y,e.x,e.y,r,l);e.vx=a.vx,e.vy=a.vy}})}function Sl(e){}function kl(e,l){e._mines||(e._mines=[]);let t=e.maxMines+[0,1,2][e.lv.b],r=e.mineR*(1+[0,.35,.7][e.lv.a]),a=e.damage+[0,6,12][e.lv.a],i=x(.55,e.placeCD*(1-V.cdReduction));if(e.timer-=l,e.timer<=0&&e._mines.length<t){let l=Ne.x+34*f(Ne.angle),t=Ne.y+34*d(Ne.angle),a=pl(Ne.x,Ne.y,330);if(a){let e=p(a.y-Ne.y,a.x-Ne.x),r=h(160,.5*u(Ne.x,Ne.y,a.x,a.y)+24);l=Ne.x+f(e)*r,t=Ne.y+d(e)*r}e._mines.push({x:l,y:t,r:r,life:e.mineLife,maxLife:e.mineLife,arm:.32,pulse:Math.random()*n}),e.timer=i}for(let t=e._mines.length-1;t>=0;t--){let r=e._mines[t];if(r.life-=l,r.arm=x(0,r.arm-l),r.pulse+=7*l,r.life<=0){e._mines.splice(t,1);continue}if(r.arm>0)continue;let i=0;he.each(e=>{!i&&e.active&&u(r.x,r.y,e.x,e.y)<r.r+e.r&&(i=1)}),i&&(ge(r.x,r.y,"#7f7",22,220),ge(r.x,r.y,"#fff",10,160),$(7),de.each(e=>{e.active&&u(r.x,r.y,e.x,e.y)<r.r&&(e.active=0,ge(e.x,e.y,"#7f7",2,80))}),he.each(l=>{if(!l.active)return;let t=u(r.x,r.y,l.x,l.y);if(t<r.r+l.r){Kl(l,a,"mines");let i=l.isBoss?.4:1,o=130*(1-t/(r.r+l.r)),s=p(l.y-r.y,l.x-r.x);l.cc.kbVx+=f(s)*o*i,l.cc.kbVy+=d(s)*o*i,e.lv.c>0&&(l.cc.stunT=x(l.cc.stunT,[0,.2,.32][e.lv.c]*(l.isBoss?.25:1)))}}),e.lv.c>0&&ul(r.x,r.y,[0,1.6,2.7][e.lv.c],[0,24,36][e.lv.c]),e._mines.splice(t,1))}}function _l(e){if(e._mines)for(let l=0;l<e._mines.length;l++){let t=e._mines[l],r=g(t.life/t.maxLife,0,1),a=.55+.45*d(t.pulse),i=6+2.5*a;R.save(),oe(t.x,t.y,t.r,"#7f7",1,.18*r),R.beginPath(),R.arc(t.x,t.y,i,0,n),R.fillStyle="#7f7",R.globalAlpha=.55+.25*a,R.fill(),R.beginPath(),R.arc(t.x,t.y,2.5+a,0,n),R.fillStyle="#fff",R.globalAlpha=.5*r,R.fill(),t.arm>0&&oe(t.x,t.y,i+t.arm/.32*4,"#fff",1.2,.3),R.restore()}}function Al(e,l){let t=e.droneCount+[0,1,2][e.lv.a],r=e.droneRange,a=[1.5,2.5,3.5][e.lv.b],i=[0,.2,.4][e.lv.c]||0,o=[1.5,.9,.7][e.lv.d]||1.5;for(;e._drones.length<t;)e._drones.push({angle:n/t*e._drones.length,orbitR:60+15*e._drones.length,pulseT:0,x:Ne.x,y:Ne.y});for(let t=0;t<e._drones.length;t++){let s=e._drones[t];s.x||(s.x=Ne.x),s.y||(s.y=Ne.y),s.pulseT=x(0,s.pulseT-l);let n=pl(s.x,s.y,400),y=80;if(n){let e=p(n.y-s.y,n.x-s.x);s.x+=f(e)*y*l,s.y+=d(e)*y*l}else{s.angle+=l*(2.5-.3*t);let e=Ne.x+f(s.angle)*s.orbitR,r=Ne.y+d(s.angle)*s.orbitR;s.x=v(s.x,e,4*l),s.y=v(s.y,r,4*l)}let h=u(s.x,s.y,Ne.x,Ne.y);if(h>250){let e=p(Ne.y-s.y,Ne.x-s.x);s.x+=f(e)*(h-250)*3*l,s.y+=d(e)*(h-250)*3*l}if(de.each(e=>{if(e.active&&u(s.x,s.y,e.x,e.y)<r){let t=c(e.vx*e.vx+e.vy*e.vy);if(t>50){let r=p(e.vy,e.vx),a=t*(1-.4*3*l);e.vx=f(r)*a,e.vy=d(r)*a}}}),s._fireT=(s._fireT||0)-l*(1-V.cdReduction),s._fireT<=0){s._fireT=o;let e=pl(s.x,s.y,r+80);if(e&&u(s.x,s.y,e.x,e.y)<r+e.r){let l=e.isBoss?.3:1;e.isBoss||(e.cc.silenceT=x(e.cc.silenceT,a*l)),i>0&&(e.cc.slowAmt=x(e.cc.slowAmt,i),e.cc.slowT=x(e.cc.slowT,a*l)),Kl(e,1,"drone"),s.pulseT=.3,ge(s.x,s.y,"#0aa",5,80)}}}e.timer=e._drones[0]?e._drones[0]._fireT:0}function Pl(e){for(let l of e._drones){R.save();let t=l.pulseT>0?1+2*l.pulseT:1;if(R.beginPath(),R.arc(l.x,l.y,6*t,0,n),R.fillStyle="#0aa",R.globalAlpha=.6,R.fill(),oe(l.x,l.y,6*t,"#0ff",1.5,.8),R.beginPath(),R.arc(l.x,l.y,3*t,0,n),R.fillStyle="#fff",R.globalAlpha=.5,R.fill(),oe(l.x,l.y,e.droneRange,"#0aa",.5,.1),l.pulseT>0){let t=e.droneRange*(1-l.pulseT/.3);oe(l.x,l.y,t,"#0ff",2,l.pulseT/.3*.4)}R.restore()}}function Cl(e,l){let t=e.count+[0,1,2][e.lv.a],r=[.3,.45,.6][e.lv.b],a=[3,5,7][e.lv.c],i=e.bounces+[0,2,2,2][e.lv.d];if(e.timer-=l*(1-V.cdReduction),e.timer<=0){e.timer=1.2;for(let l=0;l<t;l++){let l=null,t=1/0;if(he.each(r=>{if(!r.active)return;let a=u(Ne.x,Ne.y,r.x,r.y);e._shurikens.some(e=>e.target===r)&&l||a<t&&(t=a,l=r)}),!l)break;let o=p(l.y-Ne.y,l.x-Ne.x);e._shurikens.push({x:Ne.x,y:Ne.y,vx:1400*f(o),vy:1400*d(o),target:l,life:4,markAmp:r,markDur:a,angle:0,bouncesLeft:i,hitSet:new Set})}}for(let t=e._shurikens.length-1;t>=0;t--){let r=e._shurikens[t];if(r.life-=l,r.angle+=12*l,r.life<=0)e._shurikens.splice(t,1);else{if(r.target&&r.target.active){let e=p(r.target.y-r.y,r.target.x-r.x),t=p(r.vy,r.vx),a=t+g(T(e-t),-12*l,12*l),i=c(r.vx*r.vx+r.vy*r.vy);r.vx=f(a)*i,r.vy=d(a)*i}else{let e=null,l=1/0;he.each(t=>{if(!t.active||r.hitSet.has(t))return;let a=u(r.x,r.y,t.x,t.y);a<l&&(l=a,e=t)}),e&&(r.target=e)}r.x+=r.vx*l,r.y+=r.vy*l,he.each(l=>{if(l.active&&!r.hitSet.has(l)&&u(r.x,r.y,l.x,l.y)<l.r+6){r.hitSet.add(l);let a=l.isBoss?.4:1;if(l.cc.markT=x(l.cc.markT,r.markDur*a),l.cc.markAmp=x(l.cc.markAmp,r.markAmp),Kl(l,1,"shuriken"),ge(r.x,r.y,"#bbb",5,80),r.bouncesLeft>0){r.bouncesLeft--;let l=null,a=1/0;if(he.each(e=>{if(!e.active||r.hitSet.has(e))return;let t=u(r.x,r.y,e.x,e.y);t<a&&(a=t,l=e)}),l){r.target=l;let e=p(l.y-r.y,l.x-r.x),t=c(r.vx*r.vx+r.vy*r.vy);r.vx=f(e)*t,r.vy=d(e)*t,r.life=x(r.life,2)}else e._shurikens.splice(t,1)}else e._shurikens.splice(t,1)}})}}}function Rl(e){for(let l of e._shurikens){R.save(),R.translate(l.x,l.y),R.rotate(l.angle),R.beginPath();for(let e=0;e<4;e++){let l=n/4*e;R.moveTo(0,0),R.lineTo(8*f(l),8*d(l)),R.lineTo(4*f(l+.4),4*d(l+.4))}R.strokeStyle="#bbb",R.lineWidth=2,R.globalAlpha=.8,R.stroke(),R.beginPath(),R.arc(0,0,2,0,n),R.fillStyle="#fff",R.fill(),R.restore()}}var El=[["regen","REGENERATION","#4f4",3,["Heal 1HP/14s","1HP/8s","1HP/8s + emergency heal"]],["speed","SPEED BOOST","#4f4",3,["+15% speed","+30%","+40% + 8% dodge"]],["cooldown","COOLDOWN REDUCTION","#48f",3,["-12% all CDs","-20%","-25% + faster weapons"]],["damage","POWER SURGE","#f44",2,["+30% damage","+50% damage"]]],Il={};for(let e=0;e<El.length;e++){let l=El[e];Il[l[0]]={name:l[1],color:l[2],maxLv:l[3],desc:l[4]}}var Dl=El.map(e=>e[0]),Fl=["#f66","#f8c","#c8f","#8cf","#a0f","#ff8"],Ll=["circle","square","triangle"],Ml=[1,2,4,8,16],Bl=[1,8,16,2],Wl=[0,1,2,3,4,5],Hl=["Void","Astral","Iron","Crimson","Aether","Obsidian","Radiant","Grim"],Nl=["Warden","Revenant","Harbinger","Sentinel","Seraph","Tyrant","Overseer","Monarch"],Ol=["Prime","Ascendant","Omega","the Hollow","the Unbound","of Ruin","of Echoes","Mk-II"],Ul=[e=>{Ve.bossRadial(e)},e=>{Ve.bossWall(e)},e=>{for(let l=0;l<5;l++){let t=e.angle+n/5*l;Ke(e.x,e.y,205*f(t),205*d(t),4,e.color,"loop",3.4,{loopAmp:160,loopFreq:1.15,loopBaseAng:t})}},e=>{let l=p(Ne.y-e.y,Ne.x-e.x);for(let t=-3;t<=3;t++)Ke(e.x,e.y,220*f(l+.11*t),220*d(l+.11*t),4,e.color,"normal",2.6)},(e,l)=>{l.laserSpin+=.36;let t=l.enraged?5:3;for(let r=0;r<t;r++)Ae({owner:e,angle:l.laserSpin+n/t*r,length:1.9*x(S,k),width:l.enraged?28:22,life:l.enraged?2.1:1.8,color:e.color,rotSpeed:l.enraged?.75:.45,warn:l.enraged?1.15:1,warnColor:"#ff9f66"})},(e,l)=>{if(l._dashStrike)return;let t=p(Ne.y-e.y,Ne.x-e.x),r=g(u(e.x,e.y,Ne.x,Ne.y)+52+(l.enraged?20:0),180,360);l._dashStrike={phase:"tele",t:1,maxT:1,sx:e.x,sy:e.y,ex:e.x+f(t)*r,ey:e.y+d(t)*r,a:t,burst:0},ge(e.x,e.y,e.color,8,130)}];function Xl(e,l,t){let r=i()+t*s,a=x(_,A)+100;e.x=Ne.x+f(r)*a,e.y=Ne.y+d(r)*a,e.shape=l.shape,e.color=w(l.color),e.tier="boss",e.isBoss=1,e.bossKind="generated",e.bossShape=l.shape,e.bossAccessory=l.accessory,e.bossName=l.name,e.bossMods=l.mods,e.bossAttacks=l.attacks,e.r=l.r,e.hp=l.hp,e.maxHp=l.hp,e.fireCD=l.fireCD,e.fireTimer=.45+.2*t,e.hitFlash=0,e.angle=0,e.spawnTime=U.time,e.moveParams={speed:l.moveSpeed},e.fireParams={count:10,offset:0},e.cc={stunT:0,silenceT:0,rootT:0,slowAmt:0,slowT:0,fearT:0,markT:0,markAmp:0,kbVx:0,kbVy:0,disorientT:0,bleedDmg:0,bleedT:0},e.shieldHP=0,e._dashInvuln=0,e._role=4&l.mods&&1===t?"melee":"ranged",e._twinIdx=t,e._twinPartner=null,e.moveType="chaser",e.firePattern="bossAimed"}function Yl(e){return{timer:0,attackIdx:0,laserSpin:i(),shieldNodes:[],enraged:0,linkBeam:0,linkTimer:0,dashTimer:0,warpTimer:0,warpCD:3,_portals:[],_warpTele:null,_dashStrike:null,summonTimer:0,update(l,t){if(this.timer+=t,l.angle+=t*(this.enraged?1.8:1.1),this._dashStrike){let e=this._dashStrike;if("tele"===e.phase)e.t-=t,l._dashInvuln=x(l._dashInvuln,.1),l._dashTele={t:e.t,maxT:e.maxT,tx:e.ex,ty:e.ey},e.t<=0&&(e.phase="dash",e.t=.32,e.maxT=.32,e.sx=l.x,e.sy=l.y,l._dashTele=null);else{e.t-=t;let r=g(1-e.t/e.maxT,0,1),a=1-(1-r)*(1-r);if(l.x=v(e.sx,e.ex,a),l.y=v(e.sy,e.ey,a),l._dashInvuln=x(l._dashInvuln,.3),(45*this.timer|0)%2==0&&ge(l.x,l.y,l.color,2,70),e.t<=0){if(l.x=e.ex,l.y=e.ey,!e.burst){e.burst=1,ge(l.x,l.y,l.color,10,160);for(let t=0;t<10;t++){let r=n/10*t+.35*e.a;Ke(l.x,l.y,230*f(r),230*d(r),4,l.color,"normal",.9)}}this._dashStrike=null}}return}let a=p(Ne.y-l.y,Ne.x-l.x),o=u(l.x,l.y,Ne.x,Ne.y),c=l.moveParams.speed;if("melee"===l._role)if(o>195+20*l._twinIdx)l.x+=f(a)*c*t,l.y+=d(a)*c*t;else{let e=a+(0===l._twinIdx?s/2:-s/2);l.x+=f(e)*c*.7*t,l.y+=d(e)*c*.7*t}else l.x+=f(a)*c*.35*t,l.y+=d(a)*c*.35*t;if(1&e.mods&&l.hp<.6*l.maxHp&&0===this.shieldNodes.length){for(let e=0;e<4;e++)this.shieldNodes.push({angle:n/4*e,hp:12,lastHit:U.time});U.bannerTimer=.9,U.bannerText="BOSS SHIELD NODES",U.bannerColor=l.color,U.waveModTimer=4,U.waveModText="SHIELD NODES: break the glowing hex shields around the boss. Boss is invincible until all are destroyed."}for(let e of this.shieldNodes)e.angle+=.7*t;if(2&e.mods&&l.hp<.35*l.maxHp&&!this.enraged&&(this.enraged=1,l.fireCD*=.72,l._baseColor||(l._baseColor=l.color),l.color="#f33",U.bannerTimer=1.1,U.bannerText="BOSS ENRAGED",U.bannerColor=l.color),4&e.mods&&(this.linkTimer+=t,this.linkBeam=this.linkTimer%3.6<2.2),8&e.mods)if(this._warpTele){if(this._warpTele.t-=t,this._warpTele.t<=0){let e=this._warpTele;this._warpTele=null;let{x:t,y:r}=l;l.x=e.toX,l.y=e.toY;for(let e=0;e<8;e++){let a=n/8*e;Ke(t,r,150*f(a),150*d(a),4,l.color,"normal",2.8)}this._portals.push({x1:t,y1:r,x2:e.toX,y2:e.toY,life:.25}),ge(t,r,l.color,10,120),ge(e.toX,e.toY,l.color,10,120)}}else if(this.warpTimer+=t,this.warpTimer>this.warpCD){this.warpTimer=0;let e=i(),l=r(120,240);this._warpTele={toX:Ne.x+f(e)*l,toY:Ne.y+d(e)*l,t:1,maxT:1}}for(let e=this._portals.length-1;e>=0;e--)this._portals[e].life-=t,this._portals[e].life<=0&&this._portals.splice(e,1);if(16&e.mods&&"encounter"===U.waveState&&(this.summonTimer+=t,this.summonTimer>(this.enraged?6:8))){this.summonTimer=0;let e=this.enraged?2:1;for(let t=0;t<e;t++){let e=i(),t=r(90,170);$e("small",{x:l.x+f(e)*t,y:l.y+d(e)*t,moveType:"converge",moveParams:{speed:145},hpMult:1.1,fireMult:1.2,color:l.color})}}},fire(l){if("melee"===l._role)return;let t=e.attacks[this.attackIdx%e.attacks.length];this.attackIdx++;let r=Ul[t];if(r&&r(l,this),8&e.mods&&this._portals.length&&4!==t)for(let e of this._portals)for(let t=0;t<5;t++){let r=n/5*t;Ke(e.x1,e.y1,130*f(r),130*d(r),3.5,l.color,"curve",2.6,{curve:.3})}}}}var Vl=0;function zl(){var e;U.wave++,U.waveKills=0,U.waveQuota=h(16,4+2*U.wave),U.difficulty=.8+.5*U.wave+U.wave*U.wave*.02,U.waveState="spawning",Ue&&Ue.unapply(),e=(()=>{let e,l=0;do{e=a(0,Oe.length-1),l++}while(e===Xe&&l<10);return Xe=e,e})(),Ue&&Ue.unapply(),U.wavePhaseIdx=e,(Ue=Oe[e]).apply(),U.waveBannerTimer=2,U.waveBannerText="WAVE "+U.wave,U.waveBannerSub=Ue?Ue.name:"",U.waveModTimer=3,U.waveModText=Ue?Ue.desc:""}function Kl(e,l,t,r){if(!e.active)return;if(e._dashInvuln>0)return;let a=l,i="shuriken"===t;i&&(a=1),!i&&e.cc.markAmp>0&&(a*=1+e.cc.markAmp);let o=r||0,s=V.critChance+(U.lucky?.08:0);if(!i&&!o&&s>0&&Math.random()<s&&(o=1,a*=V.critMult),i||(a*=V.dmgMult),!i&&e.cc.markT>0&&(a*=1+e.cc.markAmp),e.isBoss&&e.bossAI&&e.bossAI.shieldNodes&&e.bossAI.shieldNodes.some(e=>e.hp>0)){let l=null,t=1/0,r=0,i=0;for(let r of e.bossAI.shieldNodes)r.hp<=0||r.hp<t&&(t=r.hp,l=r);if(l){r=e.x+f(l.angle)*(e.r+24),i=e.y+d(l.angle)*(e.r+24);let t=x(1,.9*a);l.hp=x(0,l.hp-t),l.lastHit=U.time,ge(r,i,"#9ef",8,140),pe(r,i,0|t,0),e.bossAI.shieldNodes.some(e=>e.hp>0)||(U.bannerTimer=1.2,U.bannerText="SHIELD BROKEN",U.bannerColor="#9ef")}return}e.hp-=a,e.hitFlash=1,pe(e.x,e.y,0|a,o),ge(e.x,e.y,e.color,3,80),e.hp<=0&&ql(e)}function ql(e){if(!e.active)return;e.active=0;let l=(e.isBoss?450:"elite"===e.tier?55:15)*V.xpMult*(U.lucky?1.25:1);for(U.xp+=l;U.xp>=U.xpToNext&&U.xpToNext>0;)U.xp-=U.xpToNext,U.level++,U.xpToNext=m(.64*(100+100*U.level)),U.levelUpQueue++;if(U.totalKills++,U.waveKills++,(e.isBoss||"elite"===e.tier)&&(U.killFlash=.05),"circle"===e.shape)for(let l=0;l<12;l++){let t=n/12*l;me(e.x,e.y,200*f(t),200*d(t),e.color,.3,2)}else if("square"===e.shape)for(let l=0;l<8;l++){let t=s/4+n/8*l;me(e.x+f(t)*e.r,e.y+d(t)*e.r,150*f(t),150*d(t),e.color,.3,3)}else for(let l=0;l<3;l++){let t=n/3*l;for(let l=0;l<4;l++)me(e.x,e.y,f(t+r(-.3,.3))*(100+50*l),d(t+r(-.3,.3))*(100+50*l),e.color,.3,2)}if(e.isBoss)if(ge(e.x,e.y,"#fff",40,300),ge(e.x,e.y,e.color,30,250),$(15),Z(.5,.3),U._twinBoss&&void 0!==e._twinIdx){let l=e._twinPartner;l&&l.active?U.bossEntity=l:(U.bossEntity=null,U._twinBoss=null)}else U.bossEntity=null;else ge(e.x,e.y,e.color,15,180),$("elite"===e.tier?8:3),Z(.06,.5)}function Gl(){Ne.invuln>0||!Ne.alive||(Ne.hp--,Ne.invuln=.8,Ne.hitFlash=.3,$(10),ge(Ne.x,Ne.y,"#0ff",15,200),Ne.hp<=0&&(Ne.alive=0,ge(Ne.x,Ne.y,"#0ff",40,300),ge(Ne.x,Ne.y,"#fff",20,250),$(15),D.clear(),B=0,W=0,M=null,U.gameOverFade=0,O="dying"))}var Ql=[];function jl(){let e=[];for(let l of U.weapons){let t=al[l.id];if(t)for(let r of t.upgrades)l.lv[r.id]<r.maxLv&&e.push({type:"weaponUpg",weaponId:l.id,upgId:r.id,def:r,wdef:t,curLv:l.lv[r.id]})}if(U.weapons.filter(e=>"cc"===al[e.id].type).length<2){let l=U.weapons.map(e=>e.id);for(let t of ol)l.includes(t)||e.push({type:"newWeapon",weaponId:t,wdef:al[t]})}let l=0;for(let e=0;e<Dl.length;e++)(0|U.passives[Dl[e]])>0&&l++;for(let t of Dl){let r=U.passives[t]||0,a=Il[t];a&&(r>0&&r<a.maxLv?e.push({type:"passiveUpg",passiveId:t,def:a,curLv:r}):0===r&&l<3&&e.push({type:"newPassive",passiveId:t,def:a}))}for(let l=e.length-1;l>0;l--){let t=a(0,l);[e[l],e[t]]=[e[t],e[l]]}if((Ql=e.slice(0,5)).length<5)for(;Ql.length<5;){let e=1&Ql.length?"speed":"damage";Ql.push({type:"loopPassive",passiveId:e,def:Il[e]})}}function $l(e){let l=Ql[e];if(l){if("weaponUpg"===l.type){let e=U.weapons.find(e=>e.id===l.weaponId);e&&e.lv[l.upgId]++}else if("newWeapon"===l.type)U.weapons.push(rl(l.weaponId));else if("newPassive"===l.type)U.passives[l.passiveId]=1;else if("passiveUpg"===l.type)U.passives[l.passiveId]++;else if("loopPassive"===l.type){let e="speed"===l.passiveId?"_speedLoop":"_damageLoop";U.passives[e]=1+(0|U.passives[e])}z(),U.levelUpQueue--,U.levelUpQueue>0?(jl(),O="levelUp",U.refreshAvailable=1):O="playing"}}function Zl(){R.save(),R.fillStyle="#000",R.globalAlpha=.04;for(let e=0;e<k;e+=4)R.fillRect(0,e,S,1);R.restore()}var Jl=0;function et(e){e<0||e>=il.length||(U.weapons=[rl(il[e])],O="playing",zl())}function lt(e,l){U.gameOverFade=h(1,(U.gameOverFade||0)+2.8*e),l&&(ve(e),ue()),R.fillStyle="rgba(0,0,0,"+U.gameOverFade+")",R.fillRect(0,0,S,k),Zl(),U.gameOverFade>=1&&(O="gameover")}function tt(){I(),Ne.x=0,Ne.y=0,Ne.hp=10,Ne.maxHp=10,Ne.invuln=0,Ne.hitFlash=0,Ne.alive=1,Ne.angle=0,Ne.swordIFrame=0,z(),de.clear(),ce.clear(),ye.clear(),he.clear(),Ce.clear(),xe.length=0,E.x=0,E.y=0,U.time=0,U.difficulty=.8,U.wave=0,U.waveKills=0,U.waveQuota=0,U.waveState="clear",U.xp=0,U.level=1,U.xpToNext=m(128),U.levelUpQueue=0,U.totalKills=0,U.frozen=0,U.freezeTimer=0,U.killFlash=0,U.bannerTimer=0,U.waveBannerTimer=0,U.waveModTimer=0,U.waveModText="",U.gravity=0,U.windX=0,U.windY=0,U.pulseTimer=0,U.pulseSpeed=0,U.reversed=0,U.reverseTimer=0,U.reverseCD=0,U.pierce=0,U.echo=0,U.bounce=0,U.mirror=0,U.fragile=0,U.lucky=0,U.weapons=[],U.passives={},U.bossEntity=null,U._twinBoss=null,U._rocketRings=[],U._upgradeTransition=1,U.refreshAvailable=0,U._bossLaserHitCD=0,U._bossModQueue=[],U._bossSpawnPending=0,U.gameOverFade=0,_e.length=0,window._staticFields=[],we.length=0,be.length=0,Te.length=0,Ue=null,Xe=-1,Vl=1,Q=0,O="weaponSelect"}function rt(e){let l=sl(e);l&&"bow"===l.id&&(e=>{if(!e.charging)return;if(e.charging=0,e.shotCD>0)return void(e.chargeTime=0);let{chargeTime:l,maxCharge:t}=e,r=g(l/t,0,1),a=Ne.angle,i=10+18*r;for(let l=0;l<1;l++){let t=(l-0)*i;ke(e,r,a,t,1,1,1,"#ff0");let o=g(0|e.lv.a,0,2);for(let l=1;l<=o;l++){let i=.07*l;ke(e,r,a+i,t,.5,.7,.85,"#ffd84a"),ke(e,r,a-i,t,.5,.7,.85,"#ffd84a")}}e.chargeTime=0,e.shotCD=.22,$(2+4*r),Z(.04,.7+.3*r),ge(Ne.x+22*f(a),Ne.y+22*d(a),"#fff",8,140)})(l)}addEventListener("keydown",e=>{D.add(e.code),["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)&&e.preventDefault();let l=e.code;if("dying"!==O&&("Escape"===l&&("playing"===O?O="paused":"paused"===O&&(O="playing")),"Enter"===l&&"title"===O&&tt(),"KeyR"===l&&"gameover"===O&&tt(),"weaponSelect"===O&&("Digit1"===l&&et(0),"Digit2"===l&&et(1),"Digit3"===l&&et(2)),"levelUp"===O&&(U._upgradeTransition||0)>=.9&&("Digit1"===l&&$l(0),"Digit2"===l&&$l(1),"Digit3"===l&&$l(2),"Digit4"===l&&$l(3),"Digit5"===l&&$l(4),"KeyR"===l&&U.refreshAvailable>0&&(U.refreshAvailable--,jl())),"KeyR"===l&&"playing"===O)){let e=U.weapons.find(e=>"dagger"===e.id);e&&"idle"!==e.state&&(e.state="returning")}});var at=performance.now();requestAnimationFrame(function i(T){requestAnimationFrame(i);let w=g((T-at)/1e3,0,.05);if(at=T,"title"!==O){if("paused"===O)return R.save(),R.fillStyle="rgba(0,0,0,.5)",R.fillRect(0,0,S,k),R.restore(),ae("PAUSED",_,A-20,36,"#0ff",e,l),void ae("Press ESC to Resume",_,A+30,16,"#888",e,l);if("weaponSelect"!==O)if("dying"!==O){if("gameover"===O)return R.fillStyle="#000",R.fillRect(0,0,S,k),R.save(),R.fillStyle="rgba(0,0,0,.6)",R.fillRect(0,0,S,k),R.restore(),ae("GAME OVER",_,A-110,36,"#f44",e,l),ae("Waves Survived: "+x(0,U.wave-1),_,A-66,17,"#fff",e,l),ae("Enemies Killed: "+U.totalKills,_,A-44,14,"#9cf",e,l),ae("[R] Restart",_,A+30,12,"#888",e,l),void Zl();if("levelUp"===O){void 0===U._upgradeTransition&&(U._upgradeTransition=1),U._upgradeTransition=h(1,U._upgradeTransition+4*w);let t=U._upgradeTransition,r=t<1?1-Math.pow(1-t,3):1;if(R.fillStyle="rgba(0,0,0,"+.62*r+")",R.fillRect(0,0,S,k),M&&t>=.9){let e=h(5,Ql.length),l=_-(150*e+12*(e-1))/2,t=A-60;for(let r=0;r<e;r++){let e=l+162*r;if(M.x>=e&&M.x<=e+150&&M.y>=t&&M.y<=t+140){$l(r);break}}M=null}else M&&(M=null);return(t=>{t=t||1,R.save(),R.globalAlpha=t,ae("LEVEL UP",_,A-140,22,"#ff0",e,l),R.restore();let r=h(5,Ql.length),a=140,i=_-(150*r+12*(r-1))/2,o=A-60;function s(l,t,r,a,i){R.save(),R.font="bold 9px monospace";let o=(l||"").split(/\s+/).filter(Boolean),s=[],n="";for(let e=0;e<o.length;e++){let l=n?n+" "+o[e]:o[e];R.measureText(l).width>a&&n?(s.push(n),n=o[e]):n=l}n&&s.push(n);let f=s.slice(0,i);s.length>i&&f.length&&(f[f.length-1]=f[f.length-1].replace(/\.*$/,"")+"..."),R.textAlign=e,R.textBaseline="top",R.fillStyle="#9aa";for(let e=0;e<f.length;e++)R.fillText(f[e],t,r+11*e);R.restore()}for(let t=0;t<r;t++){let r=Ql[t],n=i+162*t,f=o,d=F>=n&&F<=n+150&&L>=f&&L<=f+a,c="#0ff",y="",h="";"weaponUpg"===r.type?(c=r.wdef.color,y=r.wdef.name+": "+r.def.name,h=r.def.desc[r.curLv]||""):"newWeapon"===r.type?(c=r.wdef.color,y="NEW "+r.wdef.name,h=r.wdef.cc?"CC: "+r.wdef.cc:r.wdef.desc):"newPassive"===r.type?(c=r.def.color,y="NEW "+r.def.name,h=r.def.desc[0]):"passiveUpg"===r.type?(c=r.def.color,y=r.def.name,h=r.def.desc[r.curLv]||""):"loopPassive"===r.type&&(c=r.def.color,y=r.def.name,h=r.def.desc[0]),se(n,f,150,a,"rgba(8,16,24,.9)",d?"#fff":c,d?2:1.2,d?1:.78),ae(y,n+75,f+24,10,d?"#fff":c,e,l),s(h,n+75,f+56,134,5),ae("["+(t+1)+"]",n+75,f+a-14,12,"#666",e,l)}ae(U.refreshAvailable>0?"[R] Reroll ("+U.refreshAvailable+")":"[R] No rerolls",_,o+a+20,13,U.refreshAvailable>0?"#4f4":"#666",e,l)})(r),void Zl()}if(M&&"playing"===O){let e=N();(function(e,l,t){let r=sl(e);r&&("dagger"===r.id?((e,l,t)=>{"idle"===e.state||"waiting"===e.state||"spinning"===e.state?(e.state="flying",e.tx=l,e.ty=t,"idle"===e.state&&(e.dx=Ne.x,e.dy=Ne.y)):"flying"===e.state?(e.tx=l,e.ty=t):"returning"===e.state&&(e.state="flying",e.tx=l,e.ty=t)})(r,l,t):"sword"===r.id?(e=>{let l=.4*(1-V.cdReduction);e.swingCD>0||e.lungeTimer>0||(e.swingCD=l,e.lungeDir=Ne.angle,e.lungeDist=[120,160,200,250][e.lv.a]*(1+[0,.15,.3][e.lv.c]),e.lungeStartX=Ne.x,e.lungeStartY=Ne.y,e.lungeTimer=.18,e.lungeProg=0,e._aftershockEnd=null,(()=>{let e=0;return he.each(l=>{l.isBoss&&(e=1)}),e})()&&((e,l)=>{if(Te.length>=36)return;let t=(160+32*(l.lv.a||0))*(1+[0,.15,.3][l.lv.c||0]),r=34+8*(l.lv.b||0),a=2*(8+2*(l.lv.a||0)+[0,2,4][l.lv.c||0]),i=Ne.x+26*f(e),o=Ne.y+26*d(e);Te.push({x:i,y:o,vx:820*f(e),vy:820*d(e),a:e,life:.55,maxLife:.55,len:t,width:r,dmg:a,hitSet:new Set}),ge(i,o,"#f6f",7,130)})(e.lungeDir,e),ge(Ne.x+15*f(e.lungeDir),Ne.y+15*d(e.lungeDir),"#f0f",6,100))})(r):"bow"===r.id&&(e=>{e.shotCD<=0&&(e.charging=1)})(r))})(M.btn,e.x,e.y),M=null}if(B||rt(0),W||rt(2),Q>0&&(Q-=w,w*=j),U.time+=w,U.killFlash=x(0,U.killFlash-w),U.levelUpQueue>0&&"playing"===O)return jl(),O="levelUp",U._upgradeTransition=0,void(U.refreshAvailable=1);if(E.x=v(E.x,Ne.x,8*w),E.y=v(E.y,Ne.y,8*w),R.fillStyle="rgba(0,0,0,0.18)",R.fillRect(0,0,S,k),G>.2?(K=(Math.random()-.5)*G*2,q=(Math.random()-.5)*G*2,G*=.87):K=q=G=0,R.save(),R.translate(-E.x+_+K,-E.y+A+q),(()=>{let e=E.x-_-100,l=E.y-A-100,t=E.x+_+100,r=E.y+A+100,a=100*m(e/100),i=100*m(l/100),o=50*m(e/50),s=50*m(l/50);R.save(),R.strokeStyle="#2a5f82",R.lineWidth=.9,R.globalAlpha=.62,R.beginPath();for(let e=a;e<=t;e+=100)R.moveTo(e,l),R.lineTo(e,r);for(let l=i;l<=r;l+=100)R.moveTo(e,l),R.lineTo(t,l);R.stroke(),R.strokeStyle="#18344a",R.lineWidth=.6,R.globalAlpha=.38,R.beginPath();for(let e=o;e<=t;e+=50)R.moveTo(e,l),R.lineTo(e,r);for(let l=s;l<=r;l+=50)R.moveTo(e,l),R.lineTo(t,l);R.stroke(),R.fillStyle="#58b7ff",R.globalAlpha=.22;for(let e=o;e<=t;e+=50)for(let l=s;l<=r;l+=50)R.fillRect(e-1.5,l-1.5,3,3);R.restore()})(),(()=>{let e=m((E.x-_)/Pe)-1,l=m((E.x+_)/Pe)+1,t=m((E.y-A)/Pe)-1,r=m((E.y+A)/Pe)+1;for(let a=e;a<=l;a++)for(let e=t;e<=r;e++){let l=Ee(a,e);for(let e=0;e<l.length;e++){let t=l[e];"pillar"===t.type?(R.save(),R.beginPath(),R.arc(t.x,t.y,t.r,0,n),R.fillStyle="#0a1520",R.globalAlpha=.6,R.fill(),R.restore(),J(t.x,t.y,t.r,"#1a4a6a",2)):(R.save(),R.fillStyle="#0a1520",R.globalAlpha=.6,R.fillRect(t.x,t.y,t.w,t.h),R.restore(),le([{x:t.x,y:t.y},{x:t.x+t.w,y:t.y},{x:t.x+t.w,y:t.y+t.h},{x:t.x,y:t.y+t.h}],"#1a4a6a",1,2))}}})(),(e=>{if(!Ne.alive)return;let l=U.weapons.find(e=>"sword"===e.id);if(l&&l.lungeTimer>0){Ne.invuln=x(0,Ne.invuln-e),Ne.hitFlash=x(0,Ne.hitFlash-5*e),Ne.swordIFrame=x(0,Ne.swordIFrame-e);let l=N(),t=l.x-Ne.x,r=l.y-Ne.y;return t*t+r*r>4&&(Ne.angle=p(r,t)),Fe(Ne),void(U.passives.regen&&(V.regenTimer-=e,V.regenTimer<=0&&(V.regenTimer=V.regenInterval,Ne.hp<Ne.maxHp&&Ne.hp++)))}let t=(()=>{let e=0,l=0;(H("KeyW")||H("ArrowUp"))&&(l=-1),(H("KeyS")||H("ArrowDown"))&&(l=1),(H("KeyA")||H("ArrowLeft"))&&(e=-1),(H("KeyD")||H("ArrowRight"))&&(e=1);let t=c(e*e+l*l);return t>0?{x:e/t,y:l/t}:{x:0,y:0}})(),r=t.x,a=t.y;U.reversed&&(r=-r,a=-a),Ne.x+=r*V.moveSpeed*1*e,Ne.y+=a*V.moveSpeed*1*e,(0!==r||0!==a)&&(Ne.x+=U.windX*e*.3,Ne.y+=U.windY*e*.3),Fe(Ne);let i=N(),o=i.x-Ne.x,s=i.y-Ne.y;o*o+s*s>4&&(Ne.angle=p(s,o)),Ne.invuln=x(0,Ne.invuln-e),Ne.hitFlash=x(0,Ne.hitFlash-5*e),Ne.swordIFrame=x(0,Ne.swordIFrame-e),V.regenTimer=(V.regenTimer||0)+e,V.regenTimer>=V.regenInterval&&Ne.hp<Ne.maxHp&&(V.regenTimer=0,Ne.hp=h(Ne.hp+1,Ne.maxHp))})(w),(e=>{for(let l of U.weapons)"dagger"===l.id?nl(l,e):"sword"===l.id?cl(l,e):"bow"===l.id?hl(l,e):"chain"===l.id?gl(l,e):"rocket"===l.id?wl(l,e):"mines"===l.id?kl(l,e):"shuriken"===l.id?Cl(l,e):"drone"===l.id&&Al(l,e)})(w),(e=>{U.frozen||he.each(l=>{let t=l.cc;if(t.bleedT>0&&(t.bleedT-=e,l.hp-=t.bleedDmg*e,l.hp<=0&&ql(l)),t.stunT>0)return t.stunT-=e,l.hitFlash=.2,void Fe(l);if(t.silenceT>0&&(t.silenceT-=e),t.rootT>0&&(t.rootT-=e),t.slowT>0?t.slowT-=e:t.slowAmt=0,t.fearT>0){t.fearT-=e;let r=p(l.y-Ne.y,l.x-Ne.x),a=1.5*(l.moveParams.speed||100);l.x+=f(r)*a*e,l.y+=d(r)*a*e}else if(t.disorientT>0)t.disorientT-=e,l.x+=200*(Math.random()-.5)*e,l.y+=200*(Math.random()-.5)*e;else if(t.kbVx||t.kbVy)l.x+=t.kbVx*e,l.y+=t.kbVy*e,t.kbVx*=.9,t.kbVy*=.9,y(t.kbVx)<5&&(t.kbVx=0),y(t.kbVy)<5&&(t.kbVy=0);else if(t.rootT<=0){let r=t.slowT>0?1-t.slowAmt:1,a=l.moveParams.speed;a&&(l.moveParams.speed=a*r),l.isBoss&&l.bossAI?l.bossAI.update(l,e):Ye[l.moveType]&&Ye[l.moveType](l,e),a&&(l.moveParams.speed=a)}if(t.markT>0?t.markT-=e:t.markAmp=0,t.silenceT<=0){let r=t.slowT>0?1-.5*t.slowAmt:1;l.fireTimer-=e*r,l.fireTimer<=0&&Ne.alive&&(l.fireTimer+=l.fireCD,l.isBoss&&l.bossAI?l.bossAI.fire(l):Ve[l.firePattern]&&Ve[l.firePattern](l))}l.angle+=e*("sentry"===l.moveType?1.5:.5),l.hitFlash=x(0,l.hitFlash-5*e),l._dashInvuln>0&&(l._dashInvuln=x(0,l._dashInvuln-e)),Fe(l),u(l.x,l.y,Ne.x,Ne.y)>1400&&!l.isBoss&&(l.active=0)})})(w),(e=>{U._bossLaserHitCD=x(0,(U._bossLaserHitCD||0)-e);for(let l=_e.length-1;l>=0;l--){let t=_e[l];if(!t.owner||!t.owner.active){_e.splice(l,1);continue}if(t.angle+=t.rotSpeed*e,t.x1=t.owner.x+t.offsetX,t.y1=t.owner.y+t.offsetY,t.warn>0){t.warn=x(0,t.warn-e);continue}if(t.life-=e,t.life<=0){_e.splice(l,1);continue}let r=t.x1+f(t.angle)*t.length,a=t.y1+d(t.angle)*t.length;Ne.alive&&Ne.invuln<=0&&U._bossLaserHitCD<=0&&b(Ne.x,Ne.y,t.x1,t.y1,r,a)<=.45*t.width+Ne.r&&(U._bossLaserHitCD=.12,Gl())}})(w),Je(de,w,0),Je(ce,w,1),ve(w),(e=>{for(let l=xe.length-1;l>=0;l--){let t=xe[l];t.y+=t.vy*e,t.vy+=100*e,t.life-=e,t.life<=0&&xe.splice(l,1)}})(w),(e=>{for(let l=be.length-1;l>=0;l--){let t=be[l];if(t.life-=e,t.life<=0){be.splice(l,1);continue}if(t.tickT-=e,t.tickT>0)continue;t.tickT=.06;let r=.5*(t.x1+t.x2),a=.5*(t.y1+t.y2),i=g(t.life/t.maxLife,0,1);he.each(e=>{e.active&&b(e.x,e.y,t.x1,t.y1,t.x2,t.y2)<=.45*t.width+e.r&&Kl(e,t.dmg*i*.6,"sword_aftershock")}),ge(r,a,"#f6f",2,80)}})(w),(e=>{for(let l=Te.length-1;l>=0;l--){let t=Te[l];if(t.life-=e,t.life<=0){Te.splice(l,1);continue}if(t.x+=t.vx*e,t.y+=t.vy*e,u(Ne.x,Ne.y,t.x,t.y)>1.35*x(S,k)){Te.splice(l,1);continue}let r=t.x-f(t.a)*t.len*.25,a=t.y-d(t.a)*t.len*.25,i=t.x+f(t.a)*t.len*.75,o=t.y+d(t.a)*t.len*.75;he.each(e=>{e.active&&e.isBoss&&!t.hitSet.has(e)&&b(e.x,e.y,r,a,i,o)<=e.r+.45*t.width&&(t.hitSet.add(e),Kl(e,t.dmg,"sword_boss_slash"),ge(e.x,e.y,"#f8f",9,170))})}})(w),(e=>{for(let l=we.length-1;l>=0;l--)we[l].life-=e,we[l].life<=0&&we.splice(l,1)})(w),Ne.alive&&(ce.each(e=>{e.active&&he.each(l=>{if(l.active){if(l.isBoss&&l.bossAI&&l.bossAI.shieldNodes&&l.bossAI.shieldNodes.some(e=>e.hp>0))for(let t of l.bossAI.shieldNodes){if(t.hp<=0)continue;let r=l.x+f(t.angle)*(l.r+24),a=l.y+d(t.angle)*(l.r+24);if(u(e.x,e.y,r,a)<e.r+10)return t.hp=x(0,t.hp-x(1,1.1*e.damage)),t.lastHit=U.time,ge(r,a,"#f99",6,120),void(e.active=0)}if(u(e.x,e.y,l.x,l.y)<e.r+l.r){if("rocket"===e.src)return e.active=0,void((e,l)=>{let t=U.weapons.find(e=>"rocket"===e.id);if(!t)return;let r=t.blastR+[0,30,50][t.lv.c],a=t.kbForce+[0,40,80,120][t.lv.a],i=[.5,.8,1.2,1.5][t.lv.a]||.5;if(ge(e,l,"#f80",25,250),ge(e,l,"#ff4",15,180),$(8),U._rocketRings||(U._rocketRings=[]),U._rocketRings.push({x:e,y:l,r:r,life:.3,maxLife:.3}),de.each(t=>{t.active&&u(e,l,t.x,t.y)<r&&(t.active=0,ge(t.x,t.y,"#f80",2,60))}),he.each(t=>{if(t.active&&u(e,l,t.x,t.y)<r+t.r){Kl(t,1,"rocket");let r=t.isBoss?.4:1,o=p(t.y-l,t.x-e);t.cc.kbVx=f(o)*a*r,t.cc.kbVy=d(o)*a*r,t.cc.disorientT=i*r}}),t.lv.b>0){let r=[0,5,7][t.lv.b];for(let t=0;t<r;t++){let a=n/r*t;ce.spawn(t=>{t.x=e+10*f(a),t.y=l+10*d(a),t.vx=220*f(a),t.vy=220*d(a),t.r=3,t.life=2,t.maxLife=2,t.type="normal",t.color="#fa0",t.spawnTime=U.time,t.damage=1,t.pierce=0,t.split=0,t.echoed=0,t.baseSpeed=220,t.curve=0,t.pulseAmp=0,t.src="rocket_mini",t._homing=1,t._homingDelay=.35})}}})(e.x,e.y);if("rocket_mini"===e.src)return e.active=0,ge(e.x,e.y,"#fa0",8,100),$(2),void he.each(l=>{if(l.active&&u(e.x,e.y,l.x,l.y)<40+l.r){Kl(l,1,"rocket");let t=p(l.y-e.y,l.x-e.x);l.cc.kbVx+=80*f(t),l.cc.kbVy+=80*d(t)}});Kl(l,e.damage,e.src||"bullet"),e.pierce>0?e.pierce--:U.pierce||(e.active=0)}}})}),Ne.invuln<=0&&(de.each(e=>{if(e.active&&u(e.x,e.y,Ne.x,Ne.y)<e.r+Ne.r){if(V.dodgeChance>0&&Math.random()<V.dodgeChance)return;e.active=0,Gl()}}),he.each(e=>{e.active&&u(e.x,e.y,Ne.x,Ne.y)<e.r+Ne.r&&Gl()}))),"dying"===O)return R.restore(),lt(w,0),void(M=null);if((e=>{if("spawning"===U.waveState){if((Vl-=e)<=0){let e=6+2.4*U.wave+1.2*U.difficulty;he.count()<e&&$e(Math.random()<.1+.02*U.wave?"elite":"small"),Vl=x(.16,1.65-.11*U.wave-.1*U.difficulty-U.wave*U.wave*.0015)}U.waveKills>=U.waveQuota&&(U.waveState="encounter",U._bossSpawnPending=1,U.killFlash=x(U.killFlash,.16),setTimeout(()=>{(()=>{let e=function(){let e=(U._bossModQueue&&0!==U._bossModQueue.length||(U._bossModQueue=(e=>{for(let l=e.length-1;l>0;l--){let t=a(0,l);[e[l],e[t]]=[e[t],e[l]]}return e})(Bl.slice())),U._bossModQueue.pop()),l=h(4,1+m(x(0,U.wave-1)/4)),t=1;for(;t<l;){let l=Ml.filter(l=>!(e&l));if(12&e&&(l=l.filter(e=>!(12&e))),!l.length)break;e|=o(l),t++}let i=((e,l)=>{let t=e.slice();for(let e=t.length-1;e>0;e--){let l=a(0,e);[t[e],t[l]]=[t[l],t[e]]}return t.slice(0,l)})(Wl,4&e?2:3),s=o(Ll),n=o(Fl),f=a(0,2),d=m(.5*(114+85*U.wave+U.wave*U.wave*22+a(-40,60))),c=a(34,48),y=r(.9,1.45)*x(.52,1-.02*U.wave),p=r(70,105)+1.3*U.wave,g=(e=>4&e?"Twin "+o(Nl)+" "+o(["Apex","Prime","Ascendant"]):o(Hl)+" "+o(Nl)+" "+o(Ol))(e);return{mods:e,attacks:i,shape:s,color:n,accessory:f,hp:d,r:c,fireCD:y,moveSpeed:p,name:g}}();he.each(e=>{e.active&&!e.isBoss&&(e.active=0)}),de.clear();let l=!!(4&e.mods),t=[];for(let r=0;r<(l?2:1);r++)he.spawn(l=>{Xl(l,e,r),l.bossAI=Yl(e),t.push(l)});2===t.length?(t[0]._twinPartner=t[1],t[1]._twinPartner=t[0],U._twinBoss=t):U._twinBoss=null,U.bossEntity=t[0],U.bannerTimer=2,U.bannerText="BOSS: "+e.name,U.bannerColor=e.color})(),U._bossSpawnPending=0},120))}else if("encounter"===U.waveState){if(U._bossSpawnPending)return;let e=1;he.each(l=>{l.isBoss&&(e=0)}),e&&(U.waveState="clear",de.clear(),ge(Ne.x,Ne.y,"#fff",30,250),$(10),Z(.3,.3),U.bannerTimer=2,U.bannerText="WAVE "+U.wave+" CLEAR!",U.bannerColor="#0ff",setTimeout(()=>zl(),2e3))}U.frozen&&(U.freezeTimer-=e,U.freezeTimer<=0&&(U.frozen=0)),Ue&&Ue.tick(e)})(w),(()=>{for(let e of _e){let l=g(e.life/e.maxLife,0,1),r=e.x1+f(e.angle)*e.length,a=e.y1+d(e.angle)*e.length;if(e.warn>0){let l=g(e.warn/x(1e-4,e.maxWarn),0,1),i=.45+.45*y(d(18*U.time));R.save(),R.lineCap=t,R.setLineDash([12,10]),R.beginPath(),R.moveTo(e.x1,e.y1),R.lineTo(r,a),R.strokeStyle=e.warnColor,R.lineWidth=x(2,.22*e.width),R.globalAlpha=(.2+.55*(1-l))*i,R.shadowColor=e.warnColor,R.shadowBlur=10,R.stroke(),R.setLineDash([]),R.restore();continue}Se(e.x1,e.y1,r,a,e.width,l,e.color,1)}})(),el(de),el(ce),he.each(e=>{let l=e.hitFlash>0?"#fff":e.color,t=e.cc;t.fearT>0&&(l="#ddd");let r=e.r+(e.hitFlash>0?2:0);if(e.isBoss)(e=>{let l=e.r,t=e.color||"#f6c";R.save(),R.translate(e.x,e.y),R.rotate(.6*e.angle);let r=e.bossShape||"circle";if("square"===r?le(re(0,0,l,0),t,1,4):"triangle"===r?le(te(0,0,l,0),t,1,4):J(0,0,l,t,4),R.beginPath(),R.arc(0,0,.24*l+1.2*d(5*U.time),0,n),R.fillStyle="#fff",R.globalAlpha=.7,R.fill(),e._dashInvuln>0&&(R.beginPath(),R.arc(0,0,l+7+1.8*d(16*U.time),0,n),R.strokeStyle="rgba(255,235,180,.55)",R.lineWidth=2,R.stroke()),R.restore(),e.bossAI&&e.bossAI.shieldNodes&&e.bossAI.shieldNodes.some(e=>e.hp>0))for(let l of e.bossAI.shieldNodes){if(l.hp<=0)continue;let r=e.x+f(l.angle)*(e.r+22),a=e.y+d(l.angle)*(e.r+22);J(r,a,8,t,2),ee(r,a,2.5,"#fff")}})(e);else{let t="elite"===e.tier?4:3;"circle"===e.shape?J(e.x,e.y,r,l,t):"square"===e.shape?le(re(e.x,e.y,r,e.angle),l,1,t):le(te(e.x,e.y,r,e.angle),l,1,t)}if(e._dashTele&&("dasher"===e.moveType||e.isBoss)&&(e=>{if(!e._dashTele)return;let l=e._dashTele,t=1-g(l.t/x(1e-4,l.maxT),0,1),r=p(l.ty-e.y,l.tx-e.x),a=e.x+f(r)*(e.r+12),i=e.y+d(r)*(e.r+12);R.save(),oe(e.x,e.y,e.r+8+2*d(18*U.time),"rgba(255,235,140,"+(.24+.42*t)+")",2.1),R.translate(a,i),R.rotate(r);let o=7+1.8*t;R.beginPath(),R.moveTo(o,0),R.lineTo(.55*-o,.55*-o),R.lineTo(.55*-o,.55*o),R.closePath(),R.fillStyle="rgba(255,245,180,"+(.35+.4*t)+")",R.fill(),R.restore()})(e),"elite"===e.tier&&e.hp<e.maxHp&&!e.isBoss){let l=2*e.r;R.fillStyle="#333",R.fillRect(e.x-l/2,e.y-e.r-8,l,3),R.fillStyle=e.color,R.fillRect(e.x-l/2,e.y-e.r-8,l*(e.hp/e.maxHp),3)}if(t.markT>0&&(R.beginPath(),R.arc(e.x,e.y-e.r-10,3,0,n),R.fillStyle="#ccc",R.fill()),(t.stunT>0||t.rootT>0||t.slowT>0||t.bleedT>0)&&(R.beginPath(),R.arc(e.x,e.y,e.r+3,0,n),R.strokeStyle="rgba(255,255,255,.4)",R.lineWidth=1.2,R.stroke()),t.silenceT>0){let l=e.r+5;R.beginPath(),R.moveTo(e.x-l,e.y-l),R.lineTo(e.x+l,e.y+l),R.moveTo(e.x+l,e.y-l),R.lineTo(e.x-l,e.y+l),R.strokeStyle="#0aa",R.lineWidth=2.2,R.globalAlpha=.85,R.stroke()}}),(()=>{if(!Ne.alive)return;if(Ne.invuln>0&&Ne.swordIFrame<=0&&(20*U.time|0)%2==0)return;let e=Ne.hitFlash>0?"#fff":"#0ff";if(le(te(Ne.x,Ne.y,Ne.r,Ne.angle+s/2),e,1,4),R.save(),R.beginPath(),R.arc(Ne.x,Ne.y,.4*Ne.r,0,n),R.fillStyle=e,R.globalAlpha=.15,R.fill(),R.restore(),Ne.swordIFrame>0){let e=g(Ne.swordIFrame/.25,0,1),l=Ne.r+8+2*d(18*U.time);R.save(),R.beginPath(),R.arc(Ne.x,Ne.y,l,0,n),R.strokeStyle="#f6f",R.lineWidth=2.2,R.globalAlpha=.2+.35*e,R.shadowColor="#f6f",R.shadowBlur=10,R.stroke(),R.beginPath(),R.arc(Ne.x,Ne.y,l-4,0,n),R.strokeStyle="#8ff",R.lineWidth=1.2,R.globalAlpha=.15+.25*e,R.shadowColor="#8ff",R.shadowBlur=6,R.stroke();for(let l=0;l<2;l++){let t=14*U.time+l*s,r=te(Ne.x-f(Ne.angle)*(8+5*l)+2*f(t),Ne.y-d(Ne.angle)*(8+5*l)+2*d(t),.65*Ne.r,Ne.angle+s/2);R.beginPath(),R.moveTo(r[0].x,r[0].y),R.lineTo(r[1].x,r[1].y),R.lineTo(r[2].x,r[2].y),R.closePath(),R.fillStyle="#f6f",R.globalAlpha=.08+.12*e,R.fill()}R.restore()}})(),(()=>{for(let e of U.weapons)"dagger"===e.id?dl(e):"sword"===e.id?yl(e):"bow"===e.id?xl(e):"chain"===e.id?Tl(e):"rocket"===e.id?Sl():"mines"===e.id?_l(e):"shuriken"===e.id?Rl(e):"drone"===e.id&&Pl(e)})(),(()=>{for(let e of be){let l=g(e.life/e.maxLife,0,1),r=e.width*(.55+.6*l),a=e.x2-e.x1,i=e.y2-e.y1,o=x(1,c(a*a+i*i)),s=-i/o,f=a/o,y=.5*(e.x1+e.x2),h=.5*(e.y1+e.y2);R.save();let p=R.createLinearGradient(e.x1,e.y1,e.x2,e.y2);p.addColorStop(0,"rgba(255,120,255,0)"),p.addColorStop(.45,"rgba(255,120,255,"+(.1+.22*l)+")"),p.addColorStop(1,"rgba(255,120,255,0)"),R.beginPath(),R.moveTo(e.x1,e.y1),R.quadraticCurveTo(y+s*r*.85,h+f*r*.85,e.x2,e.y2),R.quadraticCurveTo(y-s*r*.85,h-f*r*.85,e.x1,e.y1),R.closePath(),R.fillStyle=p,R.globalAlpha=1,R.shadowColor="#f0f",R.shadowBlur=20,R.fill();let m=R.createLinearGradient(e.x1,e.y1,e.x2,e.y2);m.addColorStop(0,"rgba(255,255,255,0)"),m.addColorStop(.5,"rgba(255,255,255,"+(.18+.2*l)+")"),m.addColorStop(1,"rgba(255,255,255,0)"),R.beginPath(),R.moveTo(e.x1,e.y1),R.lineTo(e.x2,e.y2),R.strokeStyle=m,R.lineWidth=x(1.8,.18*r),R.lineCap=t,R.shadowBlur=10,R.stroke();let u=5+(15*U.time+e.x1+e.y1|0)%4;for(let t=0;t<u;t++){let a=(t+.5)/u+.03*d(9*U.time+1.7*t),i=v(e.x1,e.x2,g(a,0,1)),o=v(e.y1,e.y2,g(a,0,1)),c=.22*d(14*U.time+2.2*t)*r,y=i+s*c,h=o+f*c;R.beginPath(),R.arc(y,h,1.2+2.2*l,0,n),R.fillStyle="#f8f",R.globalAlpha=.12+.22*l,R.fill(),R.beginPath(),R.arc(y+1.5*s,h+1.5*f,.9+1.4*l,0,n),R.fillStyle="#fff",R.globalAlpha=.08+.18*l,R.fill()}R.restore()}})(),(()=>{for(let e of Te){let l=g(e.life/e.maxLife,0,1),t=f(e.a+s/2),r=d(e.a+s/2),a=e.x-f(e.a)*e.len*.25,i=e.y-d(e.a)*e.len*.25,o=e.x+f(e.a)*e.len*.75,n=e.y+d(e.a)*e.len*.75,c=e.width*(.8+.35*l),y=.5*(a+o),h=.5*(i+n);R.save();let x=R.createLinearGradient(a,i,o,n);x.addColorStop(0,"rgba(255,120,255,0)"),x.addColorStop(.45,"rgba(255,120,255,"+(.2+.22*l)+")"),x.addColorStop(1,"rgba(255,255,255,"+(.1+.22*l)+")"),R.beginPath(),R.moveTo(a,i),R.quadraticCurveTo(y+t*c*.75,h+r*c*.75,o,n),R.quadraticCurveTo(y-t*c*.75,h-r*c*.75,a,i),R.closePath(),R.fillStyle=x,R.globalAlpha=.95,R.shadowColor="#f6f",R.shadowBlur=14,R.fill(),R.restore()}})(),(()=>{for(let e of we){let l=g(e.life/e.maxLife,0,1),t=.9+.1*d(40*U.time+e.phase);Se(e.x1,e.y1,e.x2,e.y2,e.width*t,l,e.color,0),R.save();for(let t=0;t<5;t++){let r=(t+.5)/5+.015*d(10*U.time+t+e.phase),a=v(e.x1,e.x2,g(r,0,1)),i=v(e.y1,e.y2,g(r,0,1));R.beginPath(),R.arc(a,i,2+3*l,0,n),R.fillStyle="#fff",R.globalAlpha=.1+.25*l,R.fill()}R.restore()}})(),(()=>{for(let e of window._staticFields){let l=g(e.life/e.maxLife,0,1);R.save(),R.globalAlpha=.8*l,R.beginPath(),R.arc(e.x,e.y,e.size*l,0,n),R.fillStyle="#c6f",R.fill(),R.beginPath(),R.arc(e.x,e.y,e.size*l*2,0,n),R.fillStyle="#a0f",R.globalAlpha=.15*l,R.fill(),R.restore()}})(),ue(),(()=>{for(let t of xe){let r=t.life/t.maxLife;R.save(),R.globalAlpha=r,R.font="bold "+12*t.scale+"px monospace",R.textAlign=e,R.textBaseline=l,R.fillStyle=t.color,R.shadowColor=t.color,R.shadowBlur=6,R.fillText(t.text,t.x,t.y),R.restore()}})(),U._twinBoss){let e=U._twinBoss;if(e[0]&&e[0].active&&e[1]&&e[1].active&&e[0].bossAI.linkBeam){R.save();let l=g(.4+.2*d(5*U.time),0,1);R.beginPath(),R.moveTo(e[0].x,e[0].y),R.lineTo(e[1].x,e[1].y),R.strokeStyle="#f4a",R.lineWidth=6,R.globalAlpha=.3*l,R.shadowColor="#f4a",R.shadowBlur=15,R.stroke(),R.beginPath(),R.moveTo(e[0].x,e[0].y),R.lineTo(e[1].x,e[1].y),R.strokeStyle="#fff",R.lineWidth=2,R.globalAlpha=.5*l,R.shadowBlur=8,R.stroke();let t=e[1].x-e[0].x,r=e[1].y-e[0].y,a=c(t*t+r*r);if(a>0){let l=-r/a,i=t/a,o=Ne.x-e[0].x,s=Ne.y-e[0].y,n=o*t/a+s*r/a,f=y(o*l+s*i);n>0&&n<a&&f<20&&Gl()}R.restore()}else e[0]&&!e[0].active&&e[1]&&e[1].active&&(U.bossEntity=e[1])}if(he.each(e=>{if(e.active&&e.isBoss&&e.bossAI&&e.bossAI._portals)for(let l of e.bossAI._portals){let e=g(l.life/.25,0,1);Ze(l.x1,l.y1,e,0),Ze(l.x2,l.y2,e,1.1)}}),he.each(e=>{if(!(e.active&&e.isBoss&&e.bossAI&&e.bossAI._warpTele))return;let l=e.bossAI._warpTele,t=1-g(l.t/x(1e-4,l.maxT),0,1);Ze(l.toX,l.toY,.35+.65*t,1.6),Ze(e.x,e.y,.25+.45*t,.35)}),U._rocketRings)for(let e=U._rocketRings.length-1;e>=0;e--){let l=U._rocketRings[e];if(l.life-=w,l.life<=0){U._rocketRings.splice(e,1);continue}let t=1-l.life/l.maxLife;R.save(),R.beginPath(),R.arc(l.x,l.y,l.r*t,0,n),R.strokeStyle="#f80",R.lineWidth=3*(1-t),R.globalAlpha=.6*(1-t),R.shadowColor="#f80",R.shadowBlur=10,R.stroke(),R.beginPath(),R.arc(l.x,l.y,l.r*t*.6,0,n),R.strokeStyle="#ff4",R.lineWidth=2*(1-t),R.globalAlpha=.4*(1-t),R.stroke(),R.restore()}R.restore(),U.killFlash>0&&(R.save(),R.fillStyle="#fff",R.globalAlpha=3*U.killFlash,R.fillRect(0,0,S,k),R.restore()),U.frozen&&(R.save(),R.fillStyle="rgba(50,100,200,0.08)",R.fillRect(0,0,S,k),R.restore()),(()=>{let e=R.createRadialGradient(_,A,.3*h(S,k),_,A,.7*h(S,k));e.addColorStop(0,"rgba(0,0,0,0)");let l=Ne.hp<=1&&Ne.alive;e.addColorStop(1,l?"rgba(80,0,0,0.5)":"rgba(0,0,0,0.35)"),R.save(),R.fillStyle=e,R.fillRect(0,0,S,k),R.restore()})(),(()=>{let t=h(S-16,560),r=_-t/2,a=g(Ne.hp/x(1,Ne.maxHp),0,1),i=g(U.xp/U.xpToNext,0,1),o=a>.5?"#0ef":a>.25?"#fd4":"#f55";se(r,10,t,54,"rgba(0,0,0,.55)","rgba(255,255,255,.15)",1);let s=r+42,n=t-54,f=(n-18)/10;for(let e=0;e<10;e++){let l=s+e*(f+2),t=g(10*a-e,0,1);R.fillStyle="rgba(18,18,18,.95)",R.fillRect(l,19,f,12),t>0&&(R.fillStyle=o,R.fillRect(l,19,f*t,12)),R.strokeStyle="rgba(255,255,255,.24)",R.strokeRect(l,19,f,12)}R.fillStyle="rgba(18,18,18,.95)",R.fillRect(s,37,n,9),R.fillStyle="#fd4",R.fillRect(s,37,n*i,9),R.strokeStyle="rgba(255,223,74,.3)",R.strokeRect(s,37,n,9),ae("HP",r+12,19,10,"#dff"),ae("XP",r+12,36,10,"#fd4");let d=U.time%60|0;ae("TIME "+(U.time/60|0)+":"+(d<10?"0":"")+d,r+12,51,9,"#8ea"),Ue&&ae(Ue.name,r+t-12,51,9,Ue.color,"right");let c=h(S-80,460),y=_-c/2;if(U.bossEntity&&U.bossEntity.active){let l=U.bossEntity,t=l.hp/l.maxHp;ae(l.bossName||"BOSS",_,88,11,l.color,e,"top"),se(y,72,c,12,"#222","rgba(255,80,80,.6)",1),R.fillStyle="#c33",R.fillRect(y,72,c*t,12)}else if("spawning"===U.waveState){let l=g(U.waveKills/U.waveQuota,0,1);se(y,72,c,7,"rgba(20,20,20,.92)","rgba(0,255,255,.32)",1),R.fillStyle="#0ff",R.fillRect(y,72,c*l,7),ae("WAVE PROGRESS",_,82,8,"#9cd",e,"top")}let p={chain:.8,rocket:2.2,mines:2.1,shuriken:1.2,drone:1.5},m=_-52*x(1,U.weapons.length)/2+26;for(let t=0;t<U.weapons.length;t++){let r=U.weapons[t],a=al[r.id],i=m+52*t,o=k-46;se(i-18,o-12,36,24,"rgba(0,0,0,.5)",a.color,1),ae(a.name.charAt(0),i,o-1,12,a.color,e,l);let s=p[r.id];if(s&&void 0!==r.timer){let e=g(1-r.timer/s,0,1);R.fillStyle="rgba(0,0,0,.55)",R.fillRect(i-18,o+14,36,3),R.fillStyle=a.color,R.fillRect(i-18,o+14,36*e,3)}}if(U.bannerTimer>0&&(U.bannerTimer-=.016666666666666666,R.save(),R.globalAlpha=h(1,2*U.bannerTimer),ae(U.bannerText,_,A-60,24,U.bannerColor,e,l),R.restore()),U.waveBannerTimer>0){U.waveBannerTimer-=.016666666666666666;let t=h(1,U.waveBannerTimer);R.save(),R.globalAlpha=t;let r=30+20*(1-t);ae(U.waveBannerText,_,A-30,r,"#fff",e,l),U.waveBannerSub&&ae(U.waveBannerSub,_,A+10,16,Ue?Ue.color:"#888",e,l),R.restore()}if(U.waveModTimer>0&&U.waveModText){U.waveModTimer-=.016666666666666666;let l=g(U.waveModTimer/3,0,1),t=h(S-40,720),r=50,a=_-t/2,i=k-136;se(a,i,t,r,"#000",Ue?Ue.color:"#aaa",1.4,.24*l),se(a,i,t,r,null,Ue?Ue.color:"#aaa",1.4,.4*l),ae("MODIFIER: "+U.waveModText,_,i+16,16,Ue?Ue.color:"#9ab",e,"top")}})(),Zl(),M=null}else lt(w,1);else{if(M){let e=il.length,l=_-(180*e+20*(e-1))/2,t=A-70;for(let r=0;r<e;r++){let e=l+200*r;if(M.x>=e&&M.x<=e+180&&M.y>=t&&M.y<=t+200){et(r);break}}M=null}(t=>{He(t,.35),ae("CHOOSE YOUR WEAPON",_,60,24,"#0ff",e,l);let r=il.length,a=_-(180*r+20*(r-1))/2,i=A-70;function o(e,l,t,r,a){let i=a?1.1:1;R.save(),R.translate(l,t),R.scale(i,i),R.globalAlpha=.92,"dagger"===e?le([{x:0,y:-14},{x:8,y:8},{x:0,y:4},{x:-8,y:8}],r,1,4):"sword"===e?(le([{x:-3,y:12},{x:3,y:12},{x:2,y:-12},{x:0,y:-18},{x:-2,y:-12}],r,1,4),R.beginPath(),R.moveTo(-7,10),R.lineTo(7,10),R.strokeStyle=r,R.lineWidth=2,R.stroke()):"bow"===e&&(ie(-2,0,12,.55*-s,.55*s,r,2),R.beginPath(),R.moveTo(-10,0),R.lineTo(10,0),R.strokeStyle=r,R.lineWidth=1.8,R.stroke(),le([{x:12,y:0},{x:4,y:-4},{x:4,y:4}],r,1,3)),R.restore()}function n(l,t,r,a,i){R.save(),R.font="bold 9px monospace";let o=(l||"").split(/\s+/).filter(Boolean),s=[],n="";for(let e=0;e<o.length;e++){let l=n?n+" "+o[e]:o[e];R.measureText(l).width>a&&n?(s.push(n),n=o[e]):n=l}n&&s.push(n);let f=s.slice(0,i);s.length>i&&f.length&&(f[f.length-1]=f[f.length-1].replace(/\.*$/,"")+"..."),R.textAlign=e,R.textBaseline="top",R.fillStyle="#9aa";for(let e=0;e<f.length;e++)R.fillText(f[e],t,r+12*e);R.restore()}for(let t=0;t<r;t++){let r=il[t],s=al[r],f=a+200*t,d=i,c=F>=f&&F<=f+180&&L>=d&&L<=d+200,y=c?"#fff":s.color;se(f,d,180,200,"rgba(8,16,24,0.9)",y,c?2:1.2,c?1:.75),ae(s.name,f+90,d+22,13,y,e,l),o(r,f+90,d+54,y,c),ae("starter"===s.type?"PRIMARY":"CC",f+90,d+84,10,s.color,e,l),n(s.desc,f+90,d+102,158,4),ae("["+(t+1)+"]",f+90,d+200-20,14,"#555",e,l)}Zl()})(w)}}else(t=>{Jl+=t,He(t,.28),R.save(),R.globalAlpha=.7+.3*d(3*Jl),ae("NEON PHASES",_,A-80,42,"#0ff",e,l),R.restore(),(2*Jl|0)%2&&ae("Press ENTER to Start",_,A+12,16,"#fff",e,l),Zl()})(w)})})();</script></body></html>